"use strict";(self.webpackChunkbiodare2_ui=self.webpackChunkbiodare2_ui||[]).push([[108],{2108:(ot,D,d)=>{d.r(D),d.d(D,{TsOldImportModule:()=>_});var u=d(6895),r=d(4006),y=d(2929),I=d(6397),x=d(9299),A=d(471),v=d(1945),t=d(4650),k=d(5716);class h{constructor(o){this.BD2REST=o}getSimpleTableView(o){return this.BD2REST.fileViewSimpleTable(o).then(e=>e.data)}verifyFormat(o,e){return this.BD2REST.fileViewVerifyFormat(o,e).toPromise()}}h.\u0275fac=function(o){return new(o||h)(t.LFG(k.q))},h.\u0275prov=t.Yz7({token:h,factory:h.\u0275fac,providedIn:"root"});var O=d(2110),l=d(4200);class f{constructor(o,e,i,n,a){this.rows=o,this.th=e,this.rowsLabels=i,this.specialRows=n,this.specialRowsLabels=a,this.width=f.maxLength(o),this.th=e||(o.length<1?[]:f.labelCols(this.width)),this.rowsLabels=i||f.labelRows(o.length),this.specialRows=n||[],this.specialRowsLabels=a||f.blankRows(this.specialRows.length)}static labelRows(o){const e=[];for(let i=1;i<=o;i++)e.push(""+i);return e}static blankRows(o){const e=[];for(let i=0;i<o;i++)e.push("");return e}static maxLength(o){return!o||o.length<1?0:Math.max.apply(Math,o.map(e=>e.length))}static labelCols(o){const e=[];for(let i=1;i<=o;i++)e.push((0,l.jO)(i));return e}}class p{static color(o){return p.colors[o%p.colors.length]}}p.TIME_BG="lightyellow",p.IGNORED_BG="lightgrey",p.NOISE_BG="darkgrey",p.colors=["lightgreen","lightblue","lightcoral","lightcyan","lightgreen","lightpink","lightsalmon","lightseagreen","lightskyblue","palegoldenrod","paleturquoise","palevioletred"];var m=d(5412);const R=["columnTypeForm"];function U(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"li")(1,"input",14,15),t.NdJ("ngModelChange",function(n){t.CHM(e);const a=t.oxw();return t.KtG(a.cellRole=n)}),t.qZA(),t._uU(3),t.qZA()}if(2&s){const e=o.$implicit,i=t.oxw();t.xp6(1),t.s9C("value",e.name),t.Q6J("ngModel",i.cellRole),t.xp6(2),t.hij(" ",e.label," ")}}function N(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"div",5)(1,"label",16),t._uU(2,"Propagate until block size"),t.qZA(),t.TgZ(3,"input",17,18),t.NdJ("ngModelChange",function(n){t.CHM(e);const a=t.oxw();return t.KtG(a.rangeSize=n)}),t.qZA()()}if(2&s){const e=t.oxw();t.xp6(3),t.Q6J("ngModel",e.rangeSize)}}function B(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"div",5)(1,"label",19),t._uU(2,"Label"),t.qZA(),t.TgZ(3,"input",20,21),t.NdJ("ngModelChange",function(n){t.CHM(e);const a=t.oxw();return t.KtG(a.dataLabel=n)}),t.qZA()()}if(2&s){const e=t.oxw();t.xp6(3),t.Q6J("ngModel",e.dataLabel)}}function q(s,o){if(1&s&&(t.TgZ(0,"option",32),t._uU(1),t.qZA()),2&s){const e=o.$implicit;t.s9C("value",e.name),t.xp6(1),t.hij("",e.label," ")}}function E(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"div",5)(1,"label",33),t._uU(2,"Time between images (hours)"),t.qZA(),t.TgZ(3,"input",34,35),t.NdJ("ngModelChange",function(n){t.CHM(e);const a=t.oxw(2);return t.KtG(a.imgInterval=n)}),t.qZA()()}if(2&s){const e=t.oxw(2);t.xp6(3),t.Q6J("ngModel",e.imgInterval)}}function F(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"div")(1,"div",5)(2,"label",22),t._uU(3,"Type of time column"),t.qZA(),t.TgZ(4,"select",23,24),t.NdJ("ngModelChange",function(n){t.CHM(e);const a=t.oxw();return t.KtG(a.timeType=n)}),t.YNc(6,q,2,2,"option",25),t.qZA()(),t.TgZ(7,"div",5)(8,"label",26),t._uU(9,"Row with first timepoint"),t.qZA(),t.TgZ(10,"input",27,28),t.NdJ("ngModelChange",function(n){t.CHM(e);const a=t.oxw();return t.KtG(a.firstRow=n)}),t.qZA()(),t.TgZ(12,"div",5)(13,"label",29),t._uU(14,"Time offset (hours)"),t.qZA(),t.TgZ(15,"input",30,31),t.NdJ("ngModelChange",function(n){t.CHM(e);const a=t.oxw();return t.KtG(a.timeOffset=n)}),t.qZA()(),t.YNc(17,E,5,1,"div",8),t.qZA()}if(2&s){const e=t.oxw();t.xp6(4),t.Q6J("ngModel",e.timeType),t.xp6(2),t.Q6J("ngForOf",e.timeTypeOptions),t.xp6(4),t.Q6J("ngModel",e.firstRow),t.xp6(5),t.Q6J("ngModel",e.timeOffset),t.xp6(2),t.Q6J("ngIf",e.isImageBased())}}function J(s,o){if(1&s&&(t.TgZ(0,"div",37),t._uU(1),t.qZA()),2&s){const e=o.$implicit;t.xp6(1),t.Oqu(e)}}function H(s,o){if(1&s&&(t.TgZ(0,"div"),t.YNc(1,J,2,1,"div",36),t.qZA()),2&s){const e=t.oxw();t.xp6(1),t.Q6J("ngForOf",e.errors)}}class S{constructor(o,e,i,n){this.selectedRange=o,this.lastCol=e,this.showTime=i,this.label=n}}class T{constructor(o,e){this.myself=o,this.errors=null,this.cellRoles=[l.H3.IGNORED,l.H3.BACKGROUND,l.H3.TIME,l.H3.DATA],this.timeTypeOptions=[l.ET.TIME_IN_HOURS,l.ET.TIME_IN_MINUTES,l.ET.TIME_IN_SECONDS,l.ET.IMG_NUMBER],this.lastCol=e.lastCol,this.showTime=e.showTime,this.show(e.selectedRange,e.label)}ngOnInit(){}set showTime(o){this.cellRoles=o?[l.H3.IGNORED,l.H3.BACKGROUND,l.H3.TIME,l.H3.DATA]:[l.H3.IGNORED,l.H3.BACKGROUND,l.H3.DATA]}isData(){return this.cellRole===l.H3.DATA.name}isTime(){return this.cellRole===l.H3.TIME.name}isImageBased(){return this.isTime()&&this.timeType===l.ET.IMG_NUMBER.name}show(o,e){o&&(this.orgRange=o,this.rangeSize=o.range.size(),this.rangeLabel=e||o.columnRangeLabel,o.role&&(this.cellRole=o.role.name),o.role==l.H3.DATA&&o.details&&(this.dataLabel=o.details.dataLabel),o.role==l.H3.TIME&&o.details&&(this.timeType=o.details.timeType.name,this.timeOffset=o.details.timeOffset,this.imgInterval=o.details.imgInterval,this.firstRow=o.details.firstRow))}hide(){this.myself.close()}accepted(){this.isValid()&&this.myself.close(this.emitDescription())}acceptedAndNext(){if(!this.isValid())return;const o=this.emitDescription();if(!(o.range.lastCol>=this.lastCol)){const e=this.nextRange(o.range,this.rangeSize),i=new l.Wr(e);i.role=l.H3.DATA,i.details=o.details,o.follow=i}this.myself.close(o)}nextRange(o,e){const i=o.lastCol+1;let n=i+e-1;return n=Math.min(n,this.lastCol),new l.lu(new l.xn(i,o.first.row),new l.xn(n,o.first.row))}emitDescription(){const o=this.recalculateRange(this.orgRange.range);let e={};if(this.isData())e=new l.T(this.dataLabel);else if(this.isTime()){const n=new l.bq;n.firstRow=this.firstRow,n.timeType=l.ET.get(this.timeType),n.timeOffset=this.timeOffset,this.isImageBased()&&(n.imgInterval=this.imgInterval),e=n}const i=new l.Wr(o,this.orgRange.content);return i.role=l.H3.get(this.cellRole),i.details=e,i}isValid(){const o=[];return l.H3.get(this.cellRole)||o.push("Unknown role: "+this.cellRole),this.isData()&&(!this.dataLabel||""===this.dataLabel.trim())&&(o.push("Non empty data label is required"),this.dataLabel=null),this.isTime()?((!this.firstRow||this.firstRow<1)&&o.push("Row nr of the first time point must be >= 1"),this.isImageBased()&&(!this.imgInterval||this.imgInterval<=0)&&o.push("Image interval must be > 0")):(!this.rangeSize||this.rangeSize<1)&&o.push("Block size must be >= 1"),0===o.length&&(this.errors=null,!0)}recalculateRange(o){let e=o.first;if(this.isTime())return e=new l.xn(e.col,this.firstRow),new l.lu(e,e);if(this.rangeSize!==o.size()){const n=new l.xn(Math.min(e.col+this.rangeSize-1,this.lastCol),e.row);return new l.lu(e,n)}return o}}T.\u0275fac=function(o){return new(o||T)(t.Y36(m.so),t.Y36(m.WI))},T.\u0275cmp=t.Xpm({type:T,selectors:[["ng-component"]],viewQuery:function(o,e){if(1&o&&t.Gf(R,7),2&o){let i;t.iGM(i=t.CRH())&&(e.columnTypeForm=i.first)}},decls:28,vars:8,consts:[["mat-dialog-title","",1,"modal-title"],["mat-dialog-close","","aria-label","Close","type","button",1,"close","float-right"],["aria-hidden","true"],["mat-dialog-content","",1,"modal-body"],["columnTypeForm","ngForm"],[1,"form-group"],[1,"list-unstyled"],[4,"ngFor","ngForOf"],["class","form-group",4,"ngIf"],[4,"ngIf"],["mat-dialog-actions",""],[1,"btn","btn-primary","btn-sm","mr-1",3,"disabled","click"],[1,"btn","btn-primary","btn-sm","m-1",3,"disabled","click"],["mat-dialog-close","",1,"btn","btn-outline-secondary","btn-sm",3,"click"],["type","radio","required","","name","fCellRole",3,"value","ngModel","ngModelChange"],["fCellRole","ngModel"],["for","size"],["type","number","step","1","min","1","id","size","required","","name","fSize",1,"form-control",3,"ngModel","ngModelChange"],["fSize","ngModel"],["for","dataLabel"],["type","text","id","dataLabel","placeholder","e.g. TOC1 SD","required","","minlength","2","name","fDataLabel",1,"form-control",3,"ngModel","ngModelChange"],["fDataLabel","ngModel"],["for","timeType"],["id","timeType","required","","name","fTimeType",1,"form-control",3,"ngModel","ngModelChange"],["fTimeType","ngModel"],[3,"value",4,"ngFor","ngForOf"],["for","firstRow"],["type","number","id","firstRow","step","1","min","1","required","","placeholder","e.g. 2","name","fFirstRow",1,"form-control",3,"ngModel","ngModelChange"],["fFirstRow","ngModel"],["for","timeOffset"],["type","number","id","timeOffset","step","any","placeholder","e.g. -4","name","fTimeOffset",1,"form-control",3,"ngModel","ngModelChange"],["fTimeOffset","ngModel"],[3,"value"],["for","imgInterval"],["type","number","id","imgInterval","required","","step","any","min","0.01","placeholder","e.g. 1.5","name","fImgInterval",1,"form-control",3,"ngModel","ngModelChange"],["fImgInterval","ngModel"],["dismissOnTimeout","3000","dismissible","true","class","alert alert-danger","role","alert",4,"ngFor","ngForOf"],["dismissOnTimeout","3000","dismissible","true","role","alert",1,"alert","alert-danger"]],template:function(o,e){if(1&o&&(t.TgZ(0,"h4",0),t._uU(1,"Describe data column(s) "),t.TgZ(2,"button",1)(3,"span",2),t._uU(4,"\xd7"),t.qZA()()(),t.TgZ(5,"div",3)(6,"p"),t._uU(7," Columns "),t.TgZ(8,"strong"),t._uU(9),t.qZA()(),t.TgZ(10,"form",null,4)(12,"div",5)(13,"label"),t._uU(14,"Column type"),t.qZA(),t.TgZ(15,"ul",6),t.YNc(16,U,4,3,"li",7),t.qZA()(),t.YNc(17,N,5,1,"div",8),t.YNc(18,B,5,1,"div",8),t.YNc(19,F,18,5,"div",9),t.YNc(20,H,2,1,"div",9),t.qZA()(),t.TgZ(21,"div",10)(22,"button",11),t.NdJ("click",function(){return e.acceptedAndNext()}),t._uU(23,"OK and Next "),t.qZA(),t.TgZ(24,"button",12),t.NdJ("click",function(){return e.accepted()}),t._uU(25,"OK "),t.qZA(),t.TgZ(26,"button",13),t.NdJ("click",function(){return e.hide()}),t._uU(27,"Cancel"),t.qZA()()),2&o){const i=t.MAs(11);t.xp6(9),t.hij("[",e.rangeLabel,"]"),t.xp6(7),t.Q6J("ngForOf",e.cellRoles),t.xp6(1),t.Q6J("ngIf",!e.isTime()),t.xp6(1),t.Q6J("ngIf",e.isData()),t.xp6(1),t.Q6J("ngIf",e.isTime()),t.xp6(1),t.Q6J("ngIf",e.errors),t.xp6(2),t.Q6J("disabled",!i.form.valid),t.xp6(2),t.Q6J("disabled",!i.form.valid)}},dependencies:[u.sg,u.O5,r._Y,r.YN,r.Kr,r.Fj,r.wV,r.EJ,r._,r.JJ,r.JL,r.Q7,r.wO,r.qQ,r.On,r.F,m.ZT,m.uh,m.xY,m.H8],encapsulation:2});class b{constructor(o){this.show(o)}ngOnInit(){}show(o){this.orgRange=o,this.rowNr=o.range.first.row,this.values=o.content}}b.\u0275fac=function(o){return new(o||b)(t.Y36(m.WI))},b.\u0275cmp=t.Xpm({type:b,selectors:[["ng-component"]],decls:24,vars:3,consts:[["mat-dialog-title","",1,"modal-title"],["mat-dialog-close","","aria-label","Close","type","button",1,"close","float-right"],["aria-hidden","true"],["mat-dialog-content","",1,"modal-body"],[1,"word_wrapping"],["mat-dialog-actions",""],[1,"btn","btn-primary","btn-sm","mr-1",3,"mat-dialog-close"],["mat-dialog-close","",1,"btn","btn-outline-secondary","btn-sm"]],template:function(o,e){1&o&&(t.TgZ(0,"h4",0),t._uU(1,"Use row content as data labels(s) "),t.TgZ(2,"button",1)(3,"span",2),t._uU(4,"\xd7"),t.qZA()()(),t.TgZ(5,"div",3)(6,"div")(7,"p"),t._uU(8,"Use values from row "),t.TgZ(9,"strong"),t._uU(10),t.qZA(),t._uU(11," as data labels"),t.qZA(),t.TgZ(12,"p"),t._uU(13,"Existing labels and column types will be overwritten"),t.qZA()(),t.TgZ(14,"div",4)(15,"p")(16,"strong"),t._uU(17,"Labels: "),t.qZA(),t._uU(18),t.qZA()()(),t.TgZ(19,"div",5)(20,"button",6),t._uU(21,"Copy labels"),t.qZA(),t.TgZ(22,"button",7),t._uU(23,"Cancel"),t.qZA()()),2&o&&(t.xp6(10),t.hij("[",e.rowNr,"]"),t.xp6(8),t.Oqu(e.values),t.xp6(2),t.Q6J("mat-dialog-close",e.orgRange))},dependencies:[m.ZT,m.uh,m.xY,m.H8],encapsulation:2});var L=d(7032);function G(s,o){1&s&&(t.TgZ(0,"div",9)(1,"strong"),t._uU(2,"Missing data labels. Please use one of the methods:"),t.qZA(),t.TgZ(3,"ul")(4,"li"),t._uU(5,"Click and draw over the headers of columns to select the range and assign the data labels in the popup dialog. "),t.qZA(),t.TgZ(6,"li"),t._uU(7,"Use the form below to manually provide the column range and the data label."),t.qZA()()())}function Q(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"div")(1,"div",10)(2,"label",11),t._uU(3,"Time parameter: offset (hours)"),t.qZA(),t.TgZ(4,"input",12,13),t.NdJ("ngModelChange",function(n){t.CHM(e);const a=t.oxw(2);return t.KtG(a.timeColumnDescription.details.timeOffset=n)}),t.qZA()()()}if(2&s){const e=t.oxw(2);t.xp6(4),t.Q6J("ngModel",e.timeColumnDescription.details.timeOffset)}}function Y(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"li",17),t.NdJ("click",function(){const a=t.CHM(e).$implicit,c=t.oxw(3);return t.KtG(c.editBlock(a))}),t.TgZ(1,"span")(2,"strong"),t._uU(3),t.qZA(),t._uU(4),t.qZA(),t.TgZ(5,"a",18),t.NdJ("click",function(){const a=t.CHM(e).$implicit,c=t.oxw(3);return t.KtG(c.deleteBlock(a))}),t.TgZ(6,"i",19),t._uU(7,"delete_forever"),t.qZA()()()}if(2&s){const e=o.$implicit;t.xp6(3),t.Oqu(e.topcountLabel),t.xp6(1),t.hij(" : ",e.value,"")}}function K(s,o){if(1&s&&(t.TgZ(0,"div")(1,"p")(2,"strong"),t._uU(3,"Columns descriptions (select to edit)"),t.qZA()(),t.TgZ(4,"div",14)(5,"ul",15),t.YNc(6,Y,8,2,"li",16),t.qZA()()()),2&s){const e=t.oxw(2);t.xp6(6),t.Q6J("ngForOf",e.dataBlocks)}}function z(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"th",20),t.NdJ("mousedown",function(){const a=t.CHM(e).$implicit,c=t.oxw(2);return t.KtG(c.thSelectStart(a))})("mouseup",function(){const a=t.CHM(e).$implicit,c=t.oxw(2);return t.KtG(c.thSelectEnd(a))}),t._uU(1),t.qZA()}if(2&s){const e=o.$implicit,i=t.oxw(2);t.xp6(1),t.hij(" ",i.dataModel.th[e]," ")}}function j(s,o){if(1&s&&(t.TgZ(0,"td"),t._uU(1),t.qZA()),2&s){const e=o.$implicit,i=t.oxw().$implicit,n=t.oxw(2);t.Udp("background-color",n.bgColors[e]?n.bgColors[e]:"inherited"),t.xp6(1),t.hij("",i[e]," ")}}function V(s,o){if(1&s&&(t.TgZ(0,"tr")(1,"td",21),t._uU(2),t.qZA(),t.YNc(3,j,2,3,"td",22),t.qZA()),2&s){const e=o.index,i=t.oxw(2);t.xp6(2),t.Oqu(i.dataModel.specialRowsLabels[e]),t.xp6(1),t.Q6J("ngForOf",i.visibleColIx)}}function P(s,o){if(1&s&&(t.TgZ(0,"td"),t._uU(1),t.qZA()),2&s){const e=o.$implicit,i=t.oxw().$implicit,n=t.oxw(2);t.Udp("background-color",n.bgColors[e]?n.bgColors[e]:"inherited"),t.xp6(1),t.hij("",i[e]," ")}}function $(s,o){if(1&s&&(t.TgZ(0,"tr")(1,"td",21),t._uU(2),t.qZA(),t.YNc(3,P,2,3,"td",22),t.qZA()),2&s){const e=o.index,i=t.oxw(2);t.xp6(2),t.Oqu(i.dataModel.rowsLabels[e]),t.xp6(1),t.Q6J("ngForOf",i.visibleColIx)}}function W(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"div"),t._UZ(1,"hr"),t.TgZ(2,"div")(3,"h4"),t._uU(4,"Current Topcount import parameters "),t.qZA(),t.YNc(5,G,8,0,"div",1),t.YNc(6,Q,6,1,"div",0),t.YNc(7,K,7,1,"div",2),t.TgZ(8,"div")(9,"button",3),t.NdJ("click",function(){t.CHM(e);const n=t.oxw();return t.KtG(n.accept())}),t._uU(10,"Import timeseries "),t.qZA()()(),t._UZ(11,"hr"),t.TgZ(12,"h4"),t._uU(13,"Data table "),t.TgZ(14,"small"),t._uU(15,"(only top rows)"),t.qZA()(),t.TgZ(16,"p"),t._uU(17,"Click on column headers for description options"),t.qZA(),t.TgZ(18,"div",4)(19,"table",5)(20,"thead")(21,"tr",6),t._UZ(22,"th"),t.YNc(23,z,2,1,"th",7),t.qZA()(),t.TgZ(24,"tbody"),t.YNc(25,V,4,2,"tr",8),t.YNc(26,$,4,2,"tr",8),t.qZA()()()()}if(2&s){const e=t.oxw();t.xp6(5),t.Q6J("ngIf",!e.hasData()),t.xp6(1),t.Q6J("ngIf",e.timeColumnDescription),t.xp6(1),t.Q6J("ngIf",e.dataBlocks&&e.dataBlocks.length>0),t.xp6(2),t.Q6J("disabled",e.blocked||!e.hasTime()||!e.hasData()),t.xp6(14),t.Q6J("ngForOf",e.visibleColIx),t.xp6(2),t.Q6J("ngForOf",e.dataModel.specialRows),t.xp6(1),t.Q6J("ngForOf",e.dataModel.rows)}}class C{constructor(o,e){this.confDialogs=o,this.matDialog=e,this.onAccepted=new t.vpe,this.blocked=!1,this.confirmDataLoss=!1,this.columnBlocks=new l.Mt,this.dataBlocks=[],this.bgColors=[]}set dataTable(o){if(!o||o.length<1)return;const e=new f(o,this.topcountHeaders(),void 0,[[]],["L."]);this.dataModel=e,this.lastCol=e.width,this.visibleColIx=[];for(let i=0;i<e.width;i++)this.visibleColIx.push(i);this.initTime()}topcountHeaders(){const o=[];return["A","B","C","D","E","F","G","H"].forEach(i=>{for(let n=1;n<13;n++)o.push(i+n)}),o}initTime(){const o=new l.lu(new l.xn(0,0),new l.xn(0,0)),e=new l.bq;e.timeType=l.ET.TIME_IN_HOURS,e.timeOffset=0,e.firstRow=1;const i=new l.Wr(o);i.role=l.H3.TIME,i.details=e,this.timeColumnDescription=i}hasTime(){return this.timeColumnDescription&&this.timeColumnDescription.role===l.H3.TIME}hasData(){return this.dataBlocks.some(o=>o.details.role===l.H3.DATA)}rowSelected(o){const e=this.joinRow(o),i=new l.xn(0,o+1),n=new l.lu(i,i),a=new l.Wr(n,e);this.askCopyRow(a)}askCopyRow(o){this.matDialog.open(b,{data:o,autoFocus:!1}).afterClosed().subscribe(i=>{i&&this.copyRowAsLabels(i)})}thSelectStart(o){this.thSelectedCol=o}thSelectEnd(o){if(void 0!==this.thSelectedCol&&null!=this.thSelectedCol){const e=new l.xn(this.thSelectedCol+1,1),i=new l.xn(o+1,1),n=new l.lu(e,i),a=new l.Wr(n,void 0),c=this.columnBlocks.details(e.col);c&&(a.role=c.role,a.details=c.details),this.thSelectedCol=void 0,this.askColumnsDetails(a)}}askColumnsDetails(o){const e=this.rangeToTopcountLabel(o),i=new S(o,this.lastCol,!1,e);this.matDialog.open(T,{data:i,autoFocus:!1}).afterClosed().subscribe(a=>{if(a){const c=a.follow;a.follow=void 0,this.setColumnType(a),c&&this.askColumnsDetails(c)}})}rangeToTopcountLabel(o){const e=o.range;return(0,l.jh)(e.firstCol)+"-"+(0,l.jh)(e.lastCol)}editBlock(o){o&&this.askColumnsDetails(o.details)}deleteBlock(o){o&&(o.details.role==l.H3.TIME?this.clearTime():this.resetRegion(o.details.range),this.dataBlocks=this.columnBlocks.blocks)}accept(){if(!this.hasTime()||!this.hasData())return;let o=Promise.resolve(!0);this.containsDataGaps()&&(o=this.confDialogs.confirm("Do you want to import partial data?","Not all columns are described. Data columns without annotations will not be imported.<br>Click OK if you want to proceed.").toPromise()),o.then(e=>!!e&&(!this.confirmDataLoss||this.confDialogs.confirm("Do you want to replace the existing data?","It will also erase all analysis results. <br>Click OK if you want to proceed.").toPromise())).then(e=>{e&&this.emitParameters()}).catch(e=>console.log("Dialog error: "+e))}containsDataGaps(){if(this.dataBlocks.length<1||this.dataBlocks[this.dataBlocks.length-1].end<this.lastCol)return!0;let o=this.dataBlocks[0].start-1;for(let e=0;e<this.dataBlocks.length;e++){if(this.dataBlocks[e].start!==o+1)return!0;o=this.dataBlocks[e].end}return!1}emitParameters(){const o=new v.p5;o.timeColumn=this.timeColumnDescription,o.dataBlocks=this.dataBlocks.map(e=>e.details),this.onAccepted.emit(o)}joinRow(o){return this.dataModel.rows[o].slice(0,10).join(" | ")+"..."}setColumnType(o){if(o&&void 0!==o.role){let e;switch(this.timeColumnDescription&&(o.role==l.H3.TIME||this.timeColumnDescription.firstCol>=o.firstCol&&this.timeColumnDescription.firstCol<=o.lastCol)&&this.clearTime(),o.role){case l.H3.IGNORED:e="ign.";break;case l.H3.BACKGROUND:e="bcg.";break;case l.H3.TIME:e="Time";break;case l.H3.DATA:e=o.details.dataLabel}this.columnBlocks.insert(o,e),this.columnBlocks.merge(),this.dataBlocks=this.columnBlocks.blocks;const i=this.dataModel.specialRows[0];if(i)for(let n=o.firstCol-1;n<o.lastCol;n++)i[n]=e;o.role==l.H3.TIME&&(this.timeColumnDescription=o),this.updateBackgrounds()}}copyRowAsLabels(o){if(o){this.clearTime();const e=this.dataModel.specialRows[0];this.dataModel.rows[o.range.first.row-1].forEach((n,a)=>{if(n){const c=new l.T(n),Z=new l.xn(a+1,0),et=new l.lu(Z,Z),M=new l.Wr(et,void 0);M.details=c,M.role=l.H3.DATA,this.columnBlocks.insert(M,n),e[a]=n}}),this.columnBlocks.merge(),this.dataBlocks=this.columnBlocks.blocks,this.updateBackgrounds()}}clearTime(){this.timeColumnDescription&&(this.resetRegion(this.timeColumnDescription.range),this.timeColumnDescription=void 0)}updateBackgrounds(){for(let o=0;o<this.dataBlocks.length;o++){const e=this.dataBlocks[o];let i=p.color(o);e.details.role==l.H3.IGNORED&&(i=p.IGNORED_BG),e.details.role==l.H3.BACKGROUND&&(i=p.NOISE_BG),e.details.role==l.H3.TIME&&(i=p.TIME_BG);for(let n=e.start-1;n<e.end;n++)this.bgColors[n]=i}}resetRegion(o){this.resetLabels(o),this.resetBackground(o),this.columnBlocks.delete(o)}resetBackground(o){for(let e=o.firstCol-1;e<o.lastCol;e++)this.bgColors[e]="transparent"}resetLabels(o){const e=this.dataModel.specialRows[0];for(let i=o.firstCol-1;i<o.lastCol;i++)e[i]="-"}fakeData(){const e=[];let i=[];i.push("");for(let n=1;n<25;n++)i.push("RO "+n);e.push(i),i=[],i.push("");for(let n=1;n<25;n++)i.push("cls"+Math.round(n/3));e.push(i);for(let n=1;n<5;n++){i=[],i.push(""+n);for(let a=1;a<25;a++)i.push(""+(n+a));e.push(i)}return e}}function X(s,o){if(1&s){const e=t.EpF();t.TgZ(0,"bd2-describe-topcount-table",1),t.NdJ("onAccepted",function(n){t.CHM(e);const a=t.oxw();return t.KtG(a.import(n))}),t.qZA()}if(2&s){const e=t.oxw();t.Q6J("dataTable",e.dataTable)("blocked",e.blocked)("confirmDataLoss",null==e.assay?null:e.assay.features.hasTSData)}}C.\u0275fac=function(o){return new(o||C)(t.Y36(L.d),t.Y36(m.uw))},C.\u0275cmp=t.Xpm({type:C,selectors:[["bd2-describe-topcount-table"]],inputs:{blocked:"blocked",confirmDataLoss:"confirmDataLoss",dataTable:"dataTable"},outputs:{onAccepted:"onAccepted"},decls:1,vars:1,consts:[[4,"ngIf"],["type","danger","class","alert alert-danger","role","alert",4,"ngIf"],["style","",4,"ngIf"],[1,"btn","btn-primary",3,"disabled","click"],[2,"overflow-x","auto"],["role","grid",1,"table","table-bordered","excel-table",2,"width","auto"],["role","row"],[3,"mousedown","mouseup",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],["type","danger","role","alert",1,"alert","alert-danger"],[1,"form-group"],["for","timeOffset"],["type","number","id","timeOffset","step","any","placeholder","e.g. -4","name","fTimeOffset",1,"form-control","short-input",3,"ngModel","ngModelChange"],["fTimeOffset","ngModel"],[2,"max-height","20em","overflow-y","auto","margin-bottom","1em"],[1,"list-group"],["class","list-group-item",3,"click",4,"ngFor","ngForOf"],[1,"list-group-item",3,"click"],["role","button","aria-label","delete",1,"float-right",3,"click"],[1,"material-icons","bd-icon","bd-primary"],[3,"mousedown","mouseup"],[1,"rowh"],[3,"background-color",4,"ngFor","ngForOf"]],template:function(o,e){1&o&&t.YNc(0,W,27,7,"div",0),2&o&&t.Q6J("ngIf",e.dataModel)},dependencies:[u.sg,u.O5,r.Fj,r.wV,r.JJ,r.On],encapsulation:2});class w extends A.w{constructor(o,e,i){super(i),this.fileViewService=o,this.route=e,this.blocked=!1,this.titlePart=" Import Data"}ngOnInit(){super.ngOnInit(),this.route.params.forEach(o=>{const e=o.fileId,i=o.format;e&&i?this.loadData(i,e):console.log(this.constructor.name+" null parameters")})}loadData(o,e){this.format=v.kk.get(o),this.fileId=e,this.blocked=!1,this.fileViewService.getSimpleTableView(e).then(i=>{this.dataTable=i}).catch(i=>{this.feedback.error(i)})}import(o){if(o&&this.fileId&&this.format){this.blocked=!0;const e=new v.nl;e.fileId=this.fileId,e.importFormat=this.format,e.importParameters=o,this.experimentService.importTimeSeries(this.assay,e).toPromise().then(i=>(this.feedback.success("Imported "+i.imported+" timeseries"),i)).then(()=>this.refreshModel()).then(i=>this.goToTSView()).catch(i=>{this.blocked=!1,this.feedback.error(i)})}}goToTSView(){const o=this.expHomePath();o.push("data"),o.push("view"),o.push("ts"),this.router.navigate(o)}}w.\u0275fac=function(o){return new(o||w)(t.Y36(h),t.Y36(x.gz),t.Y36(O.L))},w.\u0275cmp=t.Xpm({type:w,selectors:[["ng-component"]],features:[t._Bn([]),t.qOj],decls:3,vars:1,consts:[[3,"dataTable","blocked","confirmDataLoss","onAccepted",4,"ngIf"],[3,"dataTable","blocked","confirmDataLoss","onAccepted"]],template:function(o,e){1&o&&(t.TgZ(0,"h3"),t._uU(1,"Timeseries import"),t.qZA(),t.YNc(2,X,1,3,"bd2-describe-topcount-table",0)),2&o&&(t.xp6(2),t.Q6J("ngIf","TOPCOUNT"===(null==e.format?null:e.format.name)))},dependencies:[u.O5,C],encapsulation:2});const tt=[{path:"",children:[{path:":format/:fileId",component:w}]}];class g{}g.\u0275fac=function(o){return new(o||g)},g.\u0275mod=t.oAB({type:g}),g.\u0275inj=t.cJS({imports:[x.Bz.forChild(tt),x.Bz]});class _{}_.\u0275fac=function(o){return new(o||_)},_.\u0275mod=t.oAB({type:_}),_.\u0275inj=t.cJS({imports:[u.ez,r.u5,r.UX,y.Q,I.O,g]})}}]);