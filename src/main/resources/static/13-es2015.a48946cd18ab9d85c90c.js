(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{d9Wp:function(e,t,r){"use strict";r.r(t),r.d(t,"TsDataModule",(function(){return O}));var a=r("ofXK"),i=r("tyNb"),o=r("yYXI"),n=r("bngM"),s=r("QBpm"),l=r("e8YO"),c=r("Kj3r"),b=r("Iab2"),d=r("fXoL"),p=r("vejM"),u=r("ZMwR"),m=r("GVyA"),h=r("wcxA"),f=r("3Pt+"),g=r("1jcm"),y=r("M9IT");function V(e,t){if(1&e&&(d.Wb(0,"option",28),d.Gc(1),d.Vb()),2&e){const e=t.$implicit;d.oc("value",e.name),d.Cb(1),d.Hc(e.label)}}function P(e,t){if(1&e&&(d.Wb(0,"option",28),d.Gc(1),d.Vb()),2&e){const e=t.$implicit;d.oc("value",e.name),d.Cb(1),d.Hc(e.label)}}function v(e,t){if(1&e&&(d.Wb(0,"option",28),d.Gc(1),d.Vb()),2&e){const e=t.$implicit;d.oc("value",e.name),d.Cb(1),d.Hc(e.label)}}const w=function(){return[10,25,50,100,200]};let x=(()=>{class e extends h.a{constructor(e){super(e)}}return e.\u0275fac=function(t){return new(t||e)(d.Qb(f.d))},e.\u0275cmp=d.Kb({type:e,selectors:[["bd2-tsdisplay-params-rform"]],inputs:{disabled:"disabled",totalTraces:"totalTraces",currentPage:"currentPage"},outputs:{displayParams:"displayParams"},features:[d.zb],decls:47,vars:10,consts:[["role","form",1,"form-horizontal","container",3,"formGroup"],[1,"row"],[1,"col-md-8","col-sm-10"],["formGroupName","timeScale",1,"form-group","row"],[1,"col-md-3","col-sm-3"],["for","timeStart",1,"col-md-1","col-sm-2"],["type","number","step","any","min","0","size","5","id","timeStart","required","","formControlName","timeStart",1,"form-control"],["for","timeEnd",1,"col-md-1","col-sm-1"],["type","number","step","any","min","0","size","5","required","","id","timeEnd","formControlName","timeEnd",1,"form-control"],[1,"col-md-2","col-sm-4"],["formControlName","hourly",1,"mr-3"],[1,"form-group","row"],["for","detrending",1,"col-sm-2"],[1,"col-sm-3"],["required","","id","detrending","formControlName","detrending",1,"form-control"],[3,"value",4,"ngFor","ngForOf"],[1,"col-sm-1"],["for","align",1,"col-sm-1"],["required","","id","align","formControlName","align",1,"form-control"],[1,"col-sm-2"],["for","normalisation"],["required","","id","normalisation","formControlName","normalisation",1,"form-control"],[1,"col-sm"],["formControlName","trimFirst",1,"mr-3"],["formControlName","log2"],[1,"col-sm-8"],[3,"length","disabled","pageSize","pageIndex","pageSizeOptions","page"],["dataPaginator",""],[3,"value"]],template:function(e,t){1&e&&(d.Wb(0,"form",0),d.Wb(1,"div",1),d.Wb(2,"div",2),d.Wb(3,"div",3),d.Wb(4,"label",4),d.Gc(5,"Time range"),d.Vb(),d.Wb(6,"label",5),d.Gc(7,"from:"),d.Vb(),d.Wb(8,"div",4),d.Rb(9,"input",6),d.Vb(),d.Wb(10,"label",7),d.Gc(11,"to:"),d.Vb(),d.Wb(12,"div",4),d.Rb(13,"input",8),d.Vb(),d.Vb(),d.Vb(),d.Wb(14,"div",9),d.Wb(15,"mat-slide-toggle",10),d.Gc(16,"hourly"),d.Vb(),d.Vb(),d.Vb(),d.Wb(17,"div",11),d.Wb(18,"label",12),d.Gc(19,"Detrending"),d.Vb(),d.Wb(20,"div",13),d.Wb(21,"select",14),d.Ec(22,V,2,2,"option",15),d.Vb(),d.Vb(),d.Rb(23,"div",16),d.Wb(24,"label",17),d.Gc(25,"Align"),d.Vb(),d.Wb(26,"div",13),d.Wb(27,"select",18),d.Ec(28,P,2,2,"option",15),d.Vb(),d.Vb(),d.Vb(),d.Wb(29,"div",11),d.Wb(30,"div",19),d.Wb(31,"label",20),d.Gc(32,"Normalize"),d.Vb(),d.Vb(),d.Wb(33,"div",13),d.Wb(34,"select",21),d.Ec(35,v,2,2,"option",15),d.Vb(),d.Vb(),d.Wb(36,"div",22),d.Wb(37,"mat-slide-toggle",23),d.Gc(38,"within range"),d.Vb(),d.Wb(39,"mat-slide-toggle",24),d.Gc(40,"log2 transf."),d.Vb(),d.Vb(),d.Vb(),d.Rb(41,"div",11),d.Wb(42,"div",11),d.Rb(43,"label",19),d.Wb(44,"div",25),d.Wb(45,"mat-paginator",26,27),d.ec("page",(function(e){return t.loadDataPage(e)})),d.Vb(),d.Vb(),d.Vb(),d.Vb()),2&e&&(d.oc("formGroup",t.mainForm),d.Cb(22),d.oc("ngForOf",t.detrendingOptions),d.Cb(6),d.oc("ngForOf",t.alignOptions),d.Cb(7),d.oc("ngForOf",t.normalisationOptions),d.Cb(10),d.oc("length",t.totalTraces)("disabled",t.disabledPagination)("pageSize",t.currentPage.pageSize)("pageIndex",t.currentPage.pageIndex)("pageSizeOptions",d.qc(9,w)))},directives:[f.C,f.q,f.h,f.i,f.u,f.c,f.y,f.p,f.g,g.a,f.z,a.l,y.a,f.t,f.B],encapsulation:2}),e})();var W=r("nA4b");function C(e,t){if(1&e){const e=d.Xb();d.Wb(0,"div",7),d.Gc(1,"Please complete "),d.Wb(2,"a",8),d.ec("click",(function(){d.xc(e);const t=d.ic(2);return t.goToExpEdit(t.assay.id,"MeasurementSection")})),d.Gc(3,"Measurement details"),d.Vb(),d.Gc(4," to get access to the secondary data "),d.Vb()}}function S(e,t){if(1&e){const e=d.Xb();d.Wb(0,"div",9),d.Wb(1,"label",10),d.Wb(2,"a",11),d.ec("click",(function(){return d.xc(e),d.ic(2).exportDataView()})),d.Wb(3,"i",12),d.Gc(4,"save_alt"),d.Vb(),d.Wb(5,"span",13),d.Gc(6,"Download"),d.Vb(),d.Vb(),d.Gc(7," current view "),d.Vb(),d.Wb(8,"label",10),d.Wb(9,"a",14),d.ec("click",(function(){return d.xc(e),d.ic(2).exportFullData()})),d.Wb(10,"i",12),d.Gc(11,"save_alt"),d.Vb(),d.Wb(12,"span",13),d.Gc(13,"Download"),d.Vb(),d.Vb(),d.Gc(14," full "),d.Vb(),d.Vb()}}function E(e,t){if(1&e&&d.Rb(0,"bd2-ts-plots",15),2&e){const e=d.ic(2);d.oc("tracesPerPlot",e.tracesPerPlot)("data",e.timeseries)}}function D(e,t){if(1&e){const e=d.Xb();d.Wb(0,"div"),d.Wb(1,"h3"),d.Gc(2,"Show timeseries"),d.Vb(),d.Rb(3,"hr"),d.Wb(4,"bd2-tsdisplay-params-rform",1),d.ec("displayParams",(function(t){return d.xc(e),d.ic().displayChanged(t)})),d.Vb(),d.Ec(5,C,5,0,"div",2),d.Rb(6,"hr"),d.Wb(7,"div",3),d.Gc(8," Hint: You can click on trace label box to remove it from the plot. "),d.Vb(),d.Wb(9,"div",4),d.Ec(10,S,15,0,"div",5),d.Vb(),d.Rb(11,"hr"),d.Ec(12,E,1,2,"bd2-ts-plots",6),d.Vb()}if(2&e){const e=d.ic();d.Cb(4),d.oc("disabled",e.disabledSecondary)("totalTraces",e.totalTraces)("currentPage",e.currentPage),d.Cb(1),d.oc("ngIf",e.disabledSecondary),d.Cb(5),d.oc("ngIf",e.timeseries),d.Cb(2),d.oc("ngIf",e.timeseries)}}const G=[{path:"",children:[{path:"view/ts",component:(()=>{class e extends o.a{constructor(e,t,r,a){super(a),this.fetcher=e,this.RDMSocial=t,this.analytics=r,this.timeseries=[],this.totalTraces=0,this.currentPage=n.a.firstPage(),this.tracesPerPlot=5,this.blocked=!1,this.disabledSecondary=!1,this.csvExporter=new l.a,this.titlePart=" Data"}ngOnInit(){super.ngOnInit(),this.timeSeriesSubsripction=this.fetcher.seriesPackStream.pipe(Object(c.a)(1e3)).subscribe(e=>{if(!this.assay)return;const t=e.data;this.currentParams=e.params,this.timeseries=t,this.tracesPerPlot=Math.max(5,t.length/20),this.totalTraces=e.totalTraces,this.currentPage=e.currentPage,this.analytics.experimentDataViev(this.assay.id)},e=>{console.log("Error in TS subscription: "+e),this.feedback.error(e)})}ngOnDestroy(){this.timeSeriesSubsripction&&this.timeSeriesSubsripction.unsubscribe(),this.fetcher.ngOnDestroy(),super.ngOnDestroy()}displayChanged(e){this.fetcher.changeDisplayParams(e)}exportDataView(){this.exportSeriesPack(this.fetcher.current)}exportFullData(){this.fetcher.getFullDataSet(this.assay,this.fetcher.current.params).subscribe(e=>{this.exportSeriesPack(e,!0)})}exportSeriesPack(e,t=!1){if(!e)return;const r=this.csvExporter.renderCSVTable(e.data,e.params,e.currentPage,this.assay),a=new Blob([r],{type:"text/csv"});b.saveAs(a,`${this.assay.id}_data.${e.params.detrending.name}${t?".full":`.page${e.currentPage.pageIndex+1}`}.csv`),this.recordExport()}recordExport(){this.analytics.experimentDataExport(this.assay.id)}updateModel(e){super.updateModel(e),this.RDMSocial.canProceedByMeasurement(e).then(e=>{this.disabledSecondary=!e}),this.fetcher.experiment(e)}}return e.\u0275fac=function(t){return new(t||e)(d.Qb(s.a),d.Qb(p.a),d.Qb(u.a),d.Qb(m.a))},e.\u0275cmp=d.Kb({type:e,selectors:[["ng-component"]],features:[d.Bb([s.a]),d.zb],decls:1,vars:1,consts:[[4,"ngIf"],[3,"disabled","totalTraces","currentPage","displayParams"],["type","danger","class","alert alert-danger","role","alert",4,"ngIf"],["type","info","role","alert","dismissible","true","dismissOnTimeout","20000",1,"alert","alert-info"],[1,"clearfix"],["class","float-right",4,"ngIf"],[3,"tracesPerPlot","data",4,"ngIf"],["type","danger","role","alert",1,"alert","alert-danger"],[3,"click"],[1,"float-right"],[1,"mr-4"],["download","","role","button","aria-label","download",1,"btn","btn-primary",2,"color","white",3,"click"],[1,"material-icons","bd-icon"],[1,"cdk-visually-hidden"],["download","","role","button","aria-label","download whole",1,"btn","btn-primary",2,"color","white",3,"click"],[3,"tracesPerPlot","data"]],template:function(e,t){1&e&&d.Ec(0,D,13,6,"div",0),2&e&&d.oc("ngIf",t.assay)},directives:[a.m,x,W.a],encapsulation:2}),e})()},{path:"view/heatmap",loadChildren:()=>Promise.all([r.e(0),r.e(18)]).then(r.bind(null,"QftV")).then(e=>e.TsHeatmapModule)},{path:"ts-old-import",loadChildren:()=>Promise.all([r.e(0),r.e(17)]).then(r.bind(null,"9Gw/")).then(e=>e.TsOldImportModule)},{path:"ts-import",loadChildren:()=>Promise.all([r.e(0),r.e(19)]).then(r.bind(null,"yPAH")).then(e=>e.TsImportModule)}]}];let T=(()=>{class e{}return e.\u0275mod=d.Ob({type:e}),e.\u0275inj=d.Nb({factory:function(t){return new(t||e)},imports:[[i.f.forChild(G)],i.f]}),e})();var k=r("YiFe"),I=r("a6j2"),M=r("ZTEM");let O=(()=>{class e{}return e.\u0275mod=d.Ob({type:e}),e.\u0275inj=d.Nb({factory:function(t){return new(t||e)},imports:[[a.c,f.j,f.x,k.a,I.a,T,M.a]]}),e})()},e8YO:function(e,t,r){"use strict";r.d(t,"a",(function(){return i}));class a{constructor(e){this.rows=new Map,this.nextColumn=0,this.sorted=!0,null!=e&&(this.sorted=e)}get width(){return this.nextColumn}get size(){return this.rows.size}append(e,t){this.put(e,t,this.nextColumn)}put(e,t,r){this._put(e,t,r),this.nextColumn=Math.max(this.nextColumn,r+1)}putColumn(e,t,r){e.forEach((e,a)=>{this._put(e,t[a],r)}),this.nextColumn=Math.max(this.nextColumn,r+1)}appendColumn(e,t){this.putColumn(e,t,this.nextColumn)}getValue(e,t){const r=this.rows.get(e);return r?r[t]:void 0}getRow(e){return this.rows.get(e)}forEach(e){this.keys().forEach((t,r)=>{const a={key:t,columns:this.rows.get(t)};e(a,r,this)})}forEachFlat(e){this.keys().forEach((t,r)=>{const a=[t].concat(this.rows.get(t));e(a,r,this)})}keys(){return this.sorted?Array.from(this.rows.keys()).sort((e,t)=>e==t?0:e<t?-1:1):Array.from(this.rows.keys())}_put(e,t,r){let a=this.rows.get(e);a||(a=[],this.rows.set(e,a)),a[r]=t}}class i{constructor(){this.SEP=","}renderCSVTable(e,t,r,a){const i=this.prepareHeaders(a,t,r,e.length);this.appendDataLabels(i,e);const o=this.prepareDataTable(e);let n=this.mapToString(i,this.SEP);return n+=this.mapToString(o,this.SEP),n}prepareHeaders(e,t,r,a){const i=this.prepareExpHeaders(e);return this.appendDisplayProperties(i,t),this.appendDataProperties(i,a,r),i}prepareExpHeaders(e){const t=new a(!1);return t.put("Exp Id:",""+e.id,0),t.put("Exp URL:","https://biodare2.ed.ac.uk/experiment/"+e.id,0),t.put("Exp Name:",e.name,0),e.contributionDesc.authors.forEach((e,r)=>{t.put("Authors:",e.name,r)}),t}appendDisplayProperties(e,t){e.put("Time range:",t.timeScaleLabel,0),e.put("Detrending:",t.detrending.label,0),t.hourly&&e.put("Hourly binned:","true",0),t.log2&&e.put("Log2 transform:",""+t.log2,0),e.put("Normalization:",t.normalisation,0),e.put("Normalization:",t.trimFirst?"within range":"whole serie",1),e.put("Align:",t.align,0)}appendDataProperties(e,t,r){e.put("Traces",t+" of "+r.length,0);const a=Math.floor(r.length/r.pageSize)+(r.length%r.pageSize==0?0:1);e.put("Data Page",r.pageIndex+1+" of "+a,0)}appendDataLabels(e,t){t.forEach((t,r)=>{e.put("Label:",t.label,r)})}prepareDataTable(e){const t=new a;return e.forEach(e=>{const r=e.data.map(e=>e.x),a=e.data.map(e=>e.y);t.appendColumn(r,a)}),t}mapToString(e,t){let r="";return e.forEachFlat(e=>{for(let a=0;a<e.length;a++)void 0!==e[a]&&(r+=e[a]),r+=t;r+="\n"}),r}}}}]);