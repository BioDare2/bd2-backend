"use strict";(self.webpackChunkbiodare2_ui=self.webpackChunkbiodare2_ui||[]).push([[892],{5892:(ot,b,m)=>{m.r(b),m.d(b,{TsOldImportModule:()=>tt});var p=m(6814),c=m(6223),w=m(7229),x=m(8345),g=m(1896),v=m(4621),_=m(8685),t=m(5879),M=m(8351);let D=(()=>{class n{constructor(e){this.BD2REST=e}getSimpleTableView(e){return this.BD2REST.fileViewSimpleTable(e).then(o=>o.data)}verifyFormat(e,o){return this.BD2REST.fileViewVerifyFormat(e,o).toPromise()}}return n.\u0275fac=function(e){return new(e||n)(t.LFG(M.q))},n.\u0275prov=t.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"}),n})();var Z=m(6444),s=m(6138);class h{constructor(a,e,o,i,l){this.rows=a,this.th=e,this.rowsLabels=o,this.specialRows=i,this.specialRowsLabels=l,this.width=h.maxLength(a),this.th=e||(a.length<1?[]:h.labelCols(this.width)),this.rowsLabels=o||h.labelRows(a.length),this.specialRows=i||[],this.specialRowsLabels=l||h.blankRows(this.specialRows.length)}static labelRows(a){const e=[];for(let o=1;o<=a;o++)e.push(""+o);return e}static blankRows(a){const e=[];for(let o=0;o<a;o++)e.push("");return e}static maxLength(a){return!a||a.length<1?0:Math.max.apply(Math,a.map(e=>e.length))}static labelCols(a){const e=[];for(let o=1;o<=a;o++)e.push((0,s.jO)(o));return e}}let f=(()=>{class n{static color(e){return n.colors[e%n.colors.length]}}return n.TIME_BG="lightyellow",n.IGNORED_BG="lightgrey",n.NOISE_BG="darkgrey",n.colors=["lightgreen","lightblue","lightcoral","lightcyan","lightgreen","lightpink","lightsalmon","lightseagreen","lightskyblue","palegoldenrod","paleturquoise","palevioletred"],n})();var d=m(8189);const y=["columnTypeForm"];function I(n,a){if(1&n){const e=t.EpF();t.TgZ(0,"li")(1,"input",14,15),t.NdJ("ngModelChange",function(i){t.CHM(e);const l=t.oxw();return t.KtG(l.cellRole=i)}),t.qZA(),t._uU(3),t.qZA()}if(2&n){const e=a.$implicit,o=t.oxw();t.xp6(1),t.s9C("value",e.name),t.Q6J("ngModel",o.cellRole),t.xp6(2),t.hij(" ",e.label," ")}}function A(n,a){if(1&n){const e=t.EpF();t.TgZ(0,"div",5)(1,"label",16),t._uU(2,"Propagate until block size"),t.qZA(),t.TgZ(3,"input",17,18),t.NdJ("ngModelChange",function(i){t.CHM(e);const l=t.oxw();return t.KtG(l.rangeSize=i)}),t.qZA()()}if(2&n){const e=t.oxw();t.xp6(3),t.Q6J("ngModel",e.rangeSize)}}function k(n,a){if(1&n){const e=t.EpF();t.TgZ(0,"div",5)(1,"label",19),t._uU(2,"Label"),t.qZA(),t.TgZ(3,"input",20,21),t.NdJ("ngModelChange",function(i){t.CHM(e);const l=t.oxw();return t.KtG(l.dataLabel=i)}),t.qZA()()}if(2&n){const e=t.oxw();t.xp6(3),t.Q6J("ngModel",e.dataLabel)}}function O(n,a){if(1&n&&(t.TgZ(0,"option",32),t._uU(1),t.qZA()),2&n){const e=a.$implicit;t.s9C("value",e.name),t.xp6(1),t.hij("",e.label," ")}}function R(n,a){if(1&n){const e=t.EpF();t.TgZ(0,"div",5)(1,"label",33),t._uU(2,"Time between images (hours)"),t.qZA(),t.TgZ(3,"input",34,35),t.NdJ("ngModelChange",function(i){t.CHM(e);const l=t.oxw(2);return t.KtG(l.imgInterval=i)}),t.qZA()()}if(2&n){const e=t.oxw(2);t.xp6(3),t.Q6J("ngModel",e.imgInterval)}}function U(n,a){if(1&n){const e=t.EpF();t.TgZ(0,"div")(1,"div",5)(2,"label",22),t._uU(3,"Type of time column"),t.qZA(),t.TgZ(4,"select",23,24),t.NdJ("ngModelChange",function(i){t.CHM(e);const l=t.oxw();return t.KtG(l.timeType=i)}),t.YNc(6,O,2,2,"option",25),t.qZA()(),t.TgZ(7,"div",5)(8,"label",26),t._uU(9,"Row with first timepoint"),t.qZA(),t.TgZ(10,"input",27,28),t.NdJ("ngModelChange",function(i){t.CHM(e);const l=t.oxw();return t.KtG(l.firstRow=i)}),t.qZA()(),t.TgZ(12,"div",5)(13,"label",29),t._uU(14,"Time offset (hours)"),t.qZA(),t.TgZ(15,"input",30,31),t.NdJ("ngModelChange",function(i){t.CHM(e);const l=t.oxw();return t.KtG(l.timeOffset=i)}),t.qZA()(),t.YNc(17,R,5,1,"div",8),t.qZA()}if(2&n){const e=t.oxw();t.xp6(4),t.Q6J("ngModel",e.timeType),t.xp6(2),t.Q6J("ngForOf",e.timeTypeOptions),t.xp6(4),t.Q6J("ngModel",e.firstRow),t.xp6(5),t.Q6J("ngModel",e.timeOffset),t.xp6(2),t.Q6J("ngIf",e.isImageBased())}}function N(n,a){if(1&n&&(t.TgZ(0,"div",37),t._uU(1),t.qZA()),2&n){const e=a.$implicit;t.xp6(1),t.Oqu(e)}}function B(n,a){if(1&n&&(t.TgZ(0,"div"),t.YNc(1,N,2,1,"div",36),t.qZA()),2&n){const e=t.oxw();t.xp6(1),t.Q6J("ngForOf",e.errors)}}class q{constructor(a,e,o,i){this.selectedRange=a,this.lastCol=e,this.showTime=o,this.label=i}}let F=(()=>{class n{constructor(e,o){this.myself=e,this.errors=null,this.cellRoles=[s.H3.IGNORED,s.H3.BACKGROUND,s.H3.TIME,s.H3.DATA],this.timeTypeOptions=[s.ET.TIME_IN_HOURS,s.ET.TIME_IN_MINUTES,s.ET.TIME_IN_SECONDS,s.ET.IMG_NUMBER],this.lastCol=o.lastCol,this.showTime=o.showTime,this.show(o.selectedRange,o.label)}ngOnInit(){}set showTime(e){this.cellRoles=e?[s.H3.IGNORED,s.H3.BACKGROUND,s.H3.TIME,s.H3.DATA]:[s.H3.IGNORED,s.H3.BACKGROUND,s.H3.DATA]}isData(){return this.cellRole===s.H3.DATA.name}isTime(){return this.cellRole===s.H3.TIME.name}isImageBased(){return this.isTime()&&this.timeType===s.ET.IMG_NUMBER.name}show(e,o){e&&(this.orgRange=e,this.rangeSize=e.range.size(),this.rangeLabel=o||e.columnRangeLabel,e.role&&(this.cellRole=e.role.name),e.role==s.H3.DATA&&e.details&&(this.dataLabel=e.details.dataLabel),e.role==s.H3.TIME&&e.details&&(this.timeType=e.details.timeType.name,this.timeOffset=e.details.timeOffset,this.imgInterval=e.details.imgInterval,this.firstRow=e.details.firstRow))}hide(){this.myself.close()}accepted(){this.isValid()&&this.myself.close(this.emitDescription())}acceptedAndNext(){if(!this.isValid())return;const e=this.emitDescription();if(!(e.range.lastCol>=this.lastCol)){const o=this.nextRange(e.range,this.rangeSize),i=new s.Wr(o);i.role=s.H3.DATA,i.details=e.details,e.follow=i}this.myself.close(e)}nextRange(e,o){const i=e.lastCol+1;let l=i+o-1;return l=Math.min(l,this.lastCol),new s.lu(new s.xn(i,e.first.row),new s.xn(l,e.first.row))}emitDescription(){const e=this.recalculateRange(this.orgRange.range);let o={};if(this.isData())o=new s.T(this.dataLabel);else if(this.isTime()){const l=new s.bq;l.firstRow=this.firstRow,l.timeType=s.ET.get(this.timeType),l.timeOffset=this.timeOffset,this.isImageBased()&&(l.imgInterval=this.imgInterval),o=l}const i=new s.Wr(e,this.orgRange.content);return i.role=s.H3.get(this.cellRole),i.details=o,i}isValid(){const e=[];return s.H3.get(this.cellRole)||e.push("Unknown role: "+this.cellRole),this.isData()&&(!this.dataLabel||""===this.dataLabel.trim())&&(e.push("Non empty data label is required"),this.dataLabel=null),this.isTime()?((!this.firstRow||this.firstRow<1)&&e.push("Row nr of the first time point must be >= 1"),this.isImageBased()&&(!this.imgInterval||this.imgInterval<=0)&&e.push("Image interval must be > 0")):(!this.rangeSize||this.rangeSize<1)&&e.push("Block size must be >= 1"),0===e.length&&(this.errors=null,!0)}recalculateRange(e){let o=e.first;if(this.isTime())return o=new s.xn(o.col,this.firstRow),new s.lu(o,o);if(this.rangeSize!==e.size()){const l=new s.xn(Math.min(o.col+this.rangeSize-1,this.lastCol),o.row);return new s.lu(o,l)}return e}}return n.\u0275fac=function(e){return new(e||n)(t.Y36(d.so),t.Y36(d.WI))},n.\u0275cmp=t.Xpm({type:n,selectors:[["ng-component"]],viewQuery:function(e,o){if(1&e&&t.Gf(y,7),2&e){let i;t.iGM(i=t.CRH())&&(o.columnTypeForm=i.first)}},decls:28,vars:8,consts:[["mat-dialog-title","",1,"modal-title"],["mat-dialog-close","","aria-label","Close","type","button",1,"close","float-right"],["aria-hidden","true"],["mat-dialog-content","",1,"modal-body"],["columnTypeForm","ngForm"],[1,"form-group"],[1,"list-unstyled"],[4,"ngFor","ngForOf"],["class","form-group",4,"ngIf"],[4,"ngIf"],["mat-dialog-actions",""],[1,"btn","btn-primary","btn-sm","mr-1",3,"disabled","click"],[1,"btn","btn-primary","btn-sm","m-1",3,"disabled","click"],["mat-dialog-close","",1,"btn","btn-outline-secondary","btn-sm",3,"click"],["type","radio","required","","name","fCellRole",3,"value","ngModel","ngModelChange"],["fCellRole","ngModel"],["for","size"],["type","number","step","1","min","1","id","size","required","","name","fSize",1,"form-control",3,"ngModel","ngModelChange"],["fSize","ngModel"],["for","dataLabel"],["type","text","id","dataLabel","placeholder","e.g. TOC1 SD","required","","minlength","2","name","fDataLabel",1,"form-control",3,"ngModel","ngModelChange"],["fDataLabel","ngModel"],["for","timeType"],["id","timeType","required","","name","fTimeType",1,"form-control",3,"ngModel","ngModelChange"],["fTimeType","ngModel"],[3,"value",4,"ngFor","ngForOf"],["for","firstRow"],["type","number","id","firstRow","step","1","min","1","required","","placeholder","e.g. 2","name","fFirstRow",1,"form-control",3,"ngModel","ngModelChange"],["fFirstRow","ngModel"],["for","timeOffset"],["type","number","id","timeOffset","step","any","placeholder","e.g. -4","name","fTimeOffset",1,"form-control",3,"ngModel","ngModelChange"],["fTimeOffset","ngModel"],[3,"value"],["for","imgInterval"],["type","number","id","imgInterval","required","","step","any","min","0.01","placeholder","e.g. 1.5","name","fImgInterval",1,"form-control",3,"ngModel","ngModelChange"],["fImgInterval","ngModel"],["dismissOnTimeout","3000","dismissible","true","class","alert alert-danger","role","alert",4,"ngFor","ngForOf"],["dismissOnTimeout","3000","dismissible","true","role","alert",1,"alert","alert-danger"]],template:function(e,o){if(1&e&&(t.TgZ(0,"h4",0),t._uU(1,"Describe data column(s) "),t.TgZ(2,"button",1)(3,"span",2),t._uU(4,"\xd7"),t.qZA()()(),t.TgZ(5,"div",3)(6,"p"),t._uU(7," Columns "),t.TgZ(8,"strong"),t._uU(9),t.qZA()(),t.TgZ(10,"form",null,4)(12,"div",5)(13,"label"),t._uU(14,"Column type"),t.qZA(),t.TgZ(15,"ul",6),t.YNc(16,I,4,3,"li",7),t.qZA()(),t.YNc(17,A,5,1,"div",8),t.YNc(18,k,5,1,"div",8),t.YNc(19,U,18,5,"div",9),t.YNc(20,B,2,1,"div",9),t.qZA()(),t.TgZ(21,"div",10)(22,"button",11),t.NdJ("click",function(){return o.acceptedAndNext()}),t._uU(23,"OK and Next "),t.qZA(),t.TgZ(24,"button",12),t.NdJ("click",function(){return o.accepted()}),t._uU(25,"OK "),t.qZA(),t.TgZ(26,"button",13),t.NdJ("click",function(){return o.hide()}),t._uU(27,"Cancel"),t.qZA()()),2&e){const i=t.MAs(11);t.xp6(9),t.hij("[",o.rangeLabel,"]"),t.xp6(7),t.Q6J("ngForOf",o.cellRoles),t.xp6(1),t.Q6J("ngIf",!o.isTime()),t.xp6(1),t.Q6J("ngIf",o.isData()),t.xp6(1),t.Q6J("ngIf",o.isTime()),t.xp6(1),t.Q6J("ngIf",o.errors),t.xp6(2),t.Q6J("disabled",!i.form.valid),t.xp6(2),t.Q6J("disabled",!i.form.valid)}},dependencies:[p.sg,p.O5,c._Y,c.YN,c.Kr,c.Fj,c.wV,c.EJ,c._,c.JJ,c.JL,c.Q7,c.wO,c.qQ,c.On,c.F,d.ZT,d.uh,d.xY,d.H8],encapsulation:2}),n})(),E=(()=>{class n{constructor(e){this.show(e)}ngOnInit(){}show(e){this.orgRange=e,this.rowNr=e.range.first.row,this.values=e.content}}return n.\u0275fac=function(e){return new(e||n)(t.Y36(d.WI))},n.\u0275cmp=t.Xpm({type:n,selectors:[["ng-component"]],decls:24,vars:3,consts:[["mat-dialog-title","",1,"modal-title"],["mat-dialog-close","","aria-label","Close","type","button",1,"close","float-right"],["aria-hidden","true"],["mat-dialog-content","",1,"modal-body"],[1,"word_wrapping"],["mat-dialog-actions",""],[1,"btn","btn-primary","btn-sm","mr-1",3,"mat-dialog-close"],["mat-dialog-close","",1,"btn","btn-outline-secondary","btn-sm"]],template:function(e,o){1&e&&(t.TgZ(0,"h4",0),t._uU(1,"Use row content as data labels(s) "),t.TgZ(2,"button",1)(3,"span",2),t._uU(4,"\xd7"),t.qZA()()(),t.TgZ(5,"div",3)(6,"div")(7,"p"),t._uU(8,"Use values from row "),t.TgZ(9,"strong"),t._uU(10),t.qZA(),t._uU(11," as data labels"),t.qZA(),t.TgZ(12,"p"),t._uU(13,"Existing labels and column types will be overwritten"),t.qZA()(),t.TgZ(14,"div",4)(15,"p")(16,"strong"),t._uU(17,"Labels: "),t.qZA(),t._uU(18),t.qZA()()(),t.TgZ(19,"div",5)(20,"button",6),t._uU(21,"Copy labels"),t.qZA(),t.TgZ(22,"button",7),t._uU(23,"Cancel"),t.qZA()()),2&e&&(t.xp6(10),t.hij("[",o.rowNr,"]"),t.xp6(8),t.Oqu(o.values),t.xp6(2),t.Q6J("mat-dialog-close",o.orgRange))},dependencies:[d.ZT,d.uh,d.xY,d.H8],encapsulation:2}),n})();var J=m(1009);function H(n,a){1&n&&(t.TgZ(0,"div",9)(1,"strong"),t._uU(2,"Missing data labels. Please use one of the methods:"),t.qZA(),t.TgZ(3,"ul")(4,"li"),t._uU(5,"Click and draw over the headers of columns to select the range and assign the data labels in the popup dialog. "),t.qZA(),t.TgZ(6,"li"),t._uU(7,"Use the form below to manually provide the column range and the data label."),t.qZA()()())}function S(n,a){if(1&n){const e=t.EpF();t.TgZ(0,"div")(1,"div",10)(2,"label",11),t._uU(3,"Time parameter: offset (hours)"),t.qZA(),t.TgZ(4,"input",12,13),t.NdJ("ngModelChange",function(i){t.CHM(e);const l=t.oxw(2);return t.KtG(l.timeColumnDescription.details.timeOffset=i)}),t.qZA()()()}if(2&n){const e=t.oxw(2);t.xp6(4),t.Q6J("ngModel",e.timeColumnDescription.details.timeOffset)}}function L(n,a){if(1&n){const e=t.EpF();t.TgZ(0,"li",17),t.NdJ("click",function(){const l=t.CHM(e).$implicit,r=t.oxw(3);return t.KtG(r.editBlock(l))}),t.TgZ(1,"span")(2,"strong"),t._uU(3),t.qZA(),t._uU(4),t.qZA(),t.TgZ(5,"a",18),t.NdJ("click",function(){const l=t.CHM(e).$implicit,r=t.oxw(3);return t.KtG(r.deleteBlock(l))}),t.TgZ(6,"i",19),t._uU(7,"delete_forever"),t.qZA()()()}if(2&n){const e=a.$implicit;t.xp6(3),t.Oqu(e.topcountLabel),t.xp6(1),t.hij(" : ",e.value,"")}}function G(n,a){if(1&n&&(t.TgZ(0,"div")(1,"p")(2,"strong"),t._uU(3,"Columns descriptions (select to edit)"),t.qZA()(),t.TgZ(4,"div",14)(5,"ul",15),t.YNc(6,L,8,2,"li",16),t.qZA()()()),2&n){const e=t.oxw(2);t.xp6(6),t.Q6J("ngForOf",e.dataBlocks)}}function Q(n,a){if(1&n){const e=t.EpF();t.TgZ(0,"th",20),t.NdJ("mousedown",function(){const l=t.CHM(e).$implicit,r=t.oxw(2);return t.KtG(r.thSelectStart(l))})("mouseup",function(){const l=t.CHM(e).$implicit,r=t.oxw(2);return t.KtG(r.thSelectEnd(l))}),t._uU(1),t.qZA()}if(2&n){const e=a.$implicit,o=t.oxw(2);t.xp6(1),t.hij(" ",o.dataModel.th[e]," ")}}function Y(n,a){if(1&n&&(t.TgZ(0,"td"),t._uU(1),t.qZA()),2&n){const e=a.$implicit,o=t.oxw().$implicit,i=t.oxw(2);t.Udp("background-color",i.bgColors[e]?i.bgColors[e]:"inherited"),t.xp6(1),t.hij("",o[e]," ")}}function K(n,a){if(1&n&&(t.TgZ(0,"tr")(1,"td",21),t._uU(2),t.qZA(),t.YNc(3,Y,2,3,"td",22),t.qZA()),2&n){const e=a.index,o=t.oxw(2);t.xp6(2),t.Oqu(o.dataModel.specialRowsLabels[e]),t.xp6(1),t.Q6J("ngForOf",o.visibleColIx)}}function z(n,a){if(1&n&&(t.TgZ(0,"td"),t._uU(1),t.qZA()),2&n){const e=a.$implicit,o=t.oxw().$implicit,i=t.oxw(2);t.Udp("background-color",i.bgColors[e]?i.bgColors[e]:"inherited"),t.xp6(1),t.hij("",o[e]," ")}}function j(n,a){if(1&n&&(t.TgZ(0,"tr")(1,"td",21),t._uU(2),t.qZA(),t.YNc(3,z,2,3,"td",22),t.qZA()),2&n){const e=a.index,o=t.oxw(2);t.xp6(2),t.Oqu(o.dataModel.rowsLabels[e]),t.xp6(1),t.Q6J("ngForOf",o.visibleColIx)}}function V(n,a){if(1&n){const e=t.EpF();t.TgZ(0,"div"),t._UZ(1,"hr"),t.TgZ(2,"div")(3,"h4"),t._uU(4,"Current Topcount import parameters "),t.qZA(),t.YNc(5,H,8,0,"div",1),t.YNc(6,S,6,1,"div",0),t.YNc(7,G,7,1,"div",2),t.TgZ(8,"div")(9,"button",3),t.NdJ("click",function(){t.CHM(e);const i=t.oxw();return t.KtG(i.accept())}),t._uU(10,"Import timeseries "),t.qZA()()(),t._UZ(11,"hr"),t.TgZ(12,"h4"),t._uU(13,"Data table "),t.TgZ(14,"small"),t._uU(15,"(only top rows)"),t.qZA()(),t.TgZ(16,"p"),t._uU(17,"Click on column headers for description options"),t.qZA(),t.TgZ(18,"div",4)(19,"table",5)(20,"thead")(21,"tr",6),t._UZ(22,"th"),t.YNc(23,Q,2,1,"th",7),t.qZA()(),t.TgZ(24,"tbody"),t.YNc(25,K,4,2,"tr",8),t.YNc(26,j,4,2,"tr",8),t.qZA()()()()}if(2&n){const e=t.oxw();t.xp6(5),t.Q6J("ngIf",!e.hasData()),t.xp6(1),t.Q6J("ngIf",e.timeColumnDescription),t.xp6(1),t.Q6J("ngIf",e.dataBlocks&&e.dataBlocks.length>0),t.xp6(2),t.Q6J("disabled",e.blocked||!e.hasTime()||!e.hasData()),t.xp6(14),t.Q6J("ngForOf",e.visibleColIx),t.xp6(2),t.Q6J("ngForOf",e.dataModel.specialRows),t.xp6(1),t.Q6J("ngForOf",e.dataModel.rows)}}let P=(()=>{class n{constructor(e,o){this.confDialogs=e,this.matDialog=o,this.onAccepted=new t.vpe,this.blocked=!1,this.confirmDataLoss=!1,this.columnBlocks=new s.Mt,this.dataBlocks=[],this.bgColors=[]}set dataTable(e){if(!e||e.length<1)return;const o=new h(e,this.topcountHeaders(),void 0,[[]],["L."]);this.dataModel=o,this.lastCol=o.width,this.visibleColIx=[];for(let i=0;i<o.width;i++)this.visibleColIx.push(i);this.initTime()}topcountHeaders(){const e=[];return["A","B","C","D","E","F","G","H"].forEach(i=>{for(let l=1;l<13;l++)e.push(i+l)}),e}initTime(){const e=new s.lu(new s.xn(0,0),new s.xn(0,0)),o=new s.bq;o.timeType=s.ET.TIME_IN_HOURS,o.timeOffset=0,o.firstRow=1;const i=new s.Wr(e);i.role=s.H3.TIME,i.details=o,this.timeColumnDescription=i}hasTime(){return this.timeColumnDescription&&this.timeColumnDescription.role===s.H3.TIME}hasData(){return this.dataBlocks.some(e=>e.details.role===s.H3.DATA)}rowSelected(e){const o=this.joinRow(e),i=new s.xn(0,e+1),l=new s.lu(i,i),r=new s.Wr(l,o);this.askCopyRow(r)}askCopyRow(e){this.matDialog.open(E,{data:e,autoFocus:!1}).afterClosed().subscribe(i=>{i&&this.copyRowAsLabels(i)})}thSelectStart(e){this.thSelectedCol=e}thSelectEnd(e){if(void 0!==this.thSelectedCol&&null!=this.thSelectedCol){const o=new s.xn(this.thSelectedCol+1,1),i=new s.xn(e+1,1),l=new s.lu(o,i),r=new s.Wr(l,void 0),u=this.columnBlocks.details(o.col);u&&(r.role=u.role,r.details=u.details),this.thSelectedCol=void 0,this.askColumnsDetails(r)}}askColumnsDetails(e){const o=this.rangeToTopcountLabel(e),i=new q(e,this.lastCol,!1,o);this.matDialog.open(F,{data:i,autoFocus:!1}).afterClosed().subscribe(r=>{if(r){const u=r.follow;r.follow=void 0,this.setColumnType(r),u&&this.askColumnsDetails(u)}})}rangeToTopcountLabel(e){const o=e.range;return(0,s.jh)(o.firstCol)+"-"+(0,s.jh)(o.lastCol)}editBlock(e){e&&this.askColumnsDetails(e.details)}deleteBlock(e){e&&(e.details.role==s.H3.TIME?this.clearTime():this.resetRegion(e.details.range),this.dataBlocks=this.columnBlocks.blocks)}accept(){if(!this.hasTime()||!this.hasData())return;let e=Promise.resolve(!0);this.containsDataGaps()&&(e=this.confDialogs.confirm("Do you want to import partial data?","Not all columns are described. Data columns without annotations will not be imported.<br>Click OK if you want to proceed.").toPromise()),e.then(o=>!!o&&(!this.confirmDataLoss||this.confDialogs.confirm("Do you want to replace the existing data?","It will also erase all analysis results. <br>Click OK if you want to proceed.").toPromise())).then(o=>{o&&this.emitParameters()}).catch(o=>console.log("Dialog error: "+o))}containsDataGaps(){if(this.dataBlocks.length<1||this.dataBlocks[this.dataBlocks.length-1].end<this.lastCol)return!0;let e=this.dataBlocks[0].start-1;for(let o=0;o<this.dataBlocks.length;o++){if(this.dataBlocks[o].start!==e+1)return!0;e=this.dataBlocks[o].end}return!1}emitParameters(){const e=new _.p5;e.timeColumn=this.timeColumnDescription,e.dataBlocks=this.dataBlocks.map(o=>o.details),this.onAccepted.emit(e)}joinRow(e){return this.dataModel.rows[e].slice(0,10).join(" | ")+"..."}setColumnType(e){if(e&&void 0!==e.role){let o;switch(this.timeColumnDescription&&(e.role==s.H3.TIME||this.timeColumnDescription.firstCol>=e.firstCol&&this.timeColumnDescription.firstCol<=e.lastCol)&&this.clearTime(),e.role){case s.H3.IGNORED:o="ign.";break;case s.H3.BACKGROUND:o="bcg.";break;case s.H3.TIME:o="Time";break;case s.H3.DATA:o=e.details.dataLabel}this.columnBlocks.insert(e,o),this.columnBlocks.merge(),this.dataBlocks=this.columnBlocks.blocks;const i=this.dataModel.specialRows[0];if(i)for(let l=e.firstCol-1;l<e.lastCol;l++)i[l]=o;e.role==s.H3.TIME&&(this.timeColumnDescription=e),this.updateBackgrounds()}}copyRowAsLabels(e){if(e){this.clearTime();const o=this.dataModel.specialRows[0];this.dataModel.rows[e.range.first.row-1].forEach((l,r)=>{if(l){const u=new s.T(l),C=new s.xn(r+1,0),et=new s.lu(C,C),T=new s.Wr(et,void 0);T.details=u,T.role=s.H3.DATA,this.columnBlocks.insert(T,l),o[r]=l}}),this.columnBlocks.merge(),this.dataBlocks=this.columnBlocks.blocks,this.updateBackgrounds()}}clearTime(){this.timeColumnDescription&&(this.resetRegion(this.timeColumnDescription.range),this.timeColumnDescription=void 0)}updateBackgrounds(){for(let e=0;e<this.dataBlocks.length;e++){const o=this.dataBlocks[e];let i=f.color(e);o.details.role==s.H3.IGNORED&&(i=f.IGNORED_BG),o.details.role==s.H3.BACKGROUND&&(i=f.NOISE_BG),o.details.role==s.H3.TIME&&(i=f.TIME_BG);for(let l=o.start-1;l<o.end;l++)this.bgColors[l]=i}}resetRegion(e){this.resetLabels(e),this.resetBackground(e),this.columnBlocks.delete(e)}resetBackground(e){for(let o=e.firstCol-1;o<e.lastCol;o++)this.bgColors[o]="transparent"}resetLabels(e){const o=this.dataModel.specialRows[0];for(let i=e.firstCol-1;i<e.lastCol;i++)o[i]="-"}fakeData(){const o=[];let i=[];i.push("");for(let l=1;l<25;l++)i.push("RO "+l);o.push(i),i=[],i.push("");for(let l=1;l<25;l++)i.push("cls"+Math.round(l/3));o.push(i);for(let l=1;l<5;l++){i=[],i.push(""+l);for(let r=1;r<25;r++)i.push(""+(l+r));o.push(i)}return o}}return n.\u0275fac=function(e){return new(e||n)(t.Y36(J.d),t.Y36(d.uw))},n.\u0275cmp=t.Xpm({type:n,selectors:[["bd2-describe-topcount-table"]],inputs:{blocked:"blocked",confirmDataLoss:"confirmDataLoss",dataTable:"dataTable"},outputs:{onAccepted:"onAccepted"},decls:1,vars:1,consts:[[4,"ngIf"],["type","danger","class","alert alert-danger","role","alert",4,"ngIf"],["style","",4,"ngIf"],[1,"btn","btn-primary",3,"disabled","click"],[2,"overflow-x","auto"],["role","grid",1,"table","table-bordered","excel-table",2,"width","auto"],["role","row"],[3,"mousedown","mouseup",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],["type","danger","role","alert",1,"alert","alert-danger"],[1,"form-group"],["for","timeOffset"],["type","number","id","timeOffset","step","any","placeholder","e.g. -4","name","fTimeOffset",1,"form-control","short-input",3,"ngModel","ngModelChange"],["fTimeOffset","ngModel"],[2,"max-height","20em","overflow-y","auto","margin-bottom","1em"],[1,"list-group"],["class","list-group-item",3,"click",4,"ngFor","ngForOf"],[1,"list-group-item",3,"click"],["role","button","aria-label","delete",1,"float-right",3,"click"],[1,"material-icons","bd-icon","bd-primary"],[3,"mousedown","mouseup"],[1,"rowh"],[3,"background-color",4,"ngFor","ngForOf"]],template:function(e,o){1&e&&t.YNc(0,V,27,7,"div",0),2&e&&t.Q6J("ngIf",o.dataModel)},dependencies:[p.sg,p.O5,c.Fj,c.wV,c.JJ,c.On],encapsulation:2}),n})();function $(n,a){if(1&n){const e=t.EpF();t.TgZ(0,"bd2-describe-topcount-table",1),t.NdJ("onAccepted",function(i){t.CHM(e);const l=t.oxw();return t.KtG(l.import(i))}),t.qZA()}if(2&n){const e=t.oxw();t.Q6J("dataTable",e.dataTable)("blocked",e.blocked)("confirmDataLoss",null==e.assay?null:e.assay.features.hasTSData)}}const W=[{path:"",children:[{path:":format/:fileId",component:(()=>{class n extends v.w{constructor(e,o,i){super(i),this.fileViewService=e,this.route=o,this.blocked=!1,this.titlePart=" Import Data"}ngOnInit(){super.ngOnInit(),this.route.params.forEach(e=>{const o=e.fileId,i=e.format;o&&i?this.loadData(i,o):console.log(this.constructor.name+" null parameters")})}loadData(e,o){this.format=_.kk.get(e),this.fileId=o,this.blocked=!1,this.fileViewService.getSimpleTableView(o).then(i=>{this.dataTable=i}).catch(i=>{this.feedback.error(i)})}import(e){if(e&&this.fileId&&this.format){this.blocked=!0;const o=new _.nl;o.fileId=this.fileId,o.importFormat=this.format,o.importParameters=e,this.experimentService.importTimeSeries(this.assay,o).toPromise().then(i=>(this.feedback.success("Imported "+i.imported+" timeseries"),i)).then(()=>this.refreshModel()).then(i=>this.goToTSView()).catch(i=>{this.blocked=!1,this.feedback.error(i)})}}goToTSView(){const e=this.expHomePath();e.push("data"),e.push("view"),e.push("ts"),this.router.navigate(e)}}return n.\u0275fac=function(e){return new(e||n)(t.Y36(D),t.Y36(g.gz),t.Y36(Z.L))},n.\u0275cmp=t.Xpm({type:n,selectors:[["ng-component"]],features:[t._Bn([]),t.qOj],decls:3,vars:1,consts:[[3,"dataTable","blocked","confirmDataLoss","onAccepted",4,"ngIf"],[3,"dataTable","blocked","confirmDataLoss","onAccepted"]],template:function(e,o){1&e&&(t.TgZ(0,"h3"),t._uU(1,"Timeseries import"),t.qZA(),t.YNc(2,$,1,3,"bd2-describe-topcount-table",0)),2&e&&(t.xp6(2),t.Q6J("ngIf","TOPCOUNT"===(null==o.format?null:o.format.name)))},dependencies:[p.O5,P],encapsulation:2}),n})()}]}];let X=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[g.Bz.forChild(W),g.Bz]}),n})(),tt=(()=>{class n{}return n.\u0275fac=function(e){return new(e||n)},n.\u0275mod=t.oAB({type:n}),n.\u0275inj=t.cJS({imports:[p.ez,c.u5,c.UX,w.Q,x.O,X]}),n})()}}]);