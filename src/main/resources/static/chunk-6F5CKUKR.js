import{a as Je,b as oe}from"./chunk-BEPXWKFP.js";import{Aa as ot,Bb as rt,Da as A,Dd as st,ba as at,mb as j,tb as re}from"./chunk-PO5LFISD.js";import"./chunk-TTVNO4DU.js";import{a as Ze}from"./chunk-WCGGJLHZ.js";import"./chunk-DBHXPIPS.js";import{a as Ye,f as ue,g as ae,h as Ue,k as Xe,m as Ke,n as lt}from"./chunk-452SMVLT.js";import"./chunk-NIE2ZYPZ.js";import"./chunk-LKZSTFDB.js";import{c as et,d as tt,e as it,f as nt}from"./chunk-X3OMUHYN.js";import{b as qe,c as Qe}from"./chunk-FB5T6NUV.js";import"./chunk-ZAPWFC3C.js";import"./chunk-QDUVFCGA.js";import"./chunk-E2ZG2HAU.js";import{f as $e,l as je,m as We}from"./chunk-6HSKS2XP.js";import"./chunk-I5BPRPCG.js";import{l as Ae}from"./chunk-DFK6U2UW.js";import{c as Le,f as Ge}from"./chunk-K5NGWSTH.js";import{E as ze,F as He,G as Re,a as Te,d as Me,i as K,j as Ie,m as Be,n as Oe,o as ke,r as Ee,s as Ne,t as Fe,u as ee,v as te,w as ie,y as Ve,z as ne}from"./chunk-2RPFGIFO.js";import{h as $}from"./chunk-I6T75M2J.js";import{$a as l,Da as v,F as Z,Fb as X,Gb as Pe,Ha as f,Ia as T,Ka as Y,Kb as he,Lb as ge,Na as _e,Oa as we,Sa as u,Ta as J,U as Q,Ua as x,Va as y,Wa as z,Wb as N,X as Se,Xa as _,Y as D,Ya as w,Za as p,_a as r,ab as c,ba as B,ca as O,da as g,ea as Ce,eb as k,ec as De,gb as M,hb as h,hc as F,j as ve,lb as H,ma as C,mb as R,nb as L,t as W,vb as d,wb as I,xb as U,ya as m,yc as fe,z as q}from"./chunk-EXZ64TUM.js";function Ot(a,e){if(a&1&&(r(0,"option",14),d(1),l()),a&2){let n=e.$implicit;p("value",n),m(),U(" ",n)}}function kt(a,e){if(a&1){let n=k();r(0,"div")(1,"select",13),M("ngModelChange",function(i){B(n);let o=h();return O(o._changePageSize(i))}),_(2,Ot,2,2,"option",14,z),l()()}if(a&2){let n=h();m(),p("ngModel",n.pageSize),m(),w(n._displayedPageSizeOptions)}}function Et(a,e){if(a&1&&(r(0,"div",5),d(1),l()),a&2){let n=h();m(),U("",n.pageSize," ")}}var Nt=50,mt=(()=>{let e=class e{get pageIndex(){return this._pageIndex}set pageIndex(t){this._pageIndex=Math.max($(t),0),this._changeDetectorRef.markForCheck()}get length(){return this._length}set length(t){this._length=$(t),this._changeDetectorRef.markForCheck()}get pageSize(){return this._pageSize}set pageSize(t){this._pageSize=Math.max($(t),0),this._updateDisplayedPageSizeOptions()}get pageSizeOptions(){return this._pageSizeOptions}set pageSizeOptions(t){this._pageSizeOptions=(t||[]).map(i=>$(i)),this._updateDisplayedPageSizeOptions()}constructor(t){this._changeDetectorRef=t,this._pageIndex=0,this._length=0,this._pageSizeOptions=[],this.disabled=!1,this.page=new _e,this.getRangeLabel=(i,o,s)=>{if(s==0||o==0)return`0 of ${s}`;s=Math.max(s,0);let S=i*o,E=S<s?Math.min(S+o,s):S+o;return`${S+1} \u2013 ${E} of ${s}`}}ngOnInit(){this._updateDisplayedPageSizeOptions()}nextPage(){if(!this.hasNextPage())return;let t=this.pageIndex;this.pageIndex++,this._emitPageEvent(t)}previousPage(){if(!this.hasPreviousPage())return;let t=this.pageIndex;this.pageIndex--,this._emitPageEvent(t)}hasPreviousPage(){return this.pageIndex>=1&&this.pageSize!=0}hasNextPage(){let t=this.getNumberOfPages()-1;return this.pageIndex<t&&this.pageSize!=0}getNumberOfPages(){return this.pageSize?Math.ceil(this.length/this.pageSize):0}_nextButtonsDisabled(){return this.disabled||!this.hasNextPage()}_previousButtonsDisabled(){return this.disabled||!this.hasPreviousPage()}_updateDisplayedPageSizeOptions(){this.pageSize||(this._pageSize=this.pageSizeOptions.length!=0?this.pageSizeOptions[0]:Nt),this._displayedPageSizeOptions=this.pageSizeOptions.slice(),this._displayedPageSizeOptions.indexOf(this.pageSize)===-1&&this._displayedPageSizeOptions.push(this.pageSize),this._displayedPageSizeOptions.sort((t,i)=>t-i),this._changeDetectorRef.markForCheck()}_changePageSize(t){let i=this.pageIndex*this.pageSize,o=this.pageIndex;this.pageIndex=Math.floor(i/t)||0,this.pageSize=t,this._emitPageEvent(o)}_emitPageEvent(t){this.page.emit({previousPageIndex:t,pageIndex:this.pageIndex,pageSize:this.pageSize,length:this.length})}};e.\u0275fac=function(i){return new(i||e)(v(N))},e.\u0275cmp=f({type:e,selectors:[["bd2-simple-paginator"]],inputs:{pageIndex:"pageIndex",length:"length",pageSize:"pageSize",pageSizeOptions:"pageSizeOptions",disabled:"disabled"},outputs:{page:"page"},standalone:!1,decls:17,vars:7,consts:[[1,"mat-paginator"],[1,"mat-paginator-outer-container"],[1,"mat-paginator-container"],[1,"mat-paginator-page-size"],[1,"mat-paginator-page-size-label"],[1,"mat-paginator-page-size-value"],[1,"mat-paginator-range-actions"],[1,"mat-paginator-range-label"],["mat-icon-button","","type","button",1,"mat-paginator-navigation-previous",3,"click","disabled"],["viewBox","0 0 24 24","focusable","false",1,"mat-paginator-icon"],["d","M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"],["mat-icon-button","","type","button",1,"mat-paginator-navigation-next",3,"click","disabled"],["d","M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"],["required","",1,"mat-paginator-page-size-select",2,"font-size","12px",3,"ngModelChange","ngModel"],[3,"value"]],template:function(i,o){i&1&&(r(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div",4),d(5," Items per page: "),l(),x(6,kt,4,1,"div"),x(7,Et,2,1,"div",5),l(),r(8,"div",6)(9,"div",7),d(10),l(),r(11,"button",8),M("click",function(){return o.previousPage()}),g(),r(12,"svg",9),c(13,"path",10),l()(),Ce(),r(14,"button",11),M("click",function(){return o.nextPage()}),g(),r(15,"svg",9),c(16,"path",12),l()()()()()()),i&2&&(m(6),y(o._displayedPageSizeOptions.length>1?6:-1),m(),y(o._displayedPageSizeOptions.length<=1?7:-1),m(3),U(" ",o.getRangeLabel(o.pageIndex,o.pageSize,o.length)," "),m(),p("disabled",o._previousButtonsDisabled()),u("aria-label","previous page"),m(3),p("disabled",o._nextButtonsDisabled()),u("aria-label","next page"))},dependencies:[te,ie,ee,K,ne,Be,Le],styles:[".mat-mdc-paginator-icon[_ngcontent-%COMP%]{width:28px;fill:currentColor}.mat-mdc-paginator-range-actions[_ngcontent-%COMP%]{display:flex;align-items:center}.mat-mdc-paginator[_ngcontent-%COMP%]{display:block}.mat-mdc-paginator-outer-container[_ngcontent-%COMP%]{display:flex}.mat-mdc-paginator-container[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:flex-end;min-height:56px;padding:0 8px;flex-wrap:wrap-reverse;width:100%}.mat-mdc-paginator-page-size[_ngcontent-%COMP%]{display:flex;align-items:baseline;margin-right:8px}.mat-mdc-paginator-page-size-label[_ngcontent-%COMP%]{margin:0 4px}.mat-paginator-page-size-select[_ngcontent-%COMP%]{margin:6px 4px 0;width:70px}.mat-mdc-paginator-range-label[_ngcontent-%COMP%]{margin:0 32px 0 24px}"],changeDetection:0});let a=e;return a})();var Vt=()=>[10,25,50,100,200,500];function zt(a,e){if(a&1&&(r(0,"option",16),d(1),l()),a&2){let n=e.$implicit;p("value",n.name),m(),I(n.label)}}function Ht(a,e){if(a&1&&(r(0,"option",16),d(1),l()),a&2){let n=e.$implicit;p("value",n.name),m(),I(n.label)}}function Rt(a,e){if(a&1&&(r(0,"option",16),d(1),l()),a&2){let n=e.$implicit;p("value",n.name),m(),I(n.label)}}var ct=(()=>{let e=class e extends Xe{constructor(t){super(t),this.alignOptions=[new ue("NONE","none"),new ue("MEAN","mean")];let i=this.normalisationOptions.find(o=>o.name==="RANGE");this.displayParamsForm.get("normalisation").setValue(i?.name),this.displayParamsForm.get("hourly").setValue(!0)}};e.\u0275fac=function(i){return new(i||e)(v(ze))},e.\u0275cmp=f({type:e,selectors:[["bd2-heatmap-display-params-rform"]],inputs:{disabled:"disabled",totalTraces:"totalTraces",currentPage:"currentPage"},outputs:{displayParams:"displayParams"},standalone:!1,features:[Y],decls:49,vars:7,consts:[["dataPaginator",""],["role","form",1,"form-horizontal","container",3,"formGroup"],[1,"row"],[1,"col-md-8","col-sm-10"],["formGroupName","timeScale",1,"form-group","row"],[1,"col-md-3","col-sm-3"],["for","timeStart",1,"col-md-1","col-sm-2"],["type","number","step","any","min","0","size","5","id","timeStart","required","","formControlName","timeStart",1,"form-control"],["for","timeEnd",1,"col-md-1","col-sm-1"],["type","number","step","any","min","0","size","5","required","","id","timeEnd","formControlName","timeEnd",1,"form-control"],[1,"col-md-2","col-sm-4"],["formControlName","hourly",1,"mr-3"],[1,"form-group","row"],["for","detrending",1,"col-sm-2"],[1,"col-sm-3"],["required","","id","detrending","formControlName","detrending",1,"form-control"],[3,"value"],[1,"col-sm-1"],["for","align",1,"col-sm-1"],["required","","id","align","formControlName","align",1,"form-control"],[1,"col-sm-2"],["for","normalisation"],["required","","id","normalisation","formControlName","normalisation",1,"form-control"],[1,"col-sm"],["formControlName","trimFirst",1,"mr-3"],["formControlName","log2"],[1,"col-sm-8"],[3,"page","length","disabled","pageSize","pageIndex","pageSizeOptions"]],template:function(i,o){if(i&1){let s=k();r(0,"form",1)(1,"div",2)(2,"div",3)(3,"div",4)(4,"label",5),d(5,"Time range"),l(),r(6,"label",6),d(7,"from:"),l(),r(8,"div",5),c(9,"input",7),l(),r(10,"label",8),d(11,"to:"),l(),r(12,"div",5),c(13,"input",9),l()()(),r(14,"div",10)(15,"mat-slide-toggle",11),d(16,"hourly"),l()()(),r(17,"div",12)(18,"label",13),d(19,"Detrending"),l(),r(20,"div",14)(21,"select",15),_(22,zt,2,2,"option",16,z),l()(),c(24,"div",17),r(25,"label",18),d(26,"Align"),l(),r(27,"div",14)(28,"select",19),_(29,Ht,2,2,"option",16,z),l()()(),r(31,"div",12)(32,"div",20)(33,"label",21),d(34,"Normalize"),l()(),r(35,"div",14)(36,"select",22),_(37,Rt,2,2,"option",16,z),l()(),r(39,"div",23)(40,"mat-slide-toggle",24),d(41,"within range"),l(),r(42,"mat-slide-toggle",25),d(43,"log2 transf."),l()()(),r(44,"div",12),c(45,"label",20),r(46,"div",26)(47,"bd2-simple-paginator",27,0),M("page",function(E){return B(s),O(o.loadDataPage(E))}),l()()()()}i&2&&(p("formGroup",o.mainForm),m(22),w(o.detrendingOptions),m(7),w(o.alignOptions),m(8),w(o.normalisationOptions),m(10),p("length",o.totalTraces)("disabled",o.disabledPagination)("pageSize",o.currentPage.pageSize)("pageIndex",o.currentPage.pageIndex)("pageSizeOptions",Pe(6,Vt)))},dependencies:[Oe,te,ie,Me,ke,ee,K,Ie,ne,Ve,Ee,Fe,Ne,je,mt],encapsulation:2});let a=e;return a})();var se=class{constructor(){this.vMargin=25,this.hMargin=20,this.smallRowWidth=6,this.midRowWidth=12,this.bigRowWidth=25,this.rowGap=.05}},le=class{},me=class{constructor(e=0,n=0,t=void 0,i=!1,o=!1){this.x=e,this.y=n,this.label=t,this.top=i,this.left=o}},P=class{constructor(e,n,t,i){this.x=e,this.y=n,this.left=t,this.right=i,this.width=i-t}},ce=class{};var V=(()=>{let e=class e{constructor(){this.request$=new ve}showTooltip(t,i,o){this.request$.next([!0,t,i,o])}hideTooltip(t,i){this.request$.next([!1,void 0,t,i])}ngOnDestroy(){this.request$.complete()}};e.\u0275fac=function(i){return new(i||e)},e.\u0275prov=Se({token:e,factory:e.\u0275fac});let a=e;return a})();var pe=class{seriesToBoxes(e,n=!1){return e.map(t=>this.serieToBoxes(t,n))}serieToBoxes(e,n=!1){let t=Object.assign(new ce,e);return t.data=n?this.pointsToAsymBoxes(e.data):this.pointsToSymBoxes(e.data),t}pointsToAsymBoxes(e,n=.5){if(!e||e.length===0)return[];if(e.length===1){let s=e[0];return[new P(s.x,s.y,s.x-n,s.x+n)]}let t=[],i=e[0];t.push(new P(i.x,i.y,(3*i.x-e[1].x)/2,(i.x+e[1].x)/2));for(let s=1;s<e.length-1;s++)t.push(this.asymBoxFromPoints(e[s],e[s-1],e[s+1]));let o=e[e.length-1];return t.push(new P(o.x,o.y,(e[e.length-2].x+o.x)/2,(3*o.x-e[e.length-2].x)/2)),t}asymBoxFromPoints(e,n,t){return new P(e.x,e.y,(n.x+e.x)/2,(e.x+t.x)/2)}pointsToSymBoxes(e,n=.5){if(!e||e.length===0)return[];if(e.length===1){let s=e[0];return[new P(s.x,s.y,s.x-n,s.x+n)]}let t=[],i=e[0];t.push(new P(i.x,i.y,(3*i.x-e[1].x)/2,(i.x+e[1].x)/2));for(let s=1;s<e.length-1;s++)t.push(this.symBoxFromPoints(e[s],e[s-1],e[s+1]));let o=e[e.length-1];return t.push(new P(o.x,o.y,(e[e.length-2].x+o.x)/2,(3*o.x-e[e.length-2].x)/2)),t}symBoxFromPoints(e,n,t){let i=e.x-n.x,o=t.x-e.x,s=Math.min(i,o)/2;return new P(e.x,e.y,e.x-s,e.x+s)}};function pt(a="#d62728",e="white",n="#1f77b4",t=.1){let i=re().domain([-1,0,1]).range([A(a),A(e),A(n)]);return at(-1,1+t,t).map(S=>A(i(S)).hex())}var de=class{prepareGraphicContext(e,n,t=!1){let i=new le;return this.calculateDimensions(i,e,n),this.addPaneAttributes(i,n),this.addScales(i,e,n,t),this.addFormatters(i,e),i.labelsColors=this.labelsColors(e),i}calculateDimensions(e,n,t){e.pWidth=500,e.workspaceWidth=e.pWidth-3*t.hMargin,e.workspaceHeight=this.calculateWorkspaceHeight(n,t),e.pHeight=e.workspaceHeight+2*t.vMargin}calculateWorkspaceHeight(e,n){return e.length<=25?e.length*n.bigRowWidth:e.length<=100?e.length*n.midRowWidth:e.length*n.smallRowWidth}addPaneAttributes(e,n){e.viewBox=`0 0 500 ${e.pHeight}`,e.mainPaneTransform=`translate(${2*n.hMargin}, ${n.vMargin})`}addScales(e,n,t,i){let o=this.timeDomain(n);e.xDomain=o;let s=this.timeMargin(n,o);o=[o[0]-s,o[1]+s],e.xScale=re().clamp(!0).domain(o).range([0,e.workspaceWidth]);let S=n.map(E=>E.key);e.yDomain=S,e.yScale=ot().paddingInner(t.rowGap).paddingOuter(0).domain(S).range([0,e.workspaceHeight]),e.colorScale=this.heatmapScale(n,i)}addFormatters(e,n){let t=this.timeDomain(n);e.domainFormatter=this.formatForDomain(t);let i=this.valuesRange(n);e.valuesFormatter=this.formatForDomain(i)}timeMargin(e,n){let t=n[0],i=.5;return e.filter(o=>o.data&&o.data.length>0&&o.data[0].x===t).forEach(o=>{let s=o.data[0];s instanceof P&&(i=Math.max(i,s.x-s.left))}),i}timeDomain(e){let n=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY;return e.forEach(i=>{i.data&&i.data.length>0&&(n=Math.min(n,i.data[0].x),t=Math.max(t,i.data[i.data.length-1].x))}),n=isFinite(n)?n:0,t=isFinite(t)?t:1,[n,t]}heatmapScale(e,n){let t=this.valuesRange(e);if(n){let o=Math.max(Math.abs(t[0]),Math.abs(t[1]));t=[-o,o]}let i=pt();return rt().domain(t).range(i)}valuesRange(e){if(e.length===0)return[NaN,NaN];let n=e[0].min,t=e[0].max;return e.forEach(i=>{n=Math.min(n,i.min),t=Math.max(t,i.max)}),[n,t]}formatForDomain([e,n]){let t=n-e;return t<1?j(".2~e"):t<100?j(".2~f"):t<1e5?j("d"):j(".2~e")}labelsColors(e){let n=e.length;return function(t){return st(t/n)}}};var Gt=["text"],$t=["bd2hm-label-box",""];function At(a,e){if(a&1&&(g(),r(0,"text",2),d(1),l()),a&2){let n=h(2);u("y",n.yMiddle)("font-size",n.fontSize()),m(),I(n.serie.label)}}function jt(a,e){if(a&1){let n=k();g(),r(0,"g",1),x(1,At,2,3,":svg:text",2),r(2,"g",3),M("mouseout",function(){B(n);let i=h();return O(i.toggleLabel(!1))})("mouseover",function(){B(n);let i=h();return O(i.toggleLabel(!0))}),c(3,"rect",4),r(4,"g",5),c(5,"rect",6),r(6,"text",7,0),d(8),l()()()()}if(a&2){let n=h();m(),y(n.alwaysOn?1:-1),m(2),u("y",n.triggerY)("height",n.triggerHeight)("fill",n.color),m(),u("opacity",n.ready?1:0)("display",n.toggled?void 0:"none"),m(),u("width",n.textBWidth)("y",n.textBY)("height",n.textBHeight),m(),u("y",n.yMiddle),m(2),I(n.serie.label)}}var dt=(()=>{let e=class e{constructor(t){this.changeDetector=t,this.alwaysOn=!0,this.color="rgb(67, 125, 179)",this.textBWidth=0,this.textBY=0,this.toggled=!1,this.ready=!1}ngOnInit(){}ngOnChanges(t){this.margin=this.marginSize(),this.triggerY=this.yStart+this.margin,this.triggerHeight=this.margin>1?this.maxHeight-2*this.margin:this.maxHeight-1,this.yMiddle=this.yStart+this.maxHeight/2}marginSize(){return this.maxHeight>=20?4:this.maxHeight>=12?2:1}fontSize(){return this.maxHeight>12?10:this.maxHeight>=6?this.maxHeight-3:0}toggleLabel(t){t===void 0&&(t=!this.toggled),this.ready=!1,this.toggled=t,this.toggled&&this.updateTextBBox().subscribe(i=>{this.toggled&&(this.ready=!0),this.changeDetector.markForCheck()})}updateTextBBox(){return q(0).pipe(W(t=>this.textBBox()),Q(t=>this.setTextBBox(t)))}setTextBBox(t){this.textBY=t.y-4,this.textBHeight=t.height+8,this.textBWidth=t.x+t.width+4}textBBox(){return this.textNode?this.textNode.nativeElement.getBBox():{x:0,y:0,height:0,width:0}}};e.\u0275fac=function(i){return new(i||e)(v(N))},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-label-box",""]],viewQuery:function(i,o){if(i&1&&H(Gt,5),i&2){let s;R(s=L())&&(o.textNode=s.first)}},inputs:{serie:"serie",yStart:"yStart",maxHeight:"maxHeight",alwaysOn:"alwaysOn",color:"color"},standalone:!1,features:[C],attrs:$t,decls:1,vars:1,consts:[["text",""],[1,"bd2hm-label"],["x","5",1,"bd2hm-onLabel"],[3,"mouseout","mouseover"],["x","-7","width","7"],[1,"bd2hm-hover"],["x","0"],["x","5"]],template:function(i,o){i&1&&x(0,jt,9,11,":svg:g",1),i&2&&y(o.serie?0:-1)},encapsulation:2,changeDetection:0});let a=e;return a})();var qt=["bd2hm-labels",""];function Zt(a,e){if(a&1&&(g(),c(0,"g",1)),a&2){let n=e.$implicit,t=h(2);p("serie",n)("yStart",t.yStart(n))("maxHeight",t.maxHeight())("alwaysOn",t.alwaysOn)}}function Qt(a,e){if(a&1&&(g(),r(0,"g",0),_(1,Zt,1,4,":svg:g",1,J().trackByIndex,!0),l()),a&2){let n=h();m(),w(n.data)}}var ht=(()=>{let e=class e{constructor(){this.alwaysOn=!0}trackByIndex(t,i){return t}ngOnInit(){}yStart(t){return this.graphic.yScale(t.key)}maxHeight(){return this.graphic.yScale.bandwidth()}color(t){return this.graphic.labelsColors(t)}};e.\u0275fac=function(i){return new(i||e)},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-labels",""]],inputs:{graphic:"graphic",data:"data",alwaysOn:"alwaysOn"},standalone:!1,attrs:qt,decls:1,vars:1,consts:[[1,"bd2hm-labels"],["bd2hm-label-box","",3,"serie","yStart","maxHeight","alwaysOn"]],template:function(i,o){i&1&&x(0,Qt,3,0,":svg:g",0),i&2&&y(o.graphic&&o.data?0:-1)},dependencies:[dt],encapsulation:2,changeDetection:0});let a=e;return a})();var Jt=["text"],Ut=["bd2hm-tooltip",""];function Xt(a,e){if(a&1&&(g(),r(0,"g",1)(1,"g"),c(2,"rect"),r(3,"text",null,0)(5,"tspan",2),d(6),l(),r(7,"tspan",3),d(8),l()()()()),a&2){let n=h();u("display",n.show?void 0:"none")("transform",n.position),m(),u("opacity",n.ready?1:0),m(),u("x",n.textBX)("width",n.textBWidth)("y",n.textBY)("height",n.textBHeight),m(4),I(n.label),m(2),I(n.values)}}var gt=(()=>{let e=class e{constructor(t,i){this.tooltip=t,this.changeDetector=i,this.boxMargin=4,this.show=!1,this.ready=!1}ngOnInit(){this.subscription=this.tooltip.request$.pipe(Z(100)).subscribe(t=>this.handleRequest(t))}ngOnDestroy(){this.subscription&&this.subscription.unsubscribe()}handleRequest([t,i,o,s]){t?this.showTooltip(i,o,s):this.hideTooltip(o,s)}showTooltip(t,i,o){this.ready=!1,this.label=this.formatLabel(t),this.values=this.formatValues(i),this.show=!0,this.changeDetector.detectChanges(),this.updateTextBBox().subscribe(s=>{this.show&&(this.position=this.translateToDataLocation(o,this.textBWidth,this.graphic.workspaceWidth),this.ready=!0),this.changeDetector.detectChanges()})}translateToDataLocation(t,i,o){let s=t.x+t.width+2*this.boxMargin;s+i>=o&&(s=t.x-i);let S=t.y;return`translate(${s}, ${S})`}hideTooltip(t,i){this.show=!1,this.changeDetector.detectChanges()}formatValues(t){return`${this.graphic.domainFormatter(t.x)} : ${this.graphic.valuesFormatter(t.y)}`}updateTextBBox(){return q(0).pipe(W(t=>this.textBBox()),Q(t=>this.setTextBBox(t)))}setTextBBox(t){this.textBX=t.x-this.boxMargin,this.textBY=t.y-this.boxMargin,this.textBHeight=t.height+2*this.boxMargin,this.textBWidth=t.width+2*this.boxMargin}textBBox(){return this.textNode?this.textNode.nativeElement.getBBox():{x:0,y:0,height:0,width:0}}formatLabel(t){return t?t.length<40?t:t.substring(0,38)+"...":""}};e.\u0275fac=function(i){return new(i||e)(v(V),v(N))},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-tooltip",""]],viewQuery:function(i,o){if(i&1&&H(Jt,5),i&2){let s;R(s=L())&&(o.textNode=s.first)}},inputs:{graphic:"graphic",boxMargin:"boxMargin"},standalone:!1,attrs:Ut,decls:1,vars:1,consts:[["text",""],[1,"bd2hm-tooltipBox"],["x","0"],["x","0","dy","1.2em"]],template:function(i,o){i&1&&x(0,Xt,9,9,":svg:g",1),i&2&&y(o.graphic?0:-1)},encapsulation:2,changeDetection:0});let a=e;return a})();var ei=["bd2hm-pane-back",""],ft=(()=>{let e=class e{constructor(){this.margin=2}ngOnInit(){}ngOnChanges(t){this.width=this.graphic.workspaceWidth-2*this.margin,this.height=this.graphic.workspaceHeight-2*this.margin,this.width<0&&(this.width=0),this.height<0&&(this.height=0)}};e.\u0275fac=function(i){return new(i||e)},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-pane-back",""]],inputs:{graphic:"graphic",margin:"margin"},standalone:!1,features:[C],attrs:ei,decls:1,vars:4,consts:[[1,"bd2hm-dataBackground"]],template:function(i,o){i&1&&(g(),c(0,"rect",0)),i&2&&u("x",o.margin)("y",o.margin)("width",o.width)("height",o.height)},encapsulation:2,changeDetection:0});let a=e;return a})();var ii=["box"],ni=["bd2hm-data-point-box",""];function ai(a,e){if(a&1&&(g(),c(0,"rect",null,0)),a&2){let n=h();u("x",n.xPosition)("y",n.yPosition)("width",n.xWidth)("height",n.yHeight)("fill",n.colorScale(n.point.y))("stroke",n.colorScale(n.point.y))}}var ut=(()=>{let e=class e{constructor(t,i){this.tooltip=t,this.zone=i}ngOnChanges(t){if(this.xScale&&this.point){this.xPosition=this.xScale(this.point.left);let i=this.xScale(this.point.right)-this.xScale(this.point.left);this.xWidth=i>=2?i-1:1}}ngAfterViewInit(){this.boxNode&&this.prevBoxNode!==this.boxNode&&(this.removeMouseListeners(this.prevBoxNode),this.zone.runOutsideAngular(()=>{this.addMouseListeners(this.boxNode)}),this.prevBoxNode=this.boxNode)}ngOnInit(){}ngOnDestroy(){this.removeMouseListeners(this.boxNode)}addMouseListeners(t){t&&(t.nativeElement.addEventListener("mouseover",this.showTooltip.bind(this)),t.nativeElement.addEventListener("mouseout",this.hideTooltip.bind(this)))}removeMouseListeners(t){t&&(t.nativeElement.removeEventListener("mouseover",this.showTooltip),t.nativeElement.removeEventListener("mouseout",this.hideTooltip))}hideTooltip(t){let i={x:this.xPosition,y:this.yPosition,width:this.xWidth};this.tooltip.hideTooltip(this.point,i)}showTooltip(t){let i={x:this.xPosition,y:this.yPosition,width:this.xWidth};this.tooltip.showTooltip(this.label,this.point,i)}};e.\u0275fac=function(i){return new(i||e)(v(V),v(we))},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-data-point-box",""]],viewQuery:function(i,o){if(i&1&&H(ii,5),i&2){let s;R(s=L())&&(o.boxNode=s.first)}},inputs:{point:"point",yPosition:"yPosition",yHeight:"yHeight",xScale:"xScale",colorScale:"colorScale",label:"label"},standalone:!1,features:[C],attrs:ni,decls:1,vars:1,consts:[["box",""]],template:function(i,o){i&1&&x(0,ai,2,6,":svg:rect"),i&2&&y(o.point&&o.xScale?0:-1)},encapsulation:2,changeDetection:0});let a=e;return a})();var ri=["bd2hm-serie-row",""];function si(a,e){if(a&1&&(g(),c(0,"g",1)),a&2){let n=e.$implicit,t=h(2);p("point",n)("xScale",t.graphic.xScale)("yPosition",t.yPosition)("yHeight",t.yHeight)("colorScale",t.graphic.colorScale)("label",t.serie.label)}}function li(a,e){if(a&1&&(g(),r(0,"g",0),_(1,si,1,6,":svg:g",1,J().trackByIndex,!0),l()),a&2){let n=h();m(),w(n.serie.data)}}var xt=(()=>{let e=class e{constructor(){}trackByIndex(t,i){return t}ngOnInit(){}ngOnChanges(t){this.graphic&&this.serie&&(this.yPosition=this.graphic.yScale(this.serie.key),this.yHeight=this.graphic.yScale.bandwidth())}};e.\u0275fac=function(i){return new(i||e)},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-serie-row",""]],inputs:{graphic:"graphic",serie:"serie"},standalone:!1,features:[C],attrs:ri,decls:1,vars:1,consts:[[1,"bd2hm-serie"],["bd2hm-data-point-box","",3,"point","xScale","yPosition","yHeight","colorScale","label"]],template:function(i,o){i&1&&x(0,li,3,0,":svg:g",0),i&2&&y(o.graphic&&o.serie?0:-1)},dependencies:[ut],encapsulation:2,changeDetection:0});let a=e;return a})();var ci=["bd2hm-series-box",""];function pi(a,e){if(a&1&&(g(),c(0,"g",0)),a&2){let n=e.$implicit,t=h();p("graphic",t.graphic)("serie",n)}}var yt=(()=>{let e=class e{constructor(){}trackByIndex(t,i){return t}ngOnInit(){}};e.\u0275fac=function(i){return new(i||e)},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-series-box",""]],inputs:{series:"series",graphic:"graphic"},standalone:!1,attrs:ci,decls:2,vars:0,consts:[["bd2hm-serie-row","",3,"graphic","serie"]],template:function(i,o){i&1&&_(0,pi,1,2,":svg:g",0,o.trackByIndex,!0),i&2&&w(o.series)},dependencies:[xt],encapsulation:2,changeDetection:0});let a=e;return a})();var hi=["bd2hm-vtick-mark",""];function gi(a,e){if(a&1&&(g(),c(0,"line",0)),a&2){let n=h();u("x1",n.tick.x)("x2",n.tick.x)("y2",n.marky2)}}function fi(a,e){if(a&1&&(g(),r(0,"text"),d(1),l()),a&2){let n=h();u("x",n.tick.x)("y",n.texty2)("dy",n.textdy),m(),I(n.tick.label)}}var bt=(()=>{let e=class e{constructor(){this.length=5}ngOnInit(){this.calculatePositions()}ngOnChanges(t){this.calculatePositions()}calculatePositions(){this.marky2=this.tick?.top?-this.length:this.length,this.texty2=this.tick?.top?-(this.length+4):this.length+4,this.textdy=this.tick?.top?0:"0.6em"}};e.\u0275fac=function(i){return new(i||e)},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-vtick-mark",""]],inputs:{tick:"tick",length:"length"},standalone:!1,features:[C],attrs:hi,decls:2,vars:2,consts:[["y1","0"]],template:function(i,o){i&1&&(x(0,gi,1,3,":svg:line",0),x(1,fi,2,4,":svg:text")),i&2&&(y(o.tick?0:-1),m(),y(o.tick?1:-1))},encapsulation:2});let a=e;return a})();var xi=["bd2hm-num-x-axis",""];function yi(a,e){if(a&1&&(g(),c(0,"g",2)),a&2){let n=e.$implicit;p("tick",n)}}var vt=(()=>{let e=class e{constructor(){this.top=!1,this.ticks=[]}trackByIndex(t,i){return t}ngOnInit(){}ngOnChanges(t){this.axisTransform=`translate(0,${this.yPosition})`,this.x2=this.xScale?.range()[1],this.ticks=this.prepareTicks(this.xScale)}prepareTicks(t){return this.calculateTicksPosition(t).map(o=>new me(t(o),0,o,this.top,!1))}calculateTicksPosition(t){if(!t)return[];let i=[],o=this.xDomain||t.domain(),s=Math.round(o[0]),S=Math.round(o[1]),E=this.domainStep(S-s);for(let G=s;G<=S;G+=E)i.push(G);return i}domainStep(t){return t<=25?4:t<=73?6:t<=169?12:24}};e.\u0275fac=function(i){return new(i||e)},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-num-x-axis",""]],inputs:{xScale:"xScale",xDomain:"xDomain",yPosition:"yPosition",top:"top"},standalone:!1,features:[C],attrs:xi,decls:4,vars:2,consts:[[1,"bd2hm-x-axis"],["x1","0","y1","0","y2","0"],["bd2hm-vtick-mark","",1,"bd2hm-tickMark",3,"tick"]],template:function(i,o){i&1&&(g(),r(0,"g",0),c(1,"line",1),_(2,yi,1,1,":svg:g",2,o.trackByIndex,!0),l()),i&2&&(u("transform",o.axisTransform),m(),u("x2",o.x2),m(),w(o.ticks))},dependencies:[bt],encapsulation:2,changeDetection:0});let a=e;return a})();var vi=["bd2hm-y-axis",""],St=(()=>{let e=class e{constructor(){this.left=!1}ngOnInit(){}ngOnChanges(t){this.axisTransform=`translate(${this.xPosition},0)`,this.y2=this.yScale?.range()[1]}};e.\u0275fac=function(i){return new(i||e)},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-y-axis",""]],inputs:{yScale:"yScale",xPosition:"xPosition",left:"left"},standalone:!1,features:[C],attrs:vi,decls:2,vars:2,consts:[[1,"bd2hm-y-axis"],["x1","0","y1","0","x2","0"]],template:function(i,o){i&1&&(g(),r(0,"g",0),c(1,"line",1),l()),i&2&&(u("transform",o.axisTransform),m(),u("y2",o.y2))},encapsulation:2,changeDetection:0});let a=e;return a})();var Ci=["bd2hm-axis-box",""];function _i(a,e){if(a&1&&(g(),r(0,"g",0),c(1,"g",1)(2,"g",2)(3,"g",3)(4,"g",4),l()),a&2){let n=h();m(),p("top",!0)("xScale",n.graphic.xScale)("yPosition",0)("xDomain",n.graphic.xDomain),m(),p("top",!1)("xScale",n.graphic.xScale)("yPosition",n.graphic.workspaceHeight)("xDomain",n.graphic.xDomain),m(),p("left",!0)("yScale",n.graphic.yScale)("xPosition",0),m(),p("left",!1)("yScale",n.graphic.yScale)("xPosition",n.graphic.workspaceWidth)}}var Ct=(()=>{let e=class e{constructor(){}ngOnInit(){}};e.\u0275fac=function(i){return new(i||e)},e.\u0275cmp=f({type:e,selectors:[["","bd2hm-axis-box",""]],inputs:{graphic:"graphic"},standalone:!1,attrs:Ci,decls:1,vars:1,consts:[[1,"bd2hm-axisWrapper"],["bd2hm-num-x-axis","",1,"xTopAxis",3,"top","xScale","yPosition","xDomain"],["bd2hm-num-x-axis","",1,"xBottomAxis",3,"top","xScale","yPosition","xDomain"],["bd2hm-y-axis","",1,"yLeftAxis",3,"left","yScale","xPosition"],["bd2hm-y-axis","",1,"yRightAxis",3,"left","yScale","xPosition"]],template:function(i,o){i&1&&x(0,_i,5,14,":svg:g",0),i&2&&y(o.graphic?0:-1)},dependencies:[vt,St],encapsulation:2,changeDetection:0});let a=e;return a})();function Pi(a,e){if(a&1&&(g(),r(0,"svg",1)(1,"defs")(2,"filter",2),c(3,"feDropShadow",3),l(),r(4,"pattern",4),c(5,"line",5),l()(),r(6,"g",6),c(7,"g",7)(8,"g",8)(9,"g",9)(10,"g",10)(11,"g",11),l()()),a&2){let n=h();u("viewBox",n.graphic.viewBox),m(6),u("transform",n.graphic.mainPaneTransform),m(),p("graphic",n.graphic),m(),p("graphic",n.graphic),m(),p("graphic",n.graphic)("series",n.series),m(),p("graphic",n.graphic)("data",n.series)("alwaysOn",n.labelsAlwaysOn),m(),p("graphic",n.graphic)}}var _t=(()=>{let e=class e{constructor(t,i){this.changeDetector=t,this.tooltip=i,this.asymmetric=!1,this.middleZero=!1,this.hidden=!1,this.labelsAlwaysOn=!0,this.lookAndFeel=new se,this.heatmapDataUtil=new pe,this.heatmapGraphUtil=new de}ngOnInit(){}ngOnDestroy(){this.tooltip&&this.tooltip.ngOnDestroy()}ngOnChanges(t){this.data&&this.data.length>0?(this.series=this.heatmapDataUtil.seriesToBoxes(this.data,this.asymmetric),this.graphic=this.heatmapGraphUtil.prepareGraphicContext(this.series,this.lookAndFeel,this.middleZero)):(this.graphic=void 0,this.series=void 0)}};e.\u0275fac=function(i){return new(i||e)(v(N),v(V))},e.\u0275cmp=f({type:e,selectors:[["bd2-num-heatmap"]],inputs:{data:"data",asymmetric:"asymmetric",middleZero:"middleZero",hidden:"hidden",labelsAlwaysOn:"labelsAlwaysOn",lookAndFeel:"lookAndFeel"},standalone:!1,features:[X([V]),C],decls:2,vars:2,consts:[[1,"bd2hm-heatmap",3,"hidden"],["width","100%"],["id","bd2hm-shadow"],["dx","1","dy","1","stdDeviation","1"],["id","bd2hm-pattern-diagonal","width","10","height","10","patternTransform","rotate(45 0 0)","patternUnits","userSpaceOnUse"],["x1","0","y1","0","x2","0","y2","10",2,"stroke","lightgrey","stroke-width","1"],[1,"bd2hm-mainPane"],["bd2hm-pane-back","",1,"bd2hm-paneBack",3,"graphic"],["bd2hm-axis-box","",3,"graphic"],["bd2hm-series-box","",1,"bd2hm-seriesBox",3,"graphic","series"],["bd2hm-labels","",3,"graphic","data","alwaysOn"],["bd2hm-tooltip","",3,"graphic"]],template:function(i,o){i&1&&(r(0,"div",0),x(1,Pi,12,10,":svg:svg",1),l()),i&2&&(p("hidden",o.hidden),m(),y(o.graphic?1:-1))},dependencies:[ht,gt,ft,yt,Ct],styles:[".bd2hm-paneBack rect{fill:url(#bd2hm-pattern-diagonal)}  .bd2hm-axisWrapper line{stroke:gray}  .bd2hm-axisWrapper text{fill:gray;text-anchor:middle;font-size:9px}  .bd2hm-labels text.bd2hm-onLabel{dominant-baseline:central;fill:#000;opacity:.6}  .bd2hm-labels .bd2hm-hover text{dominant-baseline:central;fill:#fff;font-size:10px}  .bd2hm-labels .bd2hm-hover rect{fill:#000;opacity:.8;filter:url(#bd2hm-shadow)}  .bd2hm-tooltipBox text{font-size:10px;fill:#fff}  .bd2hm-tooltipBox rect{fill:#000;opacity:.8;filter:url(#bd2hm-shadow)}"],changeDetection:0});let a=e;return a})();var wt=(()=>{let e=class e{set traces(t){this.series=t}constructor(){this.middleZero=!1}ngOnInit(){}};e.\u0275fac=function(i){return new(i||e)},e.\u0275cmp=f({type:e,selectors:[["bd2-heatmap-plot"]],inputs:{traces:"traces",middleZero:"middleZero"},standalone:!1,decls:2,vars:2,consts:[[2,"text-align","center"],[3,"data","middleZero"]],template:function(i,o){i&1&&(r(0,"div",0),c(1,"bd2-num-heatmap",1),l()),i&2&&(m(),p("data",o.series)("middleZero",o.middleZero))},dependencies:[_t],encapsulation:2});let a=e;return a})();function Mi(a,e){if(a&1){let n=k();r(0,"div",3)(1,"label",5)(2,"a",6),M("click",function(){B(n);let i=h(2);return O(i.exportDataView())}),r(3,"i",7),d(4,"save_alt"),l(),r(5,"span",8),d(6,"Download"),l()(),d(7," current view "),l(),r(8,"label",5)(9,"a",9),M("click",function(){B(n);let i=h(2);return O(i.exportFullData())}),r(10,"i",7),d(11,"save_alt"),l(),r(12,"span",8),d(13,"Download"),l()(),d(14," full "),l()()}}function Ii(a,e){if(a&1&&c(0,"bd2-heatmap-plot",4),a&2){let n=h(2);p("traces",n.timeseries)("middleZero",n.middleZero)}}function Bi(a,e){if(a&1){let n=k();r(0,"div")(1,"h3"),d(2,"Data heatmap"),l(),c(3,"hr"),r(4,"bd2-heatmap-display-params-rform",0),M("displayParams",function(i){B(n);let o=h();return O(o.displayChanged(i))}),l(),r(5,"mat-expansion-panel")(6,"mat-expansion-panel-header")(7,"mat-panel-title"),d(8," Sorting "),l()(),c(9,"bd2-tssort-params-rform",1),he(10,"async"),he(11,"async"),l(),c(12,"hr"),r(13,"div",2),x(14,Mi,15,0,"div",3),l(),c(15,"hr"),x(16,Ii,1,2,"bd2-heatmap-plot",4),l()}if(a&2){let n=h();m(4),p("disabled",n.disabledSecondary)("totalTraces",n.totalTraces)("currentPage",n.currentPage),m(5),p("ppaJobs",ge(10,7,n.analysis.ppaJobs$))("rhythmJobs",ge(11,9,n.analysis.rhythmJobs$)),m(5),y(n.timeseries?14:-1),m(2),y(n.timeseries?16:-1)}}var Pt=(()=>{let e=class e extends Qe{constructor(t,i,o,s,S){super(S),this.analysis=t,this.fetcher=i,this.RDMSocial=o,this.analytics=s,this.timeseries=[],this.totalTraces=0,this.currentPage=Ye.firstPage(),this.tracesPerPlot=5,this.middleZero=!1,this.blocked=!1,this.disabledSecondary=!1,this.csvExporter=new Je,t.allowedPPAMethods=["NLLS","MESA"],i.addTraceNr=!0,i.addTraceRef=!1,this.titlePart=" Data"}ngOnInit(){super.ngOnInit(),this.timeSeriesSubsripction=this.fetcher.seriesPackStream.pipe(Z(1e3)).subscribe(t=>{if(!this.assay)return;let i=t.data;this.currentParams=t.params,this.middleZero=this.isRangeSimetrical(t.params),this.timeseries=i,this.tracesPerPlot=Math.max(5,i.length/20),this.totalTraces=t.totalTraces,this.currentPage=t.currentPage,this.analytics.experimentHeatmapView(this.assay.id)},t=>{console.log("Error in TS subscription: "+t),this.feedback.error(t)}),this.fetcher.error$.subscribe(t=>this.feedback.error(t))}ngOnDestroy(){this.timeSeriesSubsripction&&this.timeSeriesSubsripction.unsubscribe(),this.fetcher.ngOnDestroy(),super.ngOnDestroy()}displayChanged(t){this.fetcher.changeDisplayParams(t)}exportDataView(){let t=this.fetcher.current;this.exportSeriesPack(t)}exportFullData(){this.fetcher.getFullDataSet(this.assay,this.fetcher.current.params,this.fetcher.current.sorting).subscribe(t=>{this.exportSeriesPack(t,!0)})}exportSeriesPack(t,i=!1){if(!t)return;let o=this.csvExporter.renderCSVTable(t.data,t.params,t.currentPage,t.sorting,this.assay),s=new Blob([o],{type:"text/csv"}),S=i?".full":`.page${t.currentPage.pageIndex+1}`,G={fileName:`${this.assay.id}_data.${t.params.detrending.name}${S}.csv`,extensions:[".csv"]};Ue(s,G).then(be=>{this.recordExport()}).catch(be=>console.log("could not save export",be))}recordExport(){this.analytics.experimentDataExport(this.assay.id)}updateModel(t){super.updateModel(t),this.RDMSocial.canProceedByMeasurement(t).then(i=>{i?this.disabledSecondary=!1:this.disabledSecondary=!0}),this.fetcher.experiment(t),this.analysis.experiment(t)}isRangeSimetrical(t){return t.normalisation==="RANGE"||t.normalisation==="Z_SCORE"||t.align==="MEAN"}};e.\u0275fac=function(i){return new(i||e)(v(oe),v(ae),v(Ze),v(Te),v(qe))},e.\u0275cmp=f({type:e,selectors:[["bd2-ts-heatmap-view"]],standalone:!1,features:[X([ae,oe]),Y],decls:1,vars:1,consts:[[3,"displayParams","disabled","totalTraces","currentPage"],[3,"ppaJobs","rhythmJobs"],[1,"clearfix"],[1,"float-right"],[3,"traces","middleZero"],[1,"mr-4"],["download","","role","button","aria-label","download",1,"btn","btn-primary",2,"color","white",3,"click"],[1,"material-icons","bd-icon"],[1,"cdk-visually-hidden"],["download","","role","button","aria-label","download whole",1,"btn","btn-primary",2,"color","white",3,"click"]],template:function(i,o){i&1&&x(0,Bi,17,11,"div"),i&2&&y(o.assay?0:-1)},dependencies:[et,tt,it,Ke,ct,wt,De],encapsulation:2});let a=e;return a})();var Oi=[{path:"",pathMatch:"full",component:Pt}],Dt=(()=>{let e=class e{};e.\u0275fac=function(i){return new(i||e)},e.\u0275mod=T({type:e}),e.\u0275inj=D({imports:[fe.forChild(Oi),fe]});let a=e;return a})();var ye=(()=>{let e=class e{};e.\u0275fac=function(i){return new(i||e)},e.\u0275mod=T({type:e}),e.\u0275inj=D({imports:[F]});let a=e;return a})();var Tt=(()=>{let e=class e{};e.\u0275fac=function(i){return new(i||e)},e.\u0275mod=T({type:e}),e.\u0275inj=D({imports:[F,ye,ye]});let a=e;return a})();var Mt=(()=>{let e=class e{};e.\u0275fac=function(i){return new(i||e)},e.\u0275mod=T({type:e}),e.\u0275inj=D({imports:[F,Tt]});let a=e;return a})();var It=(()=>{let e=class e{};e.\u0275fac=function(i){return new(i||e)},e.\u0275mod=T({type:e}),e.\u0275inj=D({imports:[Mt]});let a=e;return a})();var Oa=(()=>{let e=class e{};e.\u0275fac=function(i){return new(i||e)},e.\u0275mod=T({type:e}),e.\u0275inj=D({imports:[F,Re,He,$e,Ae,Ge,We,nt,It,lt,Dt]});let a=e;return a})();export{Oa as TsHeatmapModule};
