import{a as d}from"./chunk-LPDAYVF7.js";import{a as g}from"./chunk-24L4UUKZ.js";import{Ac as c,Bc as f,R as l,U as a,X as m,_ as u,k as h,t as o}from"./chunk-Z4WVEEB6.js";var r=class n{constructor(i,e,t){this.login=i,this.firstName=e,this.lastName=t}get name(){return this.firstName?this.lastName?this.firstName+" "+this.lastName:this.firstName:this.lastName?this.lastName:this.login}static deserialize(i){if(!i)throw new Error("Cannot deserialize null user");let e=new n(void 0,void 0,void 0);return e.setAll(i),e}setAll(i){this.login=i.login,this.firstName=i.firstName,this.lastName=i.lastName,this.email=i.email,this.institution=i.institution,this.anonymous=i.anonymous}string2Bool(i){return i===!0||i==="true"||i==="TRUE"}};var w=(()=>{class n{constructor(e,t,s,p){this.BD2REST=e,this.analytics=t,this.feedback=s,this.systemEvents=p,this.user=this.makeAnonymous(),this.userStream=new h(this.user),console.log("User service created"),this.refresh(),this.unAuthSubsription=this.systemEvents.unauthorised$.subscribe(S=>this.refresh())}ngOnDestroy(){this.unAuthSubsription&&this.unAuthSubsription.unsubscribe(),this.userStream.complete()}get currentUser(){return this.user}get currentUser$(){return this.userStream}isLoggedIn(){return!(!this.user||this.user.anonymous)}login(e,t){return this.BD2REST.login(e,t).pipe(o(s=>{if(s=r.deserialize(s),s.anonymous)throw new Error("Login got anonymous user: "+s.login);return s}),a(s=>{this.setUser(s),this.feedback.success(s.name+", you are logged in"),this.analytics.userLoggedIn(s.login)},s=>this.handleError(s))).toPromise()}logout(){return this.BD2REST.logout().pipe(l(e=>this.BD2REST.refreshUser()),a(e=>{e=r.deserialize(e),this.setUser(e),this.feedback.success("You are logged out")}),o(e=>!0)).toPromise()}activate(e){return this.BD2REST.userActivate(e).then(t=>(t=r.deserialize(t),this.analytics.userActivation(t.login),t))}requestReset(e,t){return this.BD2REST.userRequestReset(e,t).then(s=>s.email)}resetPassword(e,t){return this.BD2REST.userResetPassword(e,t).then(s=>s.login)}availableLogin(e){return this.BD2REST.userAvailableLogin(e)}suitableEmail(e){return this.BD2REST.userSuitableEmail(e)}register(e){return this.BD2REST.userRegister(e).then(t=>(t=r.deserialize(t),this.analytics.userRegistration(t.login),t))}update(e){return this.BD2REST.userUpdate(e).pipe(o(t=>r.deserialize(t)),a(t=>{t.login===this.currentUser.login&&this.setUser(t)}))}passwordUpdate(e){return this.BD2REST.passwordUpdate(e).pipe(o(t=>r.deserialize(t)),a(t=>{t.login===this.currentUser.login&&this.setUser(t)}))}refresh(){return this.BD2REST.refreshUser().subscribe(e=>{e=r.deserialize(e),this.setUser(e)},e=>this.handleError(e))}handleError(e){this.feedback.error(e)}setUser(e){this.user=e,this.userStream.next(e)}makeAnonymous(){let e=new r("anonymous");return e.anonymous=!0,e}static{this.\u0275fac=function(t){return new(t||n)(u(f),u(d),u(g),u(c))}}static{this.\u0275prov=m({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{w as a};
