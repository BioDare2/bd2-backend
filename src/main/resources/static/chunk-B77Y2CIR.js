import{a as A,b as ut,c as K,d as fe,e as ft,f as yt,g as B,h as bt,i as w}from"./chunk-YO5ZMU3M.js";import{a as Pt,b as Et,c as Dt}from"./chunk-W5VCK3US.js";import{e as It}from"./chunk-EBK65C4E.js";import{a as Ie}from"./chunk-6YW72IMV.js";import{a as pt}from"./chunk-NS2WMCE2.js";import"./chunk-N5K2AFHX.js";import{a as dt,e as H,g as ae,h as ht,j as _t,k as gt,n as wt}from"./chunk-QHENU6XX.js";import"./chunk-SA672R6Q.js";import{a as ne}from"./chunk-RXSDPAIK.js";import{a as vt,b as Ct,g as St,h as xt,i as Rt,o as Tt}from"./chunk-QUVJHCCS.js";import{b as N,c as ct}from"./chunk-R546TKQQ.js";import"./chunk-S6ZLJNMC.js";import"./chunk-7UCAK7A4.js";import"./chunk-DJ2VVPKW.js";import{A as lt,d as Ge,e as ie,g as We,l as Ye,n as et,o as tt,p as it,r as nt,s as rt,u as ot,v as at,x as st,y as mt}from"./chunk-3YYYRSCH.js";import{d as Qe}from"./chunk-3DRDKITD.js";import{a as Ue,n as Ze}from"./chunk-5VYPYMOR.js";import{i as Xe}from"./chunk-VRYT53ET.js";import{E as qe,F as Le,G as ze,H as re,J as oe,a as De,d as Me,f as $,i as je,j as ee,k as Oe,n as te,o as Fe,r as ke,s as Je,t as Ve,u as Ne,v as Be,w as $e,x as He,y as Ae,z as Ke}from"./chunk-V2HAGLXN.js";import{a as Z}from"./chunk-P7IXKCK2.js";import{Ab as v,Bb as k,Ca as m,Cb as he,Da as g,F as _e,Hb as J,Ib as j,Lb as x,Ma as T,Mb as O,Na as G,Nb as P,Oa as Ce,Pa as M,Sa as p,U as ge,Wa as l,X as z,Xa as Se,Y as U,Ya as xe,_ as F,ac as V,bc as D,da as ve,db as r,dc as X,ea as u,eb as o,ec as Te,fa as f,fb as d,fc as we,gb as C,gc as Pe,hb as S,jb as R,k as ye,la as I,mb as h,ob as y,tb as Q,ub as W,vb as Y,vc as Ee,xc as ue,yb as Re,z as be,zb as a}from"./chunk-L7CH4MQ7.js";var se=(()=>{class t extends ct{constructor(e,i){super(i),this.rhythmicityService=e,this.titlePart=" Rhythm"}goToRhythmicityHome(e){let i=this.expHomePath(e);i.push("rhythmicity"),this.router.navigate(i)}static{this.\u0275fac=function(i){return new(i||t)(g(w),g(N))}}static{this.\u0275dir=Ce({type:t,features:[M]})}}return t})();var me=(()=>{class t extends Et{get currentJob(){return this.currentAsset}constructor(e,i=!1){super(i),this.rhythmicityService=e,this.finishedJob$=this.finished$,this.runningJob$=this.running$,this.allJob$=this.all$}initIntervalsKeeper(){return new Pt(1e3,30*1e3,10*60*1e3,2)}assayJob(e){this.input(e)}sameInput(e,i){return e[1]===i[1]&&e[0]===i[0]}fetchAsset([e,i]){return this.rhythmicityService.getJob(e,i)}hasFailed(e){return B.hasFailed(e)}isFinished(e){return B.isFinished(e)}isRunning(e){return B.isRunning(e)}assetToId(e){return e.jobId}assetToInput(e){return[e.parentId,e.jobId]}static{this.\u0275fac=function(i){return new(i||t)(F(w),F(ne,8))}}static{this.\u0275prov=z({token:t,factory:t.\u0275fac})}}return t})();var le=(()=>{class t extends Dt{constructor(e,i=!1){super(i),this.rhythmicityService=e,this.results$=this.data$}isClassicJob(){return this.currentInput?.parameters?.METHOD==="BD2JTK"}sameInput(e,i){return B.sameJob(e,i)}assetToData(e,i){return e.results}fetchAsset(e){return this.rhythmicityService.getResults(e.parentId,e.jobId).pipe(ge(i=>this.labelPatterns(i)))}sortingKey(e){switch(e.active){case"label":return i=>i.label;case"id":return i=>+i.id;case"empp":return i=>+i.result.empP;case"emppbh":return i=>+i.result.empPBH;case"p":return i=>+i.result.p;case"pbh":return i=>+i.result.pBH;case"tau":return i=>+i.result.tau;case"period":return i=>i.result.pattern.period;case"peak":return i=>i.result.pattern.peak;case"trough":return i=>i.result.pattern.trough;default:return console.error("Not implemented sorting for "+e.active),i=>0}}processData(e,i){return i&&this.rankResults(e,i.pValue,i.bhCorrection,this.isClassicJob()),e}labelPatterns(e){e.results.forEach(i=>{i.result.patternLabel=this.describePattern(i.result),i.result.pattern.shapeLabel=this.patternToShape(i.result.pattern)})}describePattern(e){let i=e.pattern,n=Math.round(i.period*10)/10,c=Math.round(i.peak*100)/100,b=Math.round(i.trough*100)/100;return`${this.patternToShape(i)}	${n}	${c}	${b}`}patternToShape(e){switch(e.waveform){case"ASYM_COSINE":return e.leftPortion===.5?"COS":"ACOS";case"ASYM_COS_SPIKE":return"SPIKE";case"ASYM_COS_SPIKE_NEG":return"NPIKE";default:return e.waveform}}rankResults(e,i,n,c){e.forEach(b=>{let _=b.result,de;c?de=n?_.pBH:_.p:de=n?_.empPBH:_.empP,_.rhythmic=de<i})}static{this.\u0275fac=function(i){return new(i||t)(F(w),F(ne,8))}}static{this.\u0275prov=z({token:t,factory:t.\u0275fac})}}return t})();var jt=()=>[10,25,50,100,250];function Kt(t,s){t&1&&d(0,"mat-progress-bar",28)}function qt(t,s){t&1&&(r(0,"th",29),a(1,"Id"),o())}function Lt(t,s){if(t&1&&(r(0,"td",30),a(1),o()),t&2){let e=s.$implicit;m(),v(e.id)}}function zt(t,s){t&1&&(r(0,"th",29),a(1,"Label"),o())}function Ut(t,s){if(t&1&&(r(0,"td",31),a(1),o()),t&2){let e=s.$implicit;m(),v(e.label)}}function Gt(t,s){t&1&&(r(0,"th",32),a(1,"Rhythmic"),o())}function Qt(t,s){if(t&1&&(r(0,"td",30),a(1),o()),t&2){let e=s.$implicit;xe("bold",e.result.rhythmic),m(),v(e.result.rhythmic)}}function Wt(t,s){t&1&&(r(0,"th",29),a(1,"emp-p"),o())}function Yt(t,s){if(t&1&&(r(0,"td",30),a(1),x(2,"number"),o()),t&2){let e=s.$implicit;m(),v(P(2,1,e.result.empP,"1.0-5"))}}function Xt(t,s){t&1&&(r(0,"th",29),a(1,"BH emp-p"),o())}function Zt(t,s){if(t&1&&(r(0,"td",30),a(1),x(2,"number"),o()),t&2){let e=s.$implicit;m(),v(P(2,1,e.result.empPBH,"1.0-5"))}}function ei(t,s){t&1&&(r(0,"th",29),a(1,"Tau"),o())}function ti(t,s){if(t&1&&(r(0,"td",30),a(1),x(2,"number"),o()),t&2){let e=s.$implicit;m(),v(P(2,1,e.result.tau,"1.0-2"))}}function ii(t,s){t&1&&(r(0,"th",29),a(1,"p"),o())}function ni(t,s){if(t&1&&(r(0,"td",30),a(1),x(2,"number"),o()),t&2){let e=s.$implicit;m(),v(P(2,1,e.result.p,"1.0-5"))}}function ri(t,s){t&1&&(r(0,"th",29),a(1,"BH p"),o())}function oi(t,s){if(t&1&&(r(0,"td",30),a(1),x(2,"number"),o()),t&2){let e=s.$implicit;m(),v(P(2,1,e.result.pBH,"1.0-5"))}}function ai(t,s){t&1&&(r(0,"th",32),a(1,"Pattern"),o())}function si(t,s){if(t&1&&(r(0,"td",30),a(1),o()),t&2){let e=s.$implicit;m(),v(e.result.patternLabel)}}function mi(t,s){t&1&&(r(0,"th",32),a(1,"P.Shape"),o())}function li(t,s){if(t&1&&(r(0,"td",30),a(1),o()),t&2){let e=s.$implicit;m(),v(e.result.pattern.shapeLabel)}}function pi(t,s){t&1&&(r(0,"th",29),a(1,"P.Period"),o())}function ci(t,s){if(t&1&&(r(0,"td",30),a(1),x(2,"number"),o()),t&2){let e=s.$implicit;m(),v(P(2,1,e.result.pattern.period,"1.0-1"))}}function di(t,s){t&1&&(r(0,"th",29),a(1,"P.Peak"),o())}function hi(t,s){if(t&1&&(r(0,"td",30),a(1),x(2,"number"),o()),t&2){let e=s.$implicit;m(),v(P(2,1,e.result.pattern.peak,"1.1-1"))}}function ui(t,s){t&1&&(r(0,"th",32),a(1,"P.Peak"),o())}function fi(t,s){if(t&1&&(r(0,"td",30),a(1),x(2,"number"),o()),t&2){let e=s.$implicit;m(),v(P(2,1,e.result.pattern.peak*24/e.result.pattern.period,"1.1-1"))}}function yi(t,s){t&1&&(r(0,"th",29),a(1,"P.Trough"),o())}function bi(t,s){if(t&1&&(r(0,"td",30),a(1),x(2,"number"),o()),t&2){let e=s.$implicit;m(),v(P(2,1,e.result.pattern.trough,"1.1-1"))}}function _i(t,s){t&1&&(r(0,"th",32),a(1,"P.Trough"),o())}function gi(t,s){if(t&1&&(r(0,"td",30),a(1),x(2,"number"),o()),t&2){let e=s.$implicit;m(),v(P(2,1,e.result.pattern.trough*24/e.result.pattern.period,"1.1-1"))}}function vi(t,s){t&1&&d(0,"tr",33)}function Ci(t,s){t&1&&d(0,"tr",34)}var pe=(()=>{class t{set job(e){e&&this.fetcher.input(e)}set statTestParams(e){if(e){this.fetcher.params(e);let i=e.bhCorrection?this.bhEmpPColumns:this.normEmpPColumns;this.fetcher.isClassicJob()&&(i=e.bhCorrection?this.bhClsPColumns:this.normClsPColumns),e.showPattern&&(i=e.circadian?i.concat(this.patternColumnsC):i.concat(this.patternColumns)),this.displayedColumns=i}}constructor(e,i){this.fetcher=e,this.feedback=i,this.normEmpPColumns=["id","label","rhythmic","empp","tau"],this.normClsPColumns=["id","label","rhythmic","p","tau"],this.bhEmpPColumns=["id","label","rhythmic","emppbh","tau"],this.bhClsPColumns=["id","label","rhythmic","pbh","tau"],this.patternColumns=["shape","period","peak","trough"],this.patternColumnsC=["shape","period","peakc","troughc"],this.displayedColumns=this.normEmpPColumns,this.disablePaginator=!1}ngOnInit(){this.fetcher.error$.subscribe(i=>this.feedback.error(i));let e=new Ge;e.pageSize=25,e.pageIndex=0,this.fetcher.page(e),this.fetcher.on(!0)}ngOnDestroy(){this.fetcher.close()}ngAfterViewInit(){}reload(){this.fetcher.refresh()}sortData(e){this.fetcher.sort(e)}loadPage(e){this.fetcher.page(e)}static{this.\u0275fac=function(i){return new(i||t)(g(le),g(Z))}}static{this.\u0275cmp=T({type:t,selectors:[["bd2-rhythmicity-results-mdtable"]],inputs:{job:"job",statTestParams:"statTestParams"},standalone:!1,features:[J([le])],decls:55,vars:18,consts:[["paginator",""],["paginator2",""],[1,"mat-elevation-z8"],["mode","indeterminate",4,"ngIf"],[3,"page","length","disabled","pageSize","pageIndex","pageSizeOptions"],["mat-table","","matSort","","aria-label","Results","matSort","","matSortActive","id","matSortDirection","asc",1,"full-width-table",3,"matSortChange","dataSource"],["matColumnDef","id"],["mat-header-cell","","mat-sort-header","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","label"],["mat-cell","","class","word_wrapping","style","max-width: 100px",4,"matCellDef"],["matColumnDef","rhythmic"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",3,"bold",4,"matCellDef"],["matColumnDef","empp"],["matColumnDef","emppbh"],["matColumnDef","tau"],["matColumnDef","p"],["matColumnDef","pbh"],["matColumnDef","pattern"],["matColumnDef","shape"],["matColumnDef","period"],["matColumnDef","peak"],["matColumnDef","peakc"],["matColumnDef","trough"],["matColumnDef","troughc"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mode","indeterminate"],["mat-header-cell","","mat-sort-header",""],["mat-cell",""],["mat-cell","",1,"word_wrapping",2,"max-width","100px"],["mat-header-cell",""],["mat-header-row",""],["mat-row",""]],template:function(i,n){if(i&1){let c=R();r(0,"div",2),p(1,Kt,1,0,"mat-progress-bar",3),x(2,"async"),r(3,"mat-paginator",4,0),h("page",function(_){return u(c),f(n.loadPage(_))}),o(),r(5,"table",5),h("matSortChange",function(_){return u(c),f(n.sortData(_))}),C(6,6),p(7,qt,2,0,"th",7)(8,Lt,2,1,"td",8),S(),C(9,9),p(10,zt,2,0,"th",7)(11,Ut,2,1,"td",10),S(),C(12,11),p(13,Gt,2,0,"th",12)(14,Qt,2,3,"td",13),S(),C(15,14),p(16,Wt,2,0,"th",7)(17,Yt,3,4,"td",8),S(),C(18,15),p(19,Xt,2,0,"th",7)(20,Zt,3,4,"td",8),S(),C(21,16),p(22,ei,2,0,"th",7)(23,ti,3,4,"td",8),S(),C(24,17),p(25,ii,2,0,"th",7)(26,ni,3,4,"td",8),S(),C(27,18),p(28,ri,2,0,"th",7)(29,oi,3,4,"td",8),S(),C(30,19),p(31,ai,2,0,"th",12)(32,si,2,1,"td",8),S(),C(33,20),p(34,mi,2,0,"th",12)(35,li,2,1,"td",8),S(),C(36,21),p(37,pi,2,0,"th",7)(38,ci,3,4,"td",8),S(),C(39,22),p(40,di,2,0,"th",7)(41,hi,3,4,"td",8),S(),C(42,23),p(43,ui,2,0,"th",12)(44,fi,3,4,"td",8),S(),C(45,24),p(46,yi,2,0,"th",7)(47,bi,3,4,"td",8),S(),C(48,25),p(49,_i,2,0,"th",12)(50,gi,3,4,"td",8),S(),p(51,vi,1,0,"tr",26)(52,Ci,1,0,"tr",27),o(),r(53,"mat-paginator",4,1),h("page",function(_){return u(c),f(n.loadPage(_))}),o()()}i&2&&(m(),l("ngIf",O(2,14,n.fetcher.isBusy$)),m(2),l("length",n.fetcher.dataLength)("disabled",n.disablePaginator)("pageSize",(n.fetcher.currentPage==null?null:n.fetcher.currentPage.pageSize)||25)("pageIndex",n.fetcher.currentPage==null?null:n.fetcher.currentPage.pageIndex)("pageSizeOptions",j(16,jt)),m(2),l("dataSource",n.fetcher.results$),m(46),l("matHeaderRowDef",n.displayedColumns),m(),l("matRowDefColumns",n.displayedColumns),m(),l("length",n.fetcher.dataLength)("disabled",n.disablePaginator)("pageSize",(n.fetcher.currentPage==null?null:n.fetcher.currentPage.pageSize)||25)("pageIndex",n.fetcher.currentPage==null?null:n.fetcher.currentPage.pageIndex)("pageSizeOptions",j(17,jt)))},dependencies:[D,ie,xt,Rt,et,it,at,nt,tt,st,rt,ot,mt,lt,We,X,we],styles:[".full-width-table[_ngcontent-%COMP%]{width:100%}"]})}}return t})();function Ri(t,s){if(t&1&&(r(0,"mat-radio-button",5),a(1),o()),t&2){let e=s.$implicit;l("value",e),m(),v(e)}}var Ot=(()=>{class t{constructor(){this.values=[1e-4,.001,.005,.01,.05,.1],this.pvalue=.001,this.pvalue$=new I}ngOnInit(){}ngAfterViewInit(){this.pvalue$.emit(this.pvalue)}selected(e){this.pvalue$.emit(e.value)}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275cmp=T({type:t,selectors:[["bd2-pvalue-form"]],outputs:{pvalue$:"pvalue$"},standalone:!1,decls:8,vars:2,consts:[[1,"form-inline"],[1,"mx-auto","text-center"],["id","pvalues-label",1,"mb-1"],["aria-label","Select p-value","aria-labelledby","pvalues-label",3,"change","value"],[3,"value",4,"ngFor","ngForOf"],[3,"value"]],template:function(i,n){i&1&&(r(0,"form",0)(1,"div",1)(2,"mat-label",2)(3,"strong"),a(4,"p-value threshold:"),o()(),r(5,"div")(6,"mat-radio-group",3),h("change",function(b){return n.selected(b)}),p(7,Ri,2,2,"mat-radio-button",4),o()()()()),i&2&&(m(6),l("value",n.pvalue),m(),l("ngForOf",n.values))},dependencies:[V,te,ee,Oe,Ue,vt,Ct],styles:[".mat-mdc-radio-button[_ngcontent-%COMP%]{margin-right:15px}"]})}}return t})();var Ft=(()=>{class t{constructor(){this.options=new I,this.currentOptions=new bt(0,!1,!1,!1)}ngOnInit(){}pValue(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.pValue=e,this.options.next(this.currentOptions)}bhCorrection(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.bhCorrection=e,this.options.next(this.currentOptions)}circadian(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.circadian=e,this.options.next(this.currentOptions)}showPattern(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.showPattern=e,this.options.next(this.currentOptions)}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275cmp=T({type:t,selectors:[["bd2-stat-test-options-widget"]],outputs:{options:"options"},standalone:!1,decls:14,vars:1,consts:[["pattern",""],["appearance","outlined"],[3,"pvalue$"],[2,"margin-top","0.5em","text-align","center"],[3,"change"],[3,"change","disabled"]],template:function(i,n){if(i&1){let c=R();r(0,"mat-card",1)(1,"mat-card-content")(2,"section")(3,"bd2-pvalue-form",2),h("pvalue$",function(_){return u(c),f(n.pValue(_))}),o()(),r(4,"section",3)(5,"mat-slide-toggle",4),h("change",function(_){return u(c),f(n.bhCorrection(_.checked))}),a(6,"Benjamini Hochberg correction"),o()(),r(7,"section",3)(8,"mat-slide-toggle",4,0),h("change",function(_){return u(c),f(n.showPattern(_.checked))}),a(10,"show pattern"),o(),a(11," \xA0 "),r(12,"mat-slide-toggle",5),h("change",function(_){return u(c),f(n.circadian(_.checked))}),a(13,"circadian unit"),o()()()()}if(i&2){let c=Re(9);m(12),l("disabled",!c.checked)}},dependencies:[Ye,re,oe,Ot],encapsulation:2})}}return t})();function Ei(t,s){if(t&1){let e=R();r(0,"div",5)(1,"button",14),h("click",function(){u(e);let n=y(2);return f(n.delete())}),r(2,"i",4),a(3,"delete_forever"),o()(),r(4,"button",15),h("click",function(){u(e);let n=y(2);return f(n.export())}),r(5,"i",4),a(6,"save_alt"),o()()()}}function Di(t,s){if(t&1&&(r(0,"div",16),d(1,"br"),a(2),o()),t&2){let e=y().ngIf;m(2),k("ERROR: ",e.jobStatus.message," ")}}function Ii(t,s){t&1&&(r(0,"div")(1,"mat-card",9)(2,"mat-card-content"),d(3,"mat-spinner",17),o()()())}function Mi(t,s){t&1&&(r(0,"div")(1,"mat-card",9)(2,"mat-card-content")(3,"div",18),a(4,"It may take up to 10 minutes to test for rhythmicity"),o()()()())}function ji(t,s){if(t&1){let e=R();C(0),r(1,"bd2-stat-test-options-widget",19),h("options",function(n){u(e);let c=y(3);return f(c.statTestOptions(n))}),o(),d(2,"bd2-rhythmicity-results-mdtable",20),S()}if(t&2){let e=s.ngIf,i=y(3);m(2),l("statTestParams",i.statTestParams)("job",e)}}function Oi(t,s){if(t&1&&(r(0,"div"),d(1,"mat-divider"),p(2,Ii,4,0,"div",13),x(3,"async"),p(4,Mi,5,0,"div",13)(5,ji,3,2,"ng-container",13),x(6,"async"),o()),t&2){let e=y().ngIf,i=y();m(2),l("ngIf",O(3,3,i.rhythmicityJobDatasource.isReloading$)),m(2),l("ngIf",e.jobStatus.state==="SUBMITTED"),m(),l("ngIf",O(6,5,i.rhythmicityJobDatasource.finishedJob$))}}function Fi(t,s){if(t&1){let e=R();r(0,"div",1)(1,"div",2)(2,"div",3),h("click",function(){u(e);let n=y();return f(n.toggleExpanded())}),r(3,"i",4),a(4,"waves"),o(),a(5),x(6,"date"),d(7,"br"),a(8),o(),r(9,"div",5),a(10),r(11,"a",6),h("click",function(){u(e);let n=y();return f(n.refresh())}),r(12,"i",7),a(13,"refresh"),o()()()(),r(14,"div",8)(15,"mat-card",9)(16,"mat-card-content")(17,"div",10),p(18,Ei,7,0,"div",11),a(19),p(20,Di,3,1,"div",12),o()()(),p(21,Oi,7,7,"div",13),o()()}if(t&2){let e=s.ngIf,i=y();m(3),Se("color",i.isExpanded?"green":"red")("font-size",150,"%"),m(2),he(" \xA0",i.shortUUID(e.jobId)," (",O(6,13,i.toLocalDateTime(e.jobStatus.submitted)),") "),m(3),he(" ",i.friendlyMethod(e.parameters.METHOD),"; \xA0 waveforms: ",e.parameters.PRESET," "),m(2),k(" ",e.jobStatus.state," "),m(8),l("ngIf",i.assay.security.canWrite),m(),k(" ",e.parameters.PARAMS_SUMMARY," "),m(),l("ngIf",e.jobStatus.message&&e.jobStatus.message!="OK"),m(),l("ngIf",i.isExpanded)}}var ce=(()=>{class t{set expanded(e){this.isExpanded=e,this.expandedToogleStream.next(e)}constructor(e,i,n,c){this.rhythmicityService=e,this.rhythmicityJobDatasource=i,this.feedback=n,this.dialogs=c,this.deleted=new I,this.isExpanded=!1,this.expandedToogleStream=new ye(!1)}ngOnInit(){this.initSubscriptions()}ngOnDestroy(){this.rhythmicityJobDatasource.close(),this.expandedToogleStream&&this.expandedToogleStream.complete()}ngOnChanges(e){(e.jobId||e.assay)&&this.jobId&&this.assay&&this.rhythmicityJobDatasource.assayJob([this.assay.id,this.jobId])}statTestOptions(e){let i=be(1).subscribe(()=>{this.statTestParams=e,i&&i.unsubscribe()})}export(){this.rhythmicityService.downloadJob(this.assay.id,this.jobId).subscribe(e=>{this.saveJobBlob(e,this.assay.id,this.jobId)},e=>this.feedback.error(e))}saveJobBlob(e,i,n){let c={fileName:i+"_job"+this.shortUUID(n)+".rhythmicity.csv",extensions:[".csv"]};ht(e,c).then(b=>{}).catch(b=>console.log("could not save export",b))}refresh(){this.rhythmicityJobDatasource.refresh(),this.resultsTable&&this.resultsTable.reload()}delete(){let e=this.assay,i=this.rhythmicityJobDatasource.currentJob;this.dialogs.confirm("Do you want to delete analysis: "+i.jobId,i.parameters.PARAMS_SUMMARY).subscribe(n=>{n&&this.doDelete(e,i.jobId)})}initSubscriptions(){this.rhythmicityJobDatasource.on(!0),this.rhythmicityJobDatasource.error$.forEach(e=>this.feedback.error(e))}doDelete(e,i){this.rhythmicityService.deleteJob(e,i).subscribe(n=>{this.deleted.next(n),this.feedback.success("Job: "+this.shortUUID(i)+" deleted")},n=>{this.feedback.error(n)})}toggleExpanded(){this.expanded=!this.isExpanded}toLocalDateTime(e){return Qe.deserialize(e).date}shortUUID(e){return Xe(e)}friendlyMethod(e){return e==="BD2JTK"?"Classic JTK":e==="BD2EJTK"?"BD2 eJTK":e}static{this.\u0275fac=function(i){return new(i||t)(g(w),g(me),g(Z),g(pt))}}static{this.\u0275cmp=T({type:t,selectors:[["bd2-rhythmicity-job-pane"]],viewQuery:function(i,n){if(i&1&&Q(pe,5),i&2){let c;W(c=Y())&&(n.resultsTable=c.first)}},inputs:{jobId:"jobId",assay:"assay",expanded:"expanded"},outputs:{deleted:"deleted"},standalone:!1,features:[J([me]),ve],decls:2,vars:3,consts:[["class","card mb-2",4,"ngIf"],[1,"card","mb-2"],[1,"card-header","clearfix"],["role","button",1,"float-left",3,"click"],[1,"material-icons","bd-icon"],[1,"float-right"],["role","button","aria-label","refresh",3,"click"],[1,"material-icons","bd-icon","bd-primary"],[1,"card-body"],["appearance","outlined"],[1,"clearfix"],["class","float-right",4,"ngIf"],["class","text-danger","style","word-wrap: break-word;",4,"ngIf"],[4,"ngIf"],["type","button",1,"btn","btn-danger","btn-sm","mr-1",3,"click"],["type","button",1,"btn","btn-primary","btn-sm",3,"click"],[1,"text-danger",2,"word-wrap","break-word"],[1,"center-block"],[2,"margin-top","0.5em","text-align","center"],[3,"options"],[3,"statTestParams","job"]],template:function(i,n){i&1&&(p(0,Fi,22,15,"div",0),x(1,"async")),i&2&&l("ngIf",O(1,1,n.rhythmicityJobDatasource.allJob$))},dependencies:[D,St,re,oe,Ze,pe,Ft,X,Te],encapsulation:2})}}return t})();var Ji=()=>["new"];function Vi(t,s){if(t&1&&(r(0,"div")(1,"strong"),a(2),o()()),t&2){let e=y(2);m(2),k("Submitted jobs: ",e.jobs.length,"")}}function Ni(t,s){t&1&&(r(0,"div"),a(1," No jobs submitted, start a new test. "),o())}function Bi(t,s){t&1&&(r(0,"a",7),a(1," New test "),o()),t&2&&l("routerLink",j(1,Ji))}function $i(t,s){if(t&1){let e=R();r(0,"div")(1,"bd2-rhythmicity-job-pane",8),h("deleted",function(n){u(e);let c=y(2);return f(c.remove(n))}),o()()}if(t&2){let e=s.$implicit,i=s.index,n=y(2);m(),l("assay",n.assay)("jobId",e)("expanded",n.expandAll||i==0)}}function Hi(t,s){if(t&1){let e=R();r(0,"div")(1,"h3"),a(2,"Rhythmicity tests"),o(),d(3,"hr"),r(4,"div",1)(5,"div",2),p(6,Vi,3,1,"div",0)(7,Ni,2,0,"div",0),o(),r(8,"div",3),p(9,Bi,2,2,"a",4),r(10,"button",5),h("click",function(){u(e);let n=y();return f(n.refresh())}),a(11,"Refresh "),o()()(),d(12,"hr"),p(13,$i,2,3,"div",6),d(14,"hr"),o()}if(t&2){let e=y();m(6),l("ngIf",e.jobs&&e.jobs.length>0),m(),l("ngIf",!e.jobs||e.jobs.length==0),m(2),l("ngIf",e.assay.security.canWrite),m(),l("disabled",e.blocked),m(3),l("ngForOf",e.jobsIds)}}var kt=(()=>{class t extends se{constructor(e,i){super(e,i),this.expandAll=!1,this.blocked=!1,this.titlePart=" Rhythm"}updateModel(e){super.updateModel(e),e&&this.loadJobs(e)}loadJobs(e,i=!1){this.blocked=!0,this.rhythmicityService.getJobs(e).subscribe(n=>{this.jobs=n,this.refreshJobsInfo(n),this.exportURL=this.rhythmicityService.exportURL(e),i&&this.refreshPanes(),this.blocked=!1},n=>{this.blocked=!1,this.feedback.error(n)})}refreshJobsInfo(e){this.jobsIds=e.map(i=>i.jobId)}refresh(){this.loadJobs(this.assay,!0)}refreshPanes(){this.panes&&this.panes.forEach(e=>e.refresh())}remove(e){let i=this.jobs.findIndex(n=>e.jobId===n.jobId);i>=0&&(this.jobs.splice(i,1),this.refreshJobsInfo(this.jobs))}refreshJob(e){let i=this.jobs.findIndex(n=>e.jobId===n.jobId);i>=0&&(this.jobs[i]=e,this.refreshJobsInfo(this.jobs))}calculateQueuing(e){return e.filter(i=>this.isQueueing(i.jobStatus.state)).length}isQueueing(e){switch(e){case"WAITING":return!0;case"PROCESSING":return!0;case"SUBMITTED":return!0;default:return!1}}checkFinished(e){return!!e.find(i=>this.isFinished(i.jobStatus.state))}isFinished(e){switch(e){case"SUCCESS":return!0;case"FINISHED":return!0;case"COMPLETED":return!0;default:return!1}}static{this.\u0275fac=function(i){return new(i||t)(g(w),g(N))}}static{this.\u0275cmp=T({type:t,selectors:[["ng-component"]],viewQuery:function(i,n){if(i&1&&Q(ce,5),i&2){let c;W(c=Y())&&(n.panes=c)}},standalone:!1,features:[M],decls:1,vars:1,consts:[[4,"ngIf"],[1,"card"],[1,"card-header"],[1,"card-body"],["class","btn btn-primary mr-1",3,"routerLink",4,"ngIf"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],[4,"ngFor","ngForOf"],[1,"btn","btn-primary","mr-1",3,"routerLink"],[3,"deleted","assay","jobId","expanded"]],template:function(i,n){i&1&&p(0,Hi,15,5,"div",0),i&2&&l("ngIf",n.assay)},dependencies:[V,D,Ee,ce],encapsulation:2})}}return t})();var Ai=()=>[10,25,50,100,200];function Ki(t,s){if(t&1&&(r(0,"option",29),a(1),o()),t&2){let e=s.$implicit;l("value",e.name),m(),v(e.label)}}function qi(t,s){t&1&&(r(0,"div",30)(1,"div",31),a(2," Rhythmicity tests are generally used for short, sparse timeseries. "),d(3,"br"),a(4," The current limit is 5 or 4 days of hourly sampled data for eJTK preset and BD2 preset respectivelly."),d(5,"br"),a(6," Generally the raw data are being analysed, but we also enabled a linear detrended option. "),o()())}function Li(t,s){if(t&1&&(r(0,"option",29),a(1),o()),t&2){let e=s.$implicit;l("value",e.name),m(),v(e.label)}}function zi(t,s){t&1&&(r(0,"div",30)(1,"div",31)(2,"p")(3,"b"),a(4,"Classic JTK"),o(),a(5," is the implementation of JTK_CYCLE from "),r(6,"a",32),a(7,"Michael E. Hughes et al. 2010"),o(),a(8," a standard method for detecting rhythmicity in genome-scale datasets. "),d(9,"br"),a(10,"The method is fast but it is reliable only when it tests against small set of patterns, we provide patterns of 24h cosines with different phases."),o(),r(11,"p")(12,"b"),a(13,"BD2 eJTK"),o(),a(14," is the BioDare2 implementation of Empirical JTK_CYCLE with asymmetry search from "),r(15,"a",33),a(16,"Alan L. Hutchison et al. 2015"),o(),a(17,". It is similar to the classic JTK method but with p values empirically calculated against set of random noise data. "),d(18,"br"),a(19,"This modification permits using larger sets of test patterns and it provides better accuracy. However, this method is much slower so it can only analyze timeseries only up to 5 days of data (though the Classic JTK method was never intended to be used with such a long data)."),o()()())}function Ui(t,s){if(t&1&&(r(0,"option",29),a(1),o()),t&2){let e=s.$implicit;l("value",e.name),m(),v(e.label)}}function Gi(t,s){t&1&&(r(0,"div",30)(1,"div",31),a(2," Presets determine set of pattern curves against the comparison test is run."),d(3,"br"),r(4,"ul")(5,"li"),a(6,"Cosine 24h 1/2/4h are set of cosine curves of 24h periods, and phases spread every 1, 2, or 4 hours. To be used mainly with Classic JTK."),o(),r(7,"li"),a(8,"eJTK Classic is recommended for typical omics-like data for which eJTK method was developed. "),d(9,"br"),a(10," It works well for short data (48h, 2h- 1h-sampled) when actual period is within range 22-26 hours."),d(11,"br"),a(12," The patterns are series of cosine-like waveforms with 24h period, phases by 2hours and range of asymmetries by 2h (see original paper)."),d(13,"br"),o(),r(14,"li"),a(15,"BD2 Classic can detect non 24 periods and some forms of the spikes."),d(16,"br"),a(17," As it compares against much more patterns it has a weaker power."),d(18,"br"),a(19," It should be used when there is a good reason to suspect periods outside 22-26h range."),d(20,"br"),a(21," The patterns are series of cosine-like waverforms with periods from 18-35hours, for each period there are multiple "),r(22,"b"),a(23,"circadian"),o(),a(24," phases with step 2h (so each period value generates the same number of patterns but the peaks in absolute units do not coincide) and a range of assymetries by 2h in circadian units (see original paper). The preset contains also additional some spike patterns. "),o()()()())}var Jt=(()=>{class t extends gt{constructor(e){super(e),this.methodOptions=ut,this.presetOptions=fe,this.dataHelp=!1,this.presetsHelp=!1,this.methodHelp=!1,this.rhythmicityRequests=new I,this.detrendingOptions=[H.NO_DTR,H.LIN_DTR],this.methodForm=this.mainForm.get("method"),this.presetForm=this.mainForm.get("preset")}buildMainForm(){return this.fb.group({displayParams:this.displayParamsForm,periodScale:this.fb.group({periodMin:[18,[$.required]],periodMax:[34,[$.required]]},{validator:i=>this.validPeriodScale(i.value)}),method:[A.BD2EJTK.name,[$.required]],preset:[K.EJTK_CLASSIC.name,[$.required]]})}ngOnInit(){super.ngOnInit(),this.methodForm.valueChanges.subscribe(e=>this.setPresetOptions(e))}ngOnDestroy(){super.ngOnDestroy()}setPresetOptions(e){e===A.BD2EJTK.name?(this.presetOptions=fe,this.presetForm.setValue(K.EJTK_CLASSIC.name)):e===A.BD2JTK.name?(this.presetOptions=ft,this.presetForm.setValue(K.COS_2H.name)):this.presetOptions=[]}defaultDetrending(){return H.NO_DTR.name}validPeriodScale(e){let i=e.periodMin,n=e.periodMax;return i<10?{validPeriodScale:"Period min must >= 10"}:n<10?{validPeriodScale:"Period max must >= 10"}:n>50?{validPeriodScale:"Period max must < 50"}:i>=n?{validPeriodScale:"Period min must be < max"}:null}analyse(){if(this.mainForm.invalid)return;let e=this.map2RhythmicityRequest(this.mainForm.value);e.isValid()&&this.rhythmicityRequests.next(e)}map2RhythmicityRequest(e){let i=new yt;return i.detrending=H.get(e.displayParams.detrending),i.method=A.get(e.method),i.preset=K.get(e.preset),i.periodMax=e.periodScale.periodMax,i.periodMin=e.periodScale.periodMin,i.windowEnd=e.displayParams.timeScale.timeEnd,i.windowStart=e.displayParams.timeScale.timeStart,i}static{this.\u0275fac=function(i){return new(i||t)(g(qe))}}static{this.\u0275cmp=T({type:t,selectors:[["bd2-rhythmicityjob-params-rform"]],inputs:{disabled:"disabled",totalTraces:"totalTraces",currentPage:"currentPage"},outputs:{displayParams:"displayParams",rhythmicityRequests:"rhythmicityRequests"},standalone:!1,features:[M],decls:61,vars:15,consts:[["dataPaginator",""],["role","form",1,"form-horizontal",3,"formGroup"],["formGroupName","displayParams"],["formGroupName","timeScale",1,"form-group","row"],[1,"col-sm-4"],["for","windowStart",1,"col-sm-1"],[1,"col-sm-2"],["formControlName","timeStart","id","windowStart","min","0","required","","size","5","step","any","type","number",1,"form-control"],["for","windowEnd",1,"col-sm-1"],["formControlName","timeEnd","id","windowEnd","min","0","placeholder","","required","","size","5","step","any","type","number",1,"form-control"],[1,"form-group","row"],["for","detrending",1,"col-sm-4"],[3,"click"],[1,"material-icons","bd-icon","bd-primary"],[1,"col-sm-6"],["formControlName","detrending","id","detrending","required","",1,"form-control"],[3,"value",4,"ngFor","ngForOf"],["class","col-sm-12",4,"ngIf"],["for","method",1,"col-sm-4"],["formControlName","method","id","method","required","",1,"form-control"],["formControlName","preset","id","preset","required","",1,"form-control"],["formGroupName","periodScale",1,"form-group","row",3,"hidden"],["for","periodMin",1,"col-sm-1"],["formControlName","periodMin","id","periodMin","max","50","min","10","placeholder","","required","","size","5","step","any","type","number",1,"form-control"],["for","periodMax",1,"col-sm-1"],["formControlName","periodMax","id","periodMax","max","50","min","10","placeholder","","required","","size","5","step","any","type","number",1,"form-control"],[1,"col-sm-8"],[3,"page","length","disabled","pageSize","pageIndex","pageSizeOptions"],["type","button",1,"btn","btn-primary",3,"click","disabled"],[3,"value"],[1,"col-sm-12"],["role","alert","type","info",1,"alert","alert-info"],["href","https://dx.doi.org/10.1177%2F0748730410379711"],["href"," https://doi.org/10.1371/journal.pcbi.1004094","target","_blank"]],template:function(i,n){if(i&1){let c=R();r(0,"form",1)(1,"div",2)(2,"div",3)(3,"label",4),a(4,"Data window"),o(),r(5,"label",5),a(6,"from:"),o(),r(7,"div",6),d(8,"input",7),o(),r(9,"label",8),a(10,"to:"),o(),r(11,"div",6),d(12,"input",9),o()(),r(13,"div",10)(14,"label",11),a(15,"Input Data "),r(16,"a",12),h("click",function(){return u(c),f(n.dataHelp=!n.dataHelp)}),r(17,"i",13),a(18,"help"),o()()(),r(19,"div",14)(20,"select",15),p(21,Ki,2,2,"option",16),o()()()(),p(22,qi,7,0,"div",17),r(23,"div",10)(24,"label",18),a(25,"Test Method "),r(26,"a",12),h("click",function(){return u(c),f(n.methodHelp=!n.methodHelp)}),r(27,"i",13),a(28,"help"),o()()(),r(29,"div",14)(30,"select",19),p(31,Li,2,2,"option",16),o()()(),p(32,zi,20,0,"div",17),r(33,"div",10)(34,"label",18),a(35,"Analysis Presets "),r(36,"a",12),h("click",function(){return u(c),f(n.presetsHelp=!n.presetsHelp)}),r(37,"i",13),a(38,"help"),o()()(),r(39,"div",14)(40,"select",20),p(41,Ui,2,2,"option",16),o()()(),p(42,Gi,25,0,"div",17),r(43,"div",21)(44,"label",4),a(45,"Expected periods"),o(),r(46,"label",22),a(47,"from:"),o(),r(48,"div",6),d(49,"input",23),o(),r(50,"label",24),a(51,"to:"),o(),r(52,"div",6),d(53,"input",25),o()(),r(54,"div",10),d(55,"label",6),r(56,"div",26)(57,"mat-paginator",27,0),h("page",function(_){return u(c),f(n.loadDataPage(_))}),o()()(),r(59,"button",28),h("click",function(){return u(c),f(n.analyse())}),a(60,"Test Rhythmicity "),o()()}i&2&&(l("formGroup",n.mainForm),m(21),l("ngForOf",n.detrendingOptions),m(),l("ngIf",n.dataHelp),m(9),l("ngForOf",n.methodOptions),m(),l("ngIf",n.methodHelp),m(9),l("ngForOf",n.presetOptions),m(),l("ngIf",n.presetsHelp),m(),l("hidden",!0),m(14),l("length",n.totalTraces)("disabled",n.disabledPagination)("pageSize",n.currentPage.pageSize)("pageIndex",n.currentPage.pageIndex)("pageSizeOptions",j(14,Ai)),m(2),l("disabled",n.disabled||n.mainForm.invalid))},dependencies:[V,D,te,Be,$e,Me,Fe,Ne,je,ee,Ke,Ae,He,ke,Ve,Je,ie],encapsulation:2})}}return t})();function Wi(t,s){if(t&1&&d(0,"bd2-ts-plots",3),t&2){let e=y(3);l("data",e.timeseries)("tracesPerPlot",e.tracesPerPlot)}}function Yi(t,s){if(t&1){let e=R();r(0,"div")(1,"bd2-rhythmicityjob-params-rform",1),h("displayParams",function(n){u(e);let c=y(2);return f(c.emitDisplayParams(n))})("rhythmicityRequests",function(n){u(e);let c=y(2);return f(c.doAnalysis(n))}),o(),d(2,"hr"),p(3,Wi,1,2,"bd2-ts-plots",2),o()}if(t&2){let e=y(2);m(),l("disabled",e.blocked)("totalTraces",e.totalTraces)("currentPage",e.currentPage),m(2),l("ngIf",e.timeseries)}}function Xi(t,s){if(t&1&&(r(0,"div")(1,"h3"),a(2,"Start rhythmicity test"),o(),d(3,"hr"),p(4,Yi,4,4,"div",0),o()),t&2){let e=y();m(4),l("ngIf",!e.disabled)}}var Vt=(()=>{class t extends se{constructor(e,i,n,c,b){super(c,b),this.fetcher=e,this.analytics=i,this.userService=n,this.disabled=!1,this.blocked=!1,this.tracesPerPlot=5,this.totalTraces=0,this.currentPage=dt.firstPage(),this.titlePart=" New Test"}ngOnInit(){super.ngOnInit(),this.timeSeriesSubsripction=this.fetcher.seriesPackStream.pipe(_e(1e3)).subscribe(e=>{let i=e.data;this.tracesPerPlot=Math.max(5,i.length/20),this.timeseries=i,this.totalTraces=e.totalTraces,this.currentPage=e.currentPage},e=>{console.log("Error in TS subscription: "+e),this.feedback.error(e)})}ngOnDestroy(){this.timeSeriesSubsripction&&this.timeSeriesSubsripction.unsubscribe(),this.fetcher.ngOnDestroy(),super.ngOnDestroy()}emitDisplayParams(e){this.fetcher.changeDisplayParams(e)}doAnalysis(e){e.isValid()&&(this.blocked=!0,this.rhythmicityService.newTest(this.assay,e).subscribe(i=>{this.feedback.success("Rhythmicity test submitted"),this.analytics.rhythmicityNew(e.method.name,this.assay.id,this.userService.currentUser.login),this.refreshModel(),this.goToRhythmicityHome()},i=>{this.blocked=!1,this.feedback.error(i)}))}updateModel(e){this.fetcher.experiment(e),super.updateModel(e)}static{this.\u0275fac=function(i){return new(i||t)(g(ae),g(De),g(Ie),g(w),g(N))}}static{this.\u0275cmp=T({type:t,selectors:[["ng-component"]],standalone:!1,features:[J([ae]),M],decls:1,vars:1,consts:[[4,"ngIf"],[3,"displayParams","rhythmicityRequests","disabled","totalTraces","currentPage"],[3,"data","tracesPerPlot",4,"ngIf"],[3,"data","tracesPerPlot"]],template:function(i,n){i&1&&p(0,Xi,5,1,"div",0),i&2&&l("ngIf",n.assay)},dependencies:[D,_t,Jt],encapsulation:2})}}return t})();var Zi=[{path:"",children:[{path:"new",component:Vt},{path:"",component:kt,pathMatch:"full"}]}],Nt=(()=>{class t{static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275mod=G({type:t})}static{this.\u0275inj=U({imports:[ue.forChild(Zi),ue]})}}return t})();var Dr=(()=>{class t{static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275mod=G({type:t})}static{this.\u0275inj=U({imports:[Pe,Le,ze,It,wt,Tt,Nt]})}}return t})();export{Dr as RhythmicityModule};
