import{a as K,b as ft,c as q,d as ye,e as yt,f as bt,g as $,h as _t,i as E}from"./chunk-2KOYKWRC.js";import{a as Pt,b as It,c as Dt}from"./chunk-CXIY722G.js";import{e as Mt}from"./chunk-LOLEZELW.js";import{a as Me}from"./chunk-I53LRGHG.js";import{a as ct}from"./chunk-UYPC2SWM.js";import"./chunk-ZQDRPM5J.js";import{a as ht,e as A,g as se,h as ut,j as gt,k as vt,n as Et}from"./chunk-MI2O5RFT.js";import{a as re}from"./chunk-JESAVJXP.js";import{a as Ct,b as St,g as xt,h as Tt,i as Rt,o as wt}from"./chunk-THGCCJUJ.js";import{b as B,c as dt}from"./chunk-5VP5V2NG.js";import"./chunk-ZUXWEGFT.js";import"./chunk-URHLGKLM.js";import"./chunk-FDKJ75ZE.js";import{A as pt,d as Qe,e as ne,g as Ye,l as Xe,n as tt,o as it,p as nt,r as rt,s as at,u as ot,v as st,x as mt,y as lt}from"./chunk-D224IPLR.js";import{d as We}from"./chunk-VDA2LVPM.js";import{a as Ge,n as et}from"./chunk-PGRVX3MW.js";import{i as Ze}from"./chunk-6KRAEQXB.js";import{D as Le,E as ze,F as Ue,G as ae,I as oe,a as De,d as je,f as H,h as Oe,i as te,j as Fe,m as ie,n as ke,q as Je,r as Ve,s as Ne,t as Be,u as $e,v as He,w as Ae,x as Ke,y as qe}from"./chunk-6XVRX2RL.js";import{$ as Se,C as ge,Da as j,Ga as c,Ia as p,Ja as xe,Ka as Te,Kb as N,Lb as D,Nb as Z,O as ve,Ob as we,Pb as Ee,Qb as Pe,R as U,Ra as r,S as G,Sa as a,Ta as d,U as k,Ua as S,Va as x,Xa as R,Y as w,Z as Q,_ as Ce,_a as u,aa as f,ab as b,ba as y,dc as Ie,fb as W,fc as fe,gb as Y,hb as X,ib as Re,j as be,ja as M,jb as o,kb as C,kc as ee,lb as J,mb as ue,ra as l,rb as V,sa as v,tb as O,wb as T,x as _e,xb as F,yb as P}from"./chunk-BWZCNJMV.js";var me=(()=>{let n=class n extends dt{constructor(e,t){super(t),this.rhythmicityService=e,this.titlePart=" Rhythm"}goToRhythmicityHome(e){let t=this.expHomePath(e);t.push("rhythmicity"),this.router.navigate(t)}};n.\u0275fac=function(t){return new(t||n)(v(E),v(B))},n.\u0275dir=Ce({type:n,features:[j]});let i=n;return i})();var le=(()=>{let n=class n extends It{get currentJob(){return this.currentAsset}constructor(e,t=!1){super(t),this.rhythmicityService=e,this.finishedJob$=this.finished$,this.runningJob$=this.running$,this.allJob$=this.all$}initIntervalsKeeper(){return new Pt(1e3,30*1e3,10*60*1e3,2)}assayJob(e){this.input(e)}sameInput(e,t){return e[1]===t[1]&&e[0]===t[0]}fetchAsset([e,t]){return this.rhythmicityService.getJob(e,t)}hasFailed(e){return $.hasFailed(e)}isFinished(e){return $.isFinished(e)}isRunning(e){return $.isRunning(e)}assetToId(e){return e.jobId}assetToInput(e){return[e.parentId,e.jobId]}};n.\u0275fac=function(t){return new(t||n)(k(E),k(re,8))},n.\u0275prov=U({token:n,factory:n.\u0275fac});let i=n;return i})();var pe=(()=>{let n=class n extends Dt{constructor(e,t=!1){super(t),this.rhythmicityService=e,this.results$=this.data$}isClassicJob(){return this.currentInput?.parameters?.METHOD==="BD2JTK"}sameInput(e,t){return $.sameJob(e,t)}assetToData(e,t){return e.results}fetchAsset(e){return this.rhythmicityService.getResults(e.parentId,e.jobId).pipe(ve(t=>this.labelPatterns(t)))}sortingKey(e){switch(e.active){case"label":return t=>t.label;case"id":return t=>+t.id;case"empp":return t=>+t.result.empP;case"emppbh":return t=>+t.result.empPBH;case"p":return t=>+t.result.p;case"pbh":return t=>+t.result.pBH;case"tau":return t=>+t.result.tau;case"period":return t=>t.result.pattern.period;case"peak":return t=>t.result.pattern.peak;case"trough":return t=>t.result.pattern.trough;default:return console.error("Not implemented sorting for "+e.active),t=>0}}processData(e,t){return t&&this.rankResults(e,t.pValue,t.bhCorrection,this.isClassicJob()),e}labelPatterns(e){e.results.forEach(t=>{t.result.patternLabel=this.describePattern(t.result),t.result.pattern.shapeLabel=this.patternToShape(t.result.pattern)})}describePattern(e){let t=e.pattern,s=Math.round(t.period*10)/10,h=Math.round(t.peak*100)/100,_=Math.round(t.trough*100)/100;return`${this.patternToShape(t)}	${s}	${h}	${_}`}patternToShape(e){switch(e.waveform){case"ASYM_COSINE":return e.leftPortion===.5?"COS":"ACOS";case"ASYM_COS_SPIKE":return"SPIKE";case"ASYM_COS_SPIKE_NEG":return"NPIKE";default:return e.waveform}}rankResults(e,t,s,h){e.forEach(_=>{let g=_.result,he;h?he=s?g.pBH:g.p:he=s?g.empPBH:g.empP,g.rhythmic=he<t})}};n.\u0275fac=function(t){return new(t||n)(k(E),k(re,8))},n.\u0275prov=U({token:n,factory:n.\u0275fac});let i=n;return i})();var Ot=()=>[10,25,50,100,250];function qt(i,n){i&1&&d(0,"mat-progress-bar",28)}function Lt(i,n){i&1&&(r(0,"th",29),o(1,"Id"),a())}function zt(i,n){if(i&1&&(r(0,"td",30),o(1),a()),i&2){let m=n.$implicit;l(),C(m.id)}}function Ut(i,n){i&1&&(r(0,"th",29),o(1,"Label"),a())}function Gt(i,n){if(i&1&&(r(0,"td",31),o(1),a()),i&2){let m=n.$implicit;l(),C(m.label)}}function Qt(i,n){i&1&&(r(0,"th",32),o(1,"Rhythmic"),a())}function Wt(i,n){if(i&1&&(r(0,"td",30),o(1),a()),i&2){let m=n.$implicit;Te("bold",m.result.rhythmic),l(),C(m.result.rhythmic)}}function Yt(i,n){i&1&&(r(0,"th",29),o(1,"emp-p"),a())}function Xt(i,n){if(i&1&&(r(0,"td",30),o(1),T(2,"number"),a()),i&2){let m=n.$implicit;l(),C(P(2,1,m.result.empP,"1.0-5"))}}function Zt(i,n){i&1&&(r(0,"th",29),o(1,"BH emp-p"),a())}function ei(i,n){if(i&1&&(r(0,"td",30),o(1),T(2,"number"),a()),i&2){let m=n.$implicit;l(),C(P(2,1,m.result.empPBH,"1.0-5"))}}function ti(i,n){i&1&&(r(0,"th",29),o(1,"Tau"),a())}function ii(i,n){if(i&1&&(r(0,"td",30),o(1),T(2,"number"),a()),i&2){let m=n.$implicit;l(),C(P(2,1,m.result.tau,"1.0-2"))}}function ni(i,n){i&1&&(r(0,"th",29),o(1,"p"),a())}function ri(i,n){if(i&1&&(r(0,"td",30),o(1),T(2,"number"),a()),i&2){let m=n.$implicit;l(),C(P(2,1,m.result.p,"1.0-5"))}}function ai(i,n){i&1&&(r(0,"th",29),o(1,"BH p"),a())}function oi(i,n){if(i&1&&(r(0,"td",30),o(1),T(2,"number"),a()),i&2){let m=n.$implicit;l(),C(P(2,1,m.result.pBH,"1.0-5"))}}function si(i,n){i&1&&(r(0,"th",32),o(1,"Pattern"),a())}function mi(i,n){if(i&1&&(r(0,"td",30),o(1),a()),i&2){let m=n.$implicit;l(),C(m.result.patternLabel)}}function li(i,n){i&1&&(r(0,"th",32),o(1,"P.Shape"),a())}function pi(i,n){if(i&1&&(r(0,"td",30),o(1),a()),i&2){let m=n.$implicit;l(),C(m.result.pattern.shapeLabel)}}function ci(i,n){i&1&&(r(0,"th",29),o(1,"P.Period"),a())}function di(i,n){if(i&1&&(r(0,"td",30),o(1),T(2,"number"),a()),i&2){let m=n.$implicit;l(),C(P(2,1,m.result.pattern.period,"1.0-1"))}}function hi(i,n){i&1&&(r(0,"th",29),o(1,"P.Peak"),a())}function ui(i,n){if(i&1&&(r(0,"td",30),o(1),T(2,"number"),a()),i&2){let m=n.$implicit;l(),C(P(2,1,m.result.pattern.peak,"1.1-1"))}}function fi(i,n){i&1&&(r(0,"th",32),o(1,"P.Peak"),a())}function yi(i,n){if(i&1&&(r(0,"td",30),o(1),T(2,"number"),a()),i&2){let m=n.$implicit;l(),C(P(2,1,m.result.pattern.peak*24/m.result.pattern.period,"1.1-1"))}}function bi(i,n){i&1&&(r(0,"th",29),o(1,"P.Trough"),a())}function _i(i,n){if(i&1&&(r(0,"td",30),o(1),T(2,"number"),a()),i&2){let m=n.$implicit;l(),C(P(2,1,m.result.pattern.trough,"1.1-1"))}}function gi(i,n){i&1&&(r(0,"th",32),o(1,"P.Trough"),a())}function vi(i,n){if(i&1&&(r(0,"td",30),o(1),T(2,"number"),a()),i&2){let m=n.$implicit;l(),C(P(2,1,m.result.pattern.trough*24/m.result.pattern.period,"1.1-1"))}}function Ci(i,n){i&1&&d(0,"tr",33)}function Si(i,n){i&1&&d(0,"tr",34)}var ce=(()=>{let n=class n{set job(e){e&&this.fetcher.input(e)}set statTestParams(e){if(e){this.fetcher.params(e);let t=e.bhCorrection?this.bhEmpPColumns:this.normEmpPColumns;this.fetcher.isClassicJob()&&(t=e.bhCorrection?this.bhClsPColumns:this.normClsPColumns),e.showPattern&&(t=e.circadian?t.concat(this.patternColumnsC):t.concat(this.patternColumns)),this.displayedColumns=t}}constructor(e,t){this.fetcher=e,this.feedback=t,this.normEmpPColumns=["id","label","rhythmic","empp","tau"],this.normClsPColumns=["id","label","rhythmic","p","tau"],this.bhEmpPColumns=["id","label","rhythmic","emppbh","tau"],this.bhClsPColumns=["id","label","rhythmic","pbh","tau"],this.patternColumns=["shape","period","peak","trough"],this.patternColumnsC=["shape","period","peakc","troughc"],this.displayedColumns=this.normEmpPColumns,this.disablePaginator=!1}ngOnInit(){this.fetcher.error$.subscribe(t=>this.feedback.error(t));let e=new Qe;e.pageSize=25,e.pageIndex=0,this.fetcher.page(e),this.fetcher.on(!0)}ngOnDestroy(){this.fetcher.close()}ngAfterViewInit(){}reload(){this.fetcher.refresh()}sortData(e){this.fetcher.sort(e)}loadPage(e){this.fetcher.page(e)}};n.\u0275fac=function(t){return new(t||n)(v(pe),v(ee))},n.\u0275cmp=w({type:n,selectors:[["bd2-rhythmicity-results-mdtable"]],inputs:{job:"job",statTestParams:"statTestParams"},features:[V([pe])],decls:55,vars:18,consts:[["paginator",""],["paginator2",""],[1,"mat-elevation-z8"],["mode","indeterminate",4,"ngIf"],[3,"page","length","disabled","pageSize","pageIndex","pageSizeOptions"],["mat-table","","matSort","","aria-label","Results","matSort","","matSortActive","id","matSortDirection","asc",1,"full-width-table",3,"matSortChange","dataSource"],["matColumnDef","id"],["mat-header-cell","","mat-sort-header","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","label"],["mat-cell","","class","word_wrapping","style","max-width: 100px",4,"matCellDef"],["matColumnDef","rhythmic"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",3,"bold",4,"matCellDef"],["matColumnDef","empp"],["matColumnDef","emppbh"],["matColumnDef","tau"],["matColumnDef","p"],["matColumnDef","pbh"],["matColumnDef","pattern"],["matColumnDef","shape"],["matColumnDef","period"],["matColumnDef","peak"],["matColumnDef","peakc"],["matColumnDef","trough"],["matColumnDef","troughc"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mode","indeterminate"],["mat-header-cell","","mat-sort-header",""],["mat-cell",""],["mat-cell","",1,"word_wrapping",2,"max-width","100px"],["mat-header-cell",""],["mat-header-row",""],["mat-row",""]],template:function(t,s){if(t&1){let h=R();r(0,"div",2),c(1,qt,1,0,"mat-progress-bar",3),T(2,"async"),r(3,"mat-paginator",4,0),u("page",function(g){return f(h),y(s.loadPage(g))}),a(),r(5,"table",5),u("matSortChange",function(g){return f(h),y(s.sortData(g))}),S(6,6),c(7,Lt,2,0,"th",7)(8,zt,2,1,"td",8),x(),S(9,9),c(10,Ut,2,0,"th",7)(11,Gt,2,1,"td",10),x(),S(12,11),c(13,Qt,2,0,"th",12)(14,Wt,2,3,"td",13),x(),S(15,14),c(16,Yt,2,0,"th",7)(17,Xt,3,4,"td",8),x(),S(18,15),c(19,Zt,2,0,"th",7)(20,ei,3,4,"td",8),x(),S(21,16),c(22,ti,2,0,"th",7)(23,ii,3,4,"td",8),x(),S(24,17),c(25,ni,2,0,"th",7)(26,ri,3,4,"td",8),x(),S(27,18),c(28,ai,2,0,"th",7)(29,oi,3,4,"td",8),x(),S(30,19),c(31,si,2,0,"th",12)(32,mi,2,1,"td",8),x(),S(33,20),c(34,li,2,0,"th",12)(35,pi,2,1,"td",8),x(),S(36,21),c(37,ci,2,0,"th",7)(38,di,3,4,"td",8),x(),S(39,22),c(40,hi,2,0,"th",7)(41,ui,3,4,"td",8),x(),S(42,23),c(43,fi,2,0,"th",12)(44,yi,3,4,"td",8),x(),S(45,24),c(46,bi,2,0,"th",7)(47,_i,3,4,"td",8),x(),S(48,25),c(49,gi,2,0,"th",12)(50,vi,3,4,"td",8),x(),c(51,Ci,1,0,"tr",26)(52,Si,1,0,"tr",27),a(),r(53,"mat-paginator",4,1),u("page",function(g){return f(h),y(s.loadPage(g))}),a()()}t&2&&(l(),p("ngIf",F(2,14,s.fetcher.isBusy$)),l(2),p("length",s.fetcher.dataLength)("disabled",s.disablePaginator)("pageSize",(s.fetcher.currentPage==null?null:s.fetcher.currentPage.pageSize)||25)("pageIndex",s.fetcher.currentPage==null?null:s.fetcher.currentPage.pageIndex)("pageSizeOptions",O(16,Ot)),l(2),p("dataSource",s.fetcher.results$),l(46),p("matHeaderRowDef",s.displayedColumns),l(),p("matRowDefColumns",s.displayedColumns),l(),p("length",s.fetcher.dataLength)("disabled",s.disablePaginator)("pageSize",(s.fetcher.currentPage==null?null:s.fetcher.currentPage.pageSize)||25)("pageIndex",s.fetcher.currentPage==null?null:s.fetcher.currentPage.pageIndex)("pageSizeOptions",O(17,Ot)))},dependencies:[D,ne,Tt,Rt,tt,nt,st,rt,it,mt,at,ot,lt,pt,Ye,Z,Ee],styles:[".full-width-table[_ngcontent-%COMP%]{width:100%}"]});let i=n;return i})();function Ri(i,n){if(i&1&&(r(0,"mat-radio-button",5),o(1),a()),i&2){let m=n.$implicit;p("value",m),l(),C(m)}}var Ft=(()=>{let n=class n{constructor(){this.values=[1e-4,.001,.005,.01,.05,.1],this.pvalue=.001,this.pvalue$=new M}ngOnInit(){}ngAfterViewInit(){this.pvalue$.emit(this.pvalue)}selected(e){this.pvalue$.emit(e.value)}};n.\u0275fac=function(t){return new(t||n)},n.\u0275cmp=w({type:n,selectors:[["bd2-pvalue-form"]],outputs:{pvalue$:"pvalue$"},decls:8,vars:2,consts:[[1,"form-inline"],[1,"mx-auto","text-center"],["id","pvalues-label",1,"mb-1"],["aria-label","Select p-value","aria-labelledby","pvalues-label",3,"change","value"],[3,"value",4,"ngFor","ngForOf"],[3,"value"]],template:function(t,s){t&1&&(r(0,"form",0)(1,"div",1)(2,"mat-label",2)(3,"strong"),o(4,"p-value threshold:"),a()(),r(5,"div")(6,"mat-radio-group",3),u("change",function(_){return s.selected(_)}),c(7,Ri,2,2,"mat-radio-button",4),a()()()()),t&2&&(l(6),p("value",s.pvalue),l(),p("ngForOf",s.values))},dependencies:[N,ie,te,Fe,Ge,Ct,St],styles:[".mat-mdc-radio-button[_ngcontent-%COMP%]{margin-right:15px}"]});let i=n;return i})();var kt=(()=>{let n=class n{constructor(){this.options=new M,this.currentOptions=new _t(0,!1,!1,!1)}ngOnInit(){}pValue(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.pValue=e,this.options.next(this.currentOptions)}bhCorrection(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.bhCorrection=e,this.options.next(this.currentOptions)}circadian(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.circadian=e,this.options.next(this.currentOptions)}showPattern(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.showPattern=e,this.options.next(this.currentOptions)}};n.\u0275fac=function(t){return new(t||n)},n.\u0275cmp=w({type:n,selectors:[["bd2-stat-test-options-widget"]],outputs:{options:"options"},decls:14,vars:1,consts:[["pattern",""],["appearance","outlined"],[3,"pvalue$"],[2,"margin-top","0.5em","text-align","center"],[3,"change"],[3,"change","disabled"]],template:function(t,s){if(t&1){let h=R();r(0,"mat-card",1)(1,"mat-card-content")(2,"section")(3,"bd2-pvalue-form",2),u("pvalue$",function(g){return f(h),y(s.pValue(g))}),a()(),r(4,"section",3)(5,"mat-slide-toggle",4),u("change",function(g){return f(h),y(s.bhCorrection(g.checked))}),o(6,"Benjamini Hochberg correction"),a()(),r(7,"section",3)(8,"mat-slide-toggle",4,0),u("change",function(g){return f(h),y(s.showPattern(g.checked))}),o(10,"show pattern"),a(),o(11," \xA0 "),r(12,"mat-slide-toggle",5),u("change",function(g){return f(h),y(s.circadian(g.checked))}),o(13,"circadian unit"),a()()()()}if(t&2){let h=Re(9);l(12),p("disabled",!h.checked)}},dependencies:[Xe,ae,oe,Ft],encapsulation:2});let i=n;return i})();function Ii(i,n){if(i&1){let m=R();r(0,"div",5)(1,"button",14),u("click",function(){f(m);let t=b(2);return y(t.delete())}),r(2,"i",4),o(3,"delete_forever"),a()(),r(4,"button",15),u("click",function(){f(m);let t=b(2);return y(t.export())}),r(5,"i",4),o(6,"save_alt"),a()()()}}function Di(i,n){if(i&1&&(r(0,"div",16),d(1,"br"),o(2),a()),i&2){let m=b().ngIf;l(2),J("ERROR: ",m.jobStatus.message," ")}}function Mi(i,n){i&1&&(r(0,"div")(1,"mat-card",9)(2,"mat-card-content"),d(3,"mat-spinner",17),a()()())}function ji(i,n){i&1&&(r(0,"div")(1,"mat-card",9)(2,"mat-card-content")(3,"div",18),o(4,"It may take up to 10 minutes to test for rhythmicity"),a()()()())}function Oi(i,n){if(i&1){let m=R();S(0),r(1,"bd2-stat-test-options-widget",19),u("options",function(t){f(m);let s=b(3);return y(s.statTestOptions(t))}),a(),d(2,"bd2-rhythmicity-results-mdtable",20),x()}if(i&2){let m=n.ngIf,e=b(3);l(2),p("statTestParams",e.statTestParams)("job",m)}}function Fi(i,n){if(i&1&&(r(0,"div"),d(1,"mat-divider"),c(2,Mi,4,0,"div",13),T(3,"async"),c(4,ji,5,0,"div",13)(5,Oi,3,2,"ng-container",13),T(6,"async"),a()),i&2){let m=b().ngIf,e=b();l(2),p("ngIf",F(3,3,e.rhythmicityJobDatasource.isReloading$)),l(2),p("ngIf",m.jobStatus.state==="SUBMITTED"),l(),p("ngIf",F(6,5,e.rhythmicityJobDatasource.finishedJob$))}}function ki(i,n){if(i&1){let m=R();r(0,"div",1)(1,"div",2)(2,"div",3),u("click",function(){f(m);let t=b();return y(t.toggleExpanded())}),r(3,"i",4),o(4,"waves"),a(),o(5),T(6,"date"),d(7,"br"),o(8),a(),r(9,"div",5),o(10),r(11,"a",6),u("click",function(){f(m);let t=b();return y(t.refresh())}),r(12,"i",7),o(13,"refresh"),a()()()(),r(14,"div",8)(15,"mat-card",9)(16,"mat-card-content")(17,"div",10),c(18,Ii,7,0,"div",11),o(19),c(20,Di,3,1,"div",12),a()()(),c(21,Fi,7,7,"div",13),a()()}if(i&2){let m=n.ngIf,e=b();l(3),xe("color",e.isExpanded?"green":"red")("font-size",150,"%"),l(2),ue(" \xA0",e.shortUUID(m.jobId)," (",F(6,13,e.toLocalDateTime(m.jobStatus.submitted)),") "),l(3),ue(" ",e.friendlyMethod(m.parameters.METHOD),"; \xA0 waveforms: ",m.parameters.PRESET," "),l(2),J(" ",m.jobStatus.state," "),l(8),p("ngIf",e.assay.security.canWrite),l(),J(" ",m.parameters.PARAMS_SUMMARY," "),l(),p("ngIf",m.jobStatus.message&&m.jobStatus.message!="OK"),l(),p("ngIf",e.isExpanded)}}var de=(()=>{let n=class n{set expanded(e){this.isExpanded=e,this.expandedToogleStream.next(e)}constructor(e,t,s,h){this.rhythmicityService=e,this.rhythmicityJobDatasource=t,this.feedback=s,this.dialogs=h,this.deleted=new M,this.isExpanded=!1,this.expandedToogleStream=new be(!1)}ngOnInit(){this.initSubscriptions()}ngOnDestroy(){this.rhythmicityJobDatasource.close(),this.expandedToogleStream&&this.expandedToogleStream.complete()}ngOnChanges(e){(e.jobId||e.assay)&&this.jobId&&this.assay&&this.rhythmicityJobDatasource.assayJob([this.assay.id,this.jobId])}statTestOptions(e){let t=_e(1).subscribe(()=>{this.statTestParams=e,t&&t.unsubscribe()})}export(){this.rhythmicityService.downloadJob(this.assay.id,this.jobId).subscribe(e=>{this.saveJobBlob(e,this.assay.id,this.jobId)},e=>this.feedback.error(e))}saveJobBlob(e,t,s){let h={fileName:t+"_job"+this.shortUUID(s)+".rhythmicity.csv",extensions:[".csv"]};ut(e,h).then(_=>{}).catch(_=>console.log("could not save export",_))}refresh(){this.rhythmicityJobDatasource.refresh(),this.resultsTable&&this.resultsTable.reload()}delete(){let e=this.assay,t=this.rhythmicityJobDatasource.currentJob;this.dialogs.confirm("Do you want to delete analysis: "+t.jobId,t.parameters.PARAMS_SUMMARY).subscribe(s=>{s&&this.doDelete(e,t.jobId)})}initSubscriptions(){this.rhythmicityJobDatasource.on(!0),this.rhythmicityJobDatasource.error$.forEach(e=>this.feedback.error(e))}doDelete(e,t){this.rhythmicityService.deleteJob(e,t).subscribe(s=>{this.deleted.next(s),this.feedback.success("Job: "+this.shortUUID(t)+" deleted")},s=>{this.feedback.error(s)})}toggleExpanded(){this.expanded=!this.isExpanded}toLocalDateTime(e){return We.deserialize(e).date}shortUUID(e){return Ze(e)}friendlyMethod(e){return e==="BD2JTK"?"Classic JTK":e==="BD2EJTK"?"BD2 eJTK":e}};n.\u0275fac=function(t){return new(t||n)(v(E),v(le),v(ee),v(ct))},n.\u0275cmp=w({type:n,selectors:[["bd2-rhythmicity-job-pane"]],viewQuery:function(t,s){if(t&1&&W(ce,5),t&2){let h;Y(h=X())&&(s.resultsTable=h.first)}},inputs:{jobId:"jobId",assay:"assay",expanded:"expanded"},outputs:{deleted:"deleted"},features:[V([le]),Se],decls:2,vars:3,consts:[["class","card mb-2",4,"ngIf"],[1,"card","mb-2"],[1,"card-header","clearfix"],["role","button",1,"float-left",3,"click"],[1,"material-icons","bd-icon"],[1,"float-right"],["role","button","aria-label","refresh",3,"click"],[1,"material-icons","bd-icon","bd-primary"],[1,"card-body"],["appearance","outlined"],[1,"clearfix"],["class","float-right",4,"ngIf"],["class","text-danger","style","word-wrap: break-word;",4,"ngIf"],[4,"ngIf"],["type","button",1,"btn","btn-danger","btn-sm","mr-1",3,"click"],["type","button",1,"btn","btn-primary","btn-sm",3,"click"],[1,"text-danger",2,"word-wrap","break-word"],[1,"center-block"],[2,"margin-top","0.5em","text-align","center"],[3,"options"],[3,"statTestParams","job"]],template:function(t,s){t&1&&(c(0,ki,22,15,"div",0),T(1,"async")),t&2&&p("ngIf",F(1,1,s.rhythmicityJobDatasource.allJob$))},dependencies:[D,xt,ae,oe,et,ce,kt,Z,we],encapsulation:2});let i=n;return i})();var Vi=()=>["new"];function Ni(i,n){if(i&1&&(r(0,"div")(1,"strong"),o(2),a()()),i&2){let m=b(2);l(2),J("Submitted jobs: ",m.jobs.length,"")}}function Bi(i,n){i&1&&(r(0,"div"),o(1," No jobs submitted, start a new test. "),a())}function $i(i,n){i&1&&(r(0,"a",7),o(1," New test "),a()),i&2&&p("routerLink",O(1,Vi))}function Hi(i,n){if(i&1){let m=R();r(0,"div")(1,"bd2-rhythmicity-job-pane",8),u("deleted",function(t){f(m);let s=b(2);return y(s.remove(t))}),a()()}if(i&2){let m=n.$implicit,e=n.index,t=b(2);l(),p("assay",t.assay)("jobId",m)("expanded",t.expandAll||e==0)}}function Ai(i,n){if(i&1){let m=R();r(0,"div")(1,"h3"),o(2,"Rhythmicity tests"),a(),d(3,"hr"),r(4,"div",1)(5,"div",2),c(6,Ni,3,1,"div",0)(7,Bi,2,0,"div",0),a(),r(8,"div",3),c(9,$i,2,2,"a",4),r(10,"button",5),u("click",function(){f(m);let t=b();return y(t.refresh())}),o(11,"Refresh "),a()()(),d(12,"hr"),c(13,Hi,2,3,"div",6),d(14,"hr"),a()}if(i&2){let m=b();l(6),p("ngIf",m.jobs&&m.jobs.length>0),l(),p("ngIf",!m.jobs||m.jobs.length==0),l(2),p("ngIf",m.assay.security.canWrite),l(),p("disabled",m.blocked),l(3),p("ngForOf",m.jobsIds)}}var Jt=(()=>{let n=class n extends me{constructor(e,t){super(e,t),this.expandAll=!1,this.blocked=!1,this.titlePart=" Rhythm"}updateModel(e){super.updateModel(e),e&&this.loadJobs(e)}loadJobs(e,t=!1){this.blocked=!0,this.rhythmicityService.getJobs(e).subscribe(s=>{this.jobs=s,this.refreshJobsInfo(s),this.exportURL=this.rhythmicityService.exportURL(e),t&&this.refreshPanes(),this.blocked=!1},s=>{this.blocked=!1,this.feedback.error(s)})}refreshJobsInfo(e){this.jobsIds=e.map(t=>t.jobId)}refresh(){this.loadJobs(this.assay,!0)}refreshPanes(){this.panes&&this.panes.forEach(e=>e.refresh())}remove(e){let t=this.jobs.findIndex(s=>e.jobId===s.jobId);t>=0&&(this.jobs.splice(t,1),this.refreshJobsInfo(this.jobs))}refreshJob(e){let t=this.jobs.findIndex(s=>e.jobId===s.jobId);t>=0&&(this.jobs[t]=e,this.refreshJobsInfo(this.jobs))}calculateQueuing(e){return e.filter(t=>this.isQueueing(t.jobStatus.state)).length}isQueueing(e){switch(e){case"WAITING":return!0;case"PROCESSING":return!0;case"SUBMITTED":return!0;default:return!1}}checkFinished(e){return!!e.find(t=>this.isFinished(t.jobStatus.state))}isFinished(e){switch(e){case"SUCCESS":return!0;case"FINISHED":return!0;case"COMPLETED":return!0;default:return!1}}};n.\u0275fac=function(t){return new(t||n)(v(E),v(B))},n.\u0275cmp=w({type:n,selectors:[["ng-component"]],viewQuery:function(t,s){if(t&1&&W(de,5),t&2){let h;Y(h=X())&&(s.panes=h)}},features:[j],decls:1,vars:1,consts:[[4,"ngIf"],[1,"card"],[1,"card-header"],[1,"card-body"],["class","btn btn-primary mr-1",3,"routerLink",4,"ngIf"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],[4,"ngFor","ngForOf"],[1,"btn","btn-primary","mr-1",3,"routerLink"],[3,"deleted","assay","jobId","expanded"]],template:function(t,s){t&1&&c(0,Ai,15,5,"div",0),t&2&&p("ngIf",s.assay)},dependencies:[N,D,Ie,de],encapsulation:2});let i=n;return i})();var Ki=()=>[10,25,50,100,200];function qi(i,n){if(i&1&&(r(0,"option",29),o(1),a()),i&2){let m=n.$implicit;p("value",m.name),l(),C(m.label)}}function Li(i,n){i&1&&(r(0,"div",30)(1,"div",31),o(2," Rhythmicity tests are generally used for short, sparse timeseries. "),d(3,"br"),o(4," The current limit is 5 or 4 days of hourly sampled data for eJTK preset and BD2 preset respectivelly."),d(5,"br"),o(6," Generally the raw data are being analysed, but we also enabled a linear detrended option. "),a()())}function zi(i,n){if(i&1&&(r(0,"option",29),o(1),a()),i&2){let m=n.$implicit;p("value",m.name),l(),C(m.label)}}function Ui(i,n){i&1&&(r(0,"div",30)(1,"div",31)(2,"p")(3,"b"),o(4,"Classic JTK"),a(),o(5," is the implementation of JTK_CYCLE from "),r(6,"a",32),o(7,"Michael E. Hughes et al. 2010"),a(),o(8," a standard method for detecting rhythmicity in genome-scale datasets. "),d(9,"br"),o(10,"The method is fast but it is reliable only when it tests against small set of patterns, we provide patterns of 24h cosines with different phases."),a(),r(11,"p")(12,"b"),o(13,"BD2 eJTK"),a(),o(14," is the BioDare2 implementation of Empirical JTK_CYCLE with asymmetry search from "),r(15,"a",33),o(16,"Alan L. Hutchison et al. 2015"),a(),o(17,". It is similar to the classic JTK method but with p values empirically calculated against set of random noise data. "),d(18,"br"),o(19,"This modification permits using larger sets of test patterns and it provides better accuracy. However, this method is much slower so it can only analyze timeseries only up to 5 days of data (though the Classic JTK method was never intended to be used with such a long data)."),a()()())}function Gi(i,n){if(i&1&&(r(0,"option",29),o(1),a()),i&2){let m=n.$implicit;p("value",m.name),l(),C(m.label)}}function Qi(i,n){i&1&&(r(0,"div",30)(1,"div",31),o(2," Presets determine set of pattern curves against the comparison test is run."),d(3,"br"),r(4,"ul")(5,"li"),o(6,"Cosine 24h 1/2/4h are set of cosine curves of 24h periods, and phases spread every 1, 2, or 4 hours. To be used mainly with Classic JTK."),a(),r(7,"li"),o(8,"eJTK Classic is recommended for typical omics-like data for which eJTK method was developed. "),d(9,"br"),o(10," It works well for short data (48h, 2h- 1h-sampled) when actual period is within range 22-26 hours."),d(11,"br"),o(12," The patterns are series of cosine-like waveforms with 24h period, phases by 2hours and range of asymmetries by 2h (see original paper)."),d(13,"br"),a(),r(14,"li"),o(15,"BD2 Classic can detect non 24 periods and some forms of the spikes."),d(16,"br"),o(17," As it compares against much more patterns it has a weaker power."),d(18,"br"),o(19," It should be used when there is a good reason to suspect periods outside 22-26h range."),d(20,"br"),o(21," The patterns are series of cosine-like waverforms with periods from 18-35hours, for each period there are multiple "),r(22,"b"),o(23,"circadian"),a(),o(24," phases with step 2h (so each period value generates the same number of patterns but the peaks in absolute units do not coincide) and a range of assymetries by 2h in circadian units (see original paper). The preset contains also additional some spike patterns. "),a()()()())}var Vt=(()=>{let n=class n extends vt{constructor(e){super(e),this.methodOptions=ft,this.presetOptions=ye,this.dataHelp=!1,this.presetsHelp=!1,this.methodHelp=!1,this.rhythmicityRequests=new M,this.detrendingOptions=[A.NO_DTR,A.LIN_DTR],this.methodForm=this.mainForm.get("method"),this.presetForm=this.mainForm.get("preset")}buildMainForm(){return this.fb.group({displayParams:this.displayParamsForm,periodScale:this.fb.group({periodMin:[18,[H.required]],periodMax:[34,[H.required]]},{validator:t=>this.validPeriodScale(t.value)}),method:[K.BD2EJTK.name,[H.required]],preset:[q.EJTK_CLASSIC.name,[H.required]]})}ngOnInit(){super.ngOnInit(),this.methodForm.valueChanges.subscribe(e=>this.setPresetOptions(e))}ngOnDestroy(){super.ngOnDestroy()}setPresetOptions(e){e===K.BD2EJTK.name?(this.presetOptions=ye,this.presetForm.setValue(q.EJTK_CLASSIC.name)):e===K.BD2JTK.name?(this.presetOptions=yt,this.presetForm.setValue(q.COS_2H.name)):this.presetOptions=[]}defaultDetrending(){return A.NO_DTR.name}validPeriodScale(e){let t=e.periodMin,s=e.periodMax;return t<10?{validPeriodScale:"Period min must >= 10"}:s<10?{validPeriodScale:"Period max must >= 10"}:s>50?{validPeriodScale:"Period max must < 50"}:t>=s?{validPeriodScale:"Period min must be < max"}:null}analyse(){if(this.mainForm.invalid)return;let e=this.map2RhythmicityRequest(this.mainForm.value);e.isValid()&&this.rhythmicityRequests.next(e)}map2RhythmicityRequest(e){let t=new bt;return t.detrending=A.get(e.displayParams.detrending),t.method=K.get(e.method),t.preset=q.get(e.preset),t.periodMax=e.periodScale.periodMax,t.periodMin=e.periodScale.periodMin,t.windowEnd=e.displayParams.timeScale.timeEnd,t.windowStart=e.displayParams.timeScale.timeStart,t}};n.\u0275fac=function(t){return new(t||n)(v(Le))},n.\u0275cmp=w({type:n,selectors:[["bd2-rhythmicityjob-params-rform"]],inputs:{disabled:"disabled",totalTraces:"totalTraces",currentPage:"currentPage"},outputs:{displayParams:"displayParams",rhythmicityRequests:"rhythmicityRequests"},features:[j],decls:61,vars:15,consts:[["dataPaginator",""],["role","form",1,"form-horizontal",3,"formGroup"],["formGroupName","displayParams"],["formGroupName","timeScale",1,"form-group","row"],[1,"col-sm-4"],["for","windowStart",1,"col-sm-1"],[1,"col-sm-2"],["formControlName","timeStart","id","windowStart","min","0","required","","size","5","step","any","type","number",1,"form-control"],["for","windowEnd",1,"col-sm-1"],["formControlName","timeEnd","id","windowEnd","min","0","placeholder","","required","","size","5","step","any","type","number",1,"form-control"],[1,"form-group","row"],["for","detrending",1,"col-sm-4"],[3,"click"],[1,"material-icons","bd-icon","bd-primary"],[1,"col-sm-6"],["formControlName","detrending","id","detrending","required","",1,"form-control"],[3,"value",4,"ngFor","ngForOf"],["class","col-sm-12",4,"ngIf"],["for","method",1,"col-sm-4"],["formControlName","method","id","method","required","",1,"form-control"],["formControlName","preset","id","preset","required","",1,"form-control"],["formGroupName","periodScale",1,"form-group","row",3,"hidden"],["for","periodMin",1,"col-sm-1"],["formControlName","periodMin","id","periodMin","max","50","min","10","placeholder","","required","","size","5","step","any","type","number",1,"form-control"],["for","periodMax",1,"col-sm-1"],["formControlName","periodMax","id","periodMax","max","50","min","10","placeholder","","required","","size","5","step","any","type","number",1,"form-control"],[1,"col-sm-8"],[3,"page","length","disabled","pageSize","pageIndex","pageSizeOptions"],["type","button",1,"btn","btn-primary",3,"click","disabled"],[3,"value"],[1,"col-sm-12"],["role","alert","type","info",1,"alert","alert-info"],["href","https://dx.doi.org/10.1177%2F0748730410379711"],["href"," https://doi.org/10.1371/journal.pcbi.1004094","target","_blank"]],template:function(t,s){if(t&1){let h=R();r(0,"form",1)(1,"div",2)(2,"div",3)(3,"label",4),o(4,"Data window"),a(),r(5,"label",5),o(6,"from:"),a(),r(7,"div",6),d(8,"input",7),a(),r(9,"label",8),o(10,"to:"),a(),r(11,"div",6),d(12,"input",9),a()(),r(13,"div",10)(14,"label",11),o(15,"Input Data "),r(16,"a",12),u("click",function(){return f(h),y(s.dataHelp=!s.dataHelp)}),r(17,"i",13),o(18,"help"),a()()(),r(19,"div",14)(20,"select",15),c(21,qi,2,2,"option",16),a()()()(),c(22,Li,7,0,"div",17),r(23,"div",10)(24,"label",18),o(25,"Test Method "),r(26,"a",12),u("click",function(){return f(h),y(s.methodHelp=!s.methodHelp)}),r(27,"i",13),o(28,"help"),a()()(),r(29,"div",14)(30,"select",19),c(31,zi,2,2,"option",16),a()()(),c(32,Ui,20,0,"div",17),r(33,"div",10)(34,"label",18),o(35,"Analysis Presets "),r(36,"a",12),u("click",function(){return f(h),y(s.presetsHelp=!s.presetsHelp)}),r(37,"i",13),o(38,"help"),a()()(),r(39,"div",14)(40,"select",20),c(41,Gi,2,2,"option",16),a()()(),c(42,Qi,25,0,"div",17),r(43,"div",21)(44,"label",4),o(45,"Expected periods"),a(),r(46,"label",22),o(47,"from:"),a(),r(48,"div",6),d(49,"input",23),a(),r(50,"label",24),o(51,"to:"),a(),r(52,"div",6),d(53,"input",25),a()(),r(54,"div",10),d(55,"label",6),r(56,"div",26)(57,"mat-paginator",27,0),u("page",function(g){return f(h),y(s.loadDataPage(g))}),a()()(),r(59,"button",28),u("click",function(){return f(h),y(s.analyse())}),o(60,"Test Rhythmicity "),a()()}t&2&&(p("formGroup",s.mainForm),l(21),p("ngForOf",s.detrendingOptions),l(),p("ngIf",s.dataHelp),l(9),p("ngForOf",s.methodOptions),l(),p("ngIf",s.methodHelp),l(9),p("ngForOf",s.presetOptions),l(),p("ngIf",s.presetsHelp),l(),p("hidden",!0),l(14),p("length",s.totalTraces)("disabled",s.disabledPagination)("pageSize",s.currentPage.pageSize)("pageIndex",s.currentPage.pageIndex)("pageSizeOptions",O(14,Ki)),l(2),p("disabled",s.disabled||s.mainForm.invalid))},dependencies:[N,D,ie,$e,He,je,ke,Be,Oe,te,qe,Ke,Ae,Je,Ne,Ve,ne],encapsulation:2});let i=n;return i})();function Yi(i,n){if(i&1&&d(0,"bd2-ts-plots",3),i&2){let m=b(3);p("data",m.timeseries)("tracesPerPlot",m.tracesPerPlot)}}function Xi(i,n){if(i&1){let m=R();r(0,"div")(1,"bd2-rhythmicityjob-params-rform",1),u("displayParams",function(t){f(m);let s=b(2);return y(s.emitDisplayParams(t))})("rhythmicityRequests",function(t){f(m);let s=b(2);return y(s.doAnalysis(t))}),a(),d(2,"hr"),c(3,Yi,1,2,"bd2-ts-plots",2),a()}if(i&2){let m=b(2);l(),p("disabled",m.blocked)("totalTraces",m.totalTraces)("currentPage",m.currentPage),l(2),p("ngIf",m.timeseries)}}function Zi(i,n){if(i&1&&(r(0,"div")(1,"h3"),o(2,"Start rhythmicity test"),a(),d(3,"hr"),c(4,Xi,4,4,"div",0),a()),i&2){let m=b();l(4),p("ngIf",!m.disabled)}}var Nt=(()=>{let n=class n extends me{constructor(e,t,s,h,_){super(h,_),this.fetcher=e,this.analytics=t,this.userService=s,this.disabled=!1,this.blocked=!1,this.tracesPerPlot=5,this.totalTraces=0,this.currentPage=ht.firstPage(),this.titlePart=" New Test"}ngOnInit(){super.ngOnInit(),this.timeSeriesSubsripction=this.fetcher.seriesPackStream.pipe(ge(1e3)).subscribe(e=>{let t=e.data;this.tracesPerPlot=Math.max(5,t.length/20),this.timeseries=t,this.totalTraces=e.totalTraces,this.currentPage=e.currentPage},e=>{console.log("Error in TS subscription: "+e),this.feedback.error(e)})}ngOnDestroy(){this.timeSeriesSubsripction&&this.timeSeriesSubsripction.unsubscribe(),this.fetcher.ngOnDestroy(),super.ngOnDestroy()}emitDisplayParams(e){this.fetcher.changeDisplayParams(e)}doAnalysis(e){e.isValid()&&(this.blocked=!0,this.rhythmicityService.newTest(this.assay,e).subscribe(t=>{this.feedback.success("Rhythmicity test submitted"),this.analytics.rhythmicityNew(e.method.name,this.assay.id,this.userService.currentUser.login),this.refreshModel(),this.goToRhythmicityHome()},t=>{this.blocked=!1,this.feedback.error(t)}))}updateModel(e){this.fetcher.experiment(e),super.updateModel(e)}};n.\u0275fac=function(t){return new(t||n)(v(se),v(De),v(Me),v(E),v(B))},n.\u0275cmp=w({type:n,selectors:[["ng-component"]],features:[V([se]),j],decls:1,vars:1,consts:[[4,"ngIf"],[3,"displayParams","rhythmicityRequests","disabled","totalTraces","currentPage"],[3,"data","tracesPerPlot",4,"ngIf"],[3,"data","tracesPerPlot"]],template:function(t,s){t&1&&c(0,Zi,5,1,"div",0),t&2&&p("ngIf",s.assay)},dependencies:[D,gt,Vt],encapsulation:2});let i=n;return i})();var en=[{path:"",children:[{path:"new",component:Nt},{path:"",component:Jt,pathMatch:"full"}]}],Bt=(()=>{let n=class n{};n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=Q({type:n}),n.\u0275inj=G({imports:[fe.forChild(en),fe]});let i=n;return i})();var Dr=(()=>{let n=class n{};n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=Q({type:n}),n.\u0275inj=G({imports:[Pe,ze,Ue,Mt,Et,wt,Bt]});let i=n;return i})();export{Dr as RhythmicityModule};
