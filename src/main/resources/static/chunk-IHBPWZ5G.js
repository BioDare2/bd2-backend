import{a as g}from"./chunk-CF7GQVNH.js";import{M as m,O as a,R as c,U as u,j as l,oc as f,pc as d,qc as p,s as o}from"./chunk-G55OIOE6.js";var r=class n{constructor(s,h,e){this.login=s,this.firstName=h,this.lastName=e}get name(){return this.firstName?this.lastName?this.firstName+" "+this.lastName:this.firstName:this.lastName?this.lastName:this.login}static deserialize(s){if(!s)throw new Error("Cannot deserialize null user");let h=new n(void 0,void 0,void 0);return h.setAll(s),h}setAll(s){this.login=s.login,this.firstName=s.firstName,this.lastName=s.lastName,this.email=s.email,this.institution=s.institution,this.anonymous=s.anonymous}string2Bool(s){return s===!0||s==="true"||s==="TRUE"}};var N=(()=>{let s=class s{constructor(e,t,i,S){this.BD2REST=e,this.analytics=t,this.feedback=i,this.systemEvents=S,this.user=this.makeAnonymous(),this.userStream=new l(this.user),console.log("User service created"),this.refresh(),this.unAuthSubsription=this.systemEvents.unauthorised$.subscribe(E=>this.refresh())}ngOnDestroy(){this.unAuthSubsription&&this.unAuthSubsription.unsubscribe(),this.userStream.complete()}get currentUser(){return this.user}get currentUser$(){return this.userStream}isLoggedIn(){return!(!this.user||this.user.anonymous)}login(e,t){return this.BD2REST.login(e,t).pipe(o(i=>{if(i=r.deserialize(i),i.anonymous)throw new Error("Login got anonymous user: "+i.login);return i}),a(i=>{this.setUser(i),this.feedback.success(i.name+", you are logged in"),this.analytics.userLoggedIn(i.login)},i=>this.handleError(i))).toPromise()}logout(){return this.BD2REST.logout().pipe(m(e=>this.BD2REST.refreshUser()),a(e=>{e=r.deserialize(e),this.setUser(e),this.feedback.success("You are logged out")}),o(e=>!0)).toPromise()}activate(e){return this.BD2REST.userActivate(e).then(t=>(t=r.deserialize(t),this.analytics.userActivation(t.login),t))}requestReset(e,t){return this.BD2REST.userRequestReset(e,t).then(i=>i.email)}resetPassword(e,t){return this.BD2REST.userResetPassword(e,t).then(i=>i.login)}availableLogin(e){return this.BD2REST.userAvailableLogin(e)}suitableEmail(e){return this.BD2REST.userSuitableEmail(e)}register(e){return this.BD2REST.userRegister(e).then(t=>(t=r.deserialize(t),this.analytics.userRegistration(t.login),t))}update(e){return this.BD2REST.userUpdate(e).pipe(o(t=>r.deserialize(t)),a(t=>{t.login===this.currentUser.login&&this.setUser(t)}))}passwordUpdate(e){return this.BD2REST.passwordUpdate(e).pipe(o(t=>r.deserialize(t)),a(t=>{t.login===this.currentUser.login&&this.setUser(t)}))}refresh(){return this.BD2REST.refreshUser().subscribe(e=>{e=r.deserialize(e),this.setUser(e)},e=>this.handleError(e))}handleError(e){this.feedback.error(e)}setUser(e){this.user=e,this.userStream.next(e)}makeAnonymous(){let e=new r("anonymous");return e.anonymous=!0,e}};s.\u0275fac=function(t){return new(t||s)(u(d),u(g),u(p),u(f))},s.\u0275prov=c({token:s,factory:s.\u0275fac,providedIn:"root"});let n=s;return n})();export{N as a};
