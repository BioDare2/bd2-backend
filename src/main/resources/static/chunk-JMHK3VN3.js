import{a as L,b as _t,c as U,d as _e,e as Ct,f as gt,g as K,h as vt,i as D}from"./chunk-O3RBZ5Z3.js";import{a as It,b as Mt,c as jt}from"./chunk-SYZWE7N4.js";import{e as Ot}from"./chunk-ZYX2OLJ7.js";import{a as Oe}from"./chunk-KRWLBPOO.js";import{a as ut}from"./chunk-4NA7ADHE.js";import"./chunk-TVKO56GQ.js";import{a as bt}from"./chunk-AG6TB2CD.js";import{a as z,h as Ye,i as yt,j as me,k as St,n as Dt}from"./chunk-OXAFMXG5.js";import"./chunk-VUPIMN6E.js";import{a as ae}from"./chunk-5JH2XPWW.js";import{b as A,c as ft}from"./chunk-KXJ32HWL.js";import"./chunk-GKSKHALW.js";import{a as xt,b as Tt,g as Rt,h as wt,i as Et,o as Pt}from"./chunk-MFGL2POH.js";import"./chunk-DMOCFO74.js";import"./chunk-NTQTMRBJ.js";import"./chunk-URYWC6PJ.js";import{d as Ze,e as oe,g as et,l as rt,m as ot,n as at,p as st,q as lt,s as mt,t as ct,v as dt,w as pt,y as ht}from"./chunk-ZG4MTZZ2.js";import{E as it,f as We}from"./chunk-NGCCVO7F.js";import{a as je,b as Xe,q as nt,s as se,u as le}from"./chunk-FKMOXKLG.js";import{a as ie}from"./chunk-KPPNJCJB.js";import{a as tt}from"./chunk-LVE7ORJF.js";import{D as Ue,E as Ge,F as Qe,c as ke,e as q,h as Je,i as ne,j as Fe,m as re,n as Ve,q as Be,r as $e,s as Ne,t as He,u as Ae,v as Ke,w as qe,x as ze,y as Le}from"./chunk-3FBU7QO2.js";import{$a as w,Aa as v,Cb as H,Db as V,Ea as P,F as ve,Fa as Y,Ga as Te,Ha as j,Hb as T,Ib as B,Ja as x,Jb as I,Ka as O,Ra as y,Sa as b,T as Se,Ta as k,Ua as J,Va as F,W as Q,Wa as p,X as W,Xa as r,Ya as o,Z as $,Za as d,_a as R,aa as u,ba as f,bb as E,cc as te,db as h,dc as Pe,eb as _,ec as De,fc as Ie,ib as X,jb as Z,k as Ce,kb as ee,la as xe,ob as Re,pb as we,qb as Ee,sb as a,tb as S,ub as N,uc as Me,va as m,vb as ye,wc as be,z as ge}from"./chunk-7XF6BO2U.js";var ce=(()=>{let n=class n extends ft{constructor(e,t){super(t),this.rhythmicityService=e,this.titlePart=" Rhythm"}goToRhythmicityHome(e){let t=this.expHomePath(e);t.push("rhythmicity"),this.router.navigate(t)}};n.\u0275fac=function(t){return new(t||n)(v(D),v(A))},n.\u0275dir=Te({type:n,features:[j]});let i=n;return i})();var de=(()=>{let n=class n extends Mt{get currentJob(){return this.currentAsset}constructor(e,t=!1){super(t),this.rhythmicityService=e,this.finishedJob$=this.finished$,this.runningJob$=this.running$,this.allJob$=this.all$}initIntervalsKeeper(){return new It(1e3,30*1e3,10*60*1e3,2)}assayJob(e){this.input(e)}sameInput(e,t){return e[1]===t[1]&&e[0]===t[0]}fetchAsset([e,t]){return this.rhythmicityService.getJob(e,t)}hasFailed(e){return K.hasFailed(e)}isFinished(e){return K.isFinished(e)}isRunning(e){return K.isRunning(e)}assetToId(e){return e.jobId}assetToInput(e){return[e.parentId,e.jobId]}};n.\u0275fac=function(t){return new(t||n)($(D),$(ae,8))},n.\u0275prov=Q({token:n,factory:n.\u0275fac});let i=n;return i})();var pe=(()=>{let n=class n extends jt{constructor(e,t=!1){super(t),this.rhythmicityService=e,this.results$=this.data$}isClassicJob(){return this.currentInput?.parameters?.METHOD==="BD2JTK"}sameInput(e,t){return K.sameJob(e,t)}assetToData(e,t){return e.results}fetchAsset(e){return this.rhythmicityService.getResults(e.parentId,e.jobId).pipe(Se(t=>this.labelPatterns(t)))}sortingKey(e){switch(e.active){case"label":return t=>t.label;case"id":return t=>+t.id;case"empp":return t=>+t.result.empP;case"emppbh":return t=>+t.result.empPBH;case"p":return t=>+t.result.p;case"pbh":return t=>+t.result.pBH;case"tau":return t=>+t.result.tau;case"period":return t=>t.result.pattern.period;case"peak":return t=>t.result.pattern.peak;case"trough":return t=>t.result.pattern.trough;default:return console.error("Not implemented sorting for "+e.active),t=>0}}processData(e,t){return t&&this.rankResults(e,t.pValue,t.bhCorrection,this.isClassicJob()),e}labelPatterns(e){e.results.forEach(t=>{t.result.patternLabel=this.describePattern(t.result),t.result.pattern.shapeLabel=this.patternToShape(t.result.pattern)})}describePattern(e){let t=e.pattern,s=Math.round(t.period*10)/10,c=Math.round(t.peak*100)/100,C=Math.round(t.trough*100)/100;return`${this.patternToShape(t)}	${s}	${c}	${C}`}patternToShape(e){switch(e.waveform){case"ASYM_COSINE":return e.leftPortion===.5?"COS":"ACOS";case"ASYM_COS_SPIKE":return"SPIKE";case"ASYM_COS_SPIKE_NEG":return"NPIKE";default:return e.waveform}}rankResults(e,t,s,c){e.forEach(C=>{let g=C.result,fe;c?fe=s?g.pBH:g.p:fe=s?g.empPBH:g.empP,g.rhythmic=fe<t})}};n.\u0275fac=function(t){return new(t||n)($(D),$(ae,8))},n.\u0275prov=Q({token:n,factory:n.\u0275fac});let i=n;return i})();var Jt=()=>[10,25,50,100,250];function Ut(i,n){i&1&&d(0,"mat-progress-bar",3)}function Gt(i,n){i&1&&(r(0,"th",28),a(1,"Id"),o())}function Qt(i,n){if(i&1&&(r(0,"td",29),a(1),o()),i&2){let l=n.$implicit;m(),S(l.id)}}function Wt(i,n){i&1&&(r(0,"th",28),a(1,"Label"),o())}function Yt(i,n){if(i&1&&(r(0,"td",30),a(1),o()),i&2){let l=n.$implicit;m(),S(l.label)}}function Xt(i,n){i&1&&(r(0,"th",31),a(1,"Rhythmic"),o())}function Zt(i,n){if(i&1&&(r(0,"td",29),a(1),o()),i&2){let l=n.$implicit;Ee("bold",l.result.rhythmic),m(),S(l.result.rhythmic)}}function ei(i,n){i&1&&(r(0,"th",28),a(1,"emp-p"),o())}function ti(i,n){if(i&1&&(r(0,"td",29),a(1),T(2,"number"),o()),i&2){let l=n.$implicit;m(),S(I(2,1,l.result.empP,"1.0-5"))}}function ii(i,n){i&1&&(r(0,"th",28),a(1,"BH emp-p"),o())}function ni(i,n){if(i&1&&(r(0,"td",29),a(1),T(2,"number"),o()),i&2){let l=n.$implicit;m(),S(I(2,1,l.result.empPBH,"1.0-5"))}}function ri(i,n){i&1&&(r(0,"th",28),a(1,"Tau"),o())}function oi(i,n){if(i&1&&(r(0,"td",29),a(1),T(2,"number"),o()),i&2){let l=n.$implicit;m(),S(I(2,1,l.result.tau,"1.0-2"))}}function ai(i,n){i&1&&(r(0,"th",28),a(1,"p"),o())}function si(i,n){if(i&1&&(r(0,"td",29),a(1),T(2,"number"),o()),i&2){let l=n.$implicit;m(),S(I(2,1,l.result.p,"1.0-5"))}}function li(i,n){i&1&&(r(0,"th",28),a(1,"BH p"),o())}function mi(i,n){if(i&1&&(r(0,"td",29),a(1),T(2,"number"),o()),i&2){let l=n.$implicit;m(),S(I(2,1,l.result.pBH,"1.0-5"))}}function ci(i,n){i&1&&(r(0,"th",31),a(1,"Pattern"),o())}function di(i,n){if(i&1&&(r(0,"td",29),a(1),o()),i&2){let l=n.$implicit;m(),S(l.result.patternLabel)}}function pi(i,n){i&1&&(r(0,"th",31),a(1,"P.Shape"),o())}function hi(i,n){if(i&1&&(r(0,"td",29),a(1),o()),i&2){let l=n.$implicit;m(),S(l.result.pattern.shapeLabel)}}function ui(i,n){i&1&&(r(0,"th",28),a(1,"P.Period"),o())}function fi(i,n){if(i&1&&(r(0,"td",29),a(1),T(2,"number"),o()),i&2){let l=n.$implicit;m(),S(I(2,1,l.result.pattern.period,"1.0-1"))}}function yi(i,n){i&1&&(r(0,"th",28),a(1,"P.Peak"),o())}function bi(i,n){if(i&1&&(r(0,"td",29),a(1),T(2,"number"),o()),i&2){let l=n.$implicit;m(),S(I(2,1,l.result.pattern.peak,"1.1-1"))}}function _i(i,n){i&1&&(r(0,"th",31),a(1,"P.Peak"),o())}function Ci(i,n){if(i&1&&(r(0,"td",29),a(1),T(2,"number"),o()),i&2){let l=n.$implicit;m(),S(I(2,1,l.result.pattern.peak*24/l.result.pattern.period,"1.1-1"))}}function gi(i,n){i&1&&(r(0,"th",28),a(1,"P.Trough"),o())}function vi(i,n){if(i&1&&(r(0,"td",29),a(1),T(2,"number"),o()),i&2){let l=n.$implicit;m(),S(I(2,1,l.result.pattern.trough,"1.1-1"))}}function Si(i,n){i&1&&(r(0,"th",31),a(1,"P.Trough"),o())}function xi(i,n){if(i&1&&(r(0,"td",29),a(1),T(2,"number"),o()),i&2){let l=n.$implicit;m(),S(I(2,1,l.result.pattern.trough*24/l.result.pattern.period,"1.1-1"))}}function Ti(i,n){i&1&&d(0,"tr",32)}function Ri(i,n){i&1&&d(0,"tr",33)}var he=(()=>{let n=class n{set job(e){e&&this.fetcher.input(e)}set statTestParams(e){if(e){this.fetcher.params(e);let t=e.bhCorrection?this.bhEmpPColumns:this.normEmpPColumns;this.fetcher.isClassicJob()&&(t=e.bhCorrection?this.bhClsPColumns:this.normClsPColumns),e.showPattern&&(t=e.circadian?t.concat(this.patternColumnsC):t.concat(this.patternColumns)),this.displayedColumns=t}}constructor(e,t){this.fetcher=e,this.feedback=t,this.normEmpPColumns=["id","label","rhythmic","empp","tau"],this.normClsPColumns=["id","label","rhythmic","p","tau"],this.bhEmpPColumns=["id","label","rhythmic","emppbh","tau"],this.bhClsPColumns=["id","label","rhythmic","pbh","tau"],this.patternColumns=["shape","period","peak","trough"],this.patternColumnsC=["shape","period","peakc","troughc"],this.displayedColumns=this.normEmpPColumns,this.disablePaginator=!1}ngOnInit(){this.fetcher.error$.subscribe(t=>this.feedback.error(t));let e=new Ze;e.pageSize=25,e.pageIndex=0,this.fetcher.page(e),this.fetcher.on(!0)}ngOnDestroy(){this.fetcher.close()}ngAfterViewInit(){}reload(){this.fetcher.refresh()}sortData(e){this.fetcher.sort(e)}loadPage(e){this.fetcher.page(e)}};n.\u0275fac=function(t){return new(t||n)(v(pe),v(ie))},n.\u0275cmp=P({type:n,selectors:[["bd2-rhythmicity-results-mdtable"]],inputs:{job:"job",statTestParams:"statTestParams"},standalone:!1,features:[H([pe])],decls:55,vars:18,consts:[["paginator",""],["paginator2",""],[1,"mat-elevation-z8"],["mode","indeterminate"],[3,"page","length","disabled","pageSize","pageIndex","pageSizeOptions"],["mat-table","","matSort","","aria-label","Results","matSort","","matSortActive","id","matSortDirection","asc",1,"full-width-table",3,"matSortChange","dataSource"],["matColumnDef","id"],["mat-header-cell","","mat-sort-header","",4,"matHeaderCellDef"],["mat-cell","",4,"matCellDef"],["matColumnDef","label"],["mat-cell","","class","word_wrapping","style","max-width: 100px",4,"matCellDef"],["matColumnDef","rhythmic"],["mat-header-cell","",4,"matHeaderCellDef"],["mat-cell","",3,"bold",4,"matCellDef"],["matColumnDef","empp"],["matColumnDef","emppbh"],["matColumnDef","tau"],["matColumnDef","p"],["matColumnDef","pbh"],["matColumnDef","pattern"],["matColumnDef","shape"],["matColumnDef","period"],["matColumnDef","peak"],["matColumnDef","peakc"],["matColumnDef","trough"],["matColumnDef","troughc"],["mat-header-row","",4,"matHeaderRowDef"],["mat-row","",4,"matRowDef","matRowDefColumns"],["mat-header-cell","","mat-sort-header",""],["mat-cell",""],["mat-cell","",1,"word_wrapping",2,"max-width","100px"],["mat-header-cell",""],["mat-header-row",""],["mat-row",""]],template:function(t,s){if(t&1){let c=E();r(0,"div",2),y(1,Ut,1,0,"mat-progress-bar",3),T(2,"async"),r(3,"mat-paginator",4,0),h("page",function(g){return u(c),f(s.loadPage(g))}),o(),r(5,"table",5),h("matSortChange",function(g){return u(c),f(s.sortData(g))}),R(6,6),x(7,Gt,2,0,"th",7)(8,Qt,2,1,"td",8),w(),R(9,9),x(10,Wt,2,0,"th",7)(11,Yt,2,1,"td",10),w(),R(12,11),x(13,Xt,2,0,"th",12)(14,Zt,2,3,"td",13),w(),R(15,14),x(16,ei,2,0,"th",7)(17,ti,3,4,"td",8),w(),R(18,15),x(19,ii,2,0,"th",7)(20,ni,3,4,"td",8),w(),R(21,16),x(22,ri,2,0,"th",7)(23,oi,3,4,"td",8),w(),R(24,17),x(25,ai,2,0,"th",7)(26,si,3,4,"td",8),w(),R(27,18),x(28,li,2,0,"th",7)(29,mi,3,4,"td",8),w(),R(30,19),x(31,ci,2,0,"th",12)(32,di,2,1,"td",8),w(),R(33,20),x(34,pi,2,0,"th",12)(35,hi,2,1,"td",8),w(),R(36,21),x(37,ui,2,0,"th",7)(38,fi,3,4,"td",8),w(),R(39,22),x(40,yi,2,0,"th",7)(41,bi,3,4,"td",8),w(),R(42,23),x(43,_i,2,0,"th",12)(44,Ci,3,4,"td",8),w(),R(45,24),x(46,gi,2,0,"th",7)(47,vi,3,4,"td",8),w(),R(48,25),x(49,Si,2,0,"th",12)(50,xi,3,4,"td",8),w(),x(51,Ti,1,0,"tr",26)(52,Ri,1,0,"tr",27),o(),r(53,"mat-paginator",4,1),h("page",function(g){return u(c),f(s.loadPage(g))}),o()()}t&2&&(m(),b(B(2,14,s.fetcher.isBusy$)?1:-1),m(2),p("length",s.fetcher.dataLength)("disabled",s.disablePaginator)("pageSize",(s.fetcher.currentPage==null?null:s.fetcher.currentPage.pageSize)||25)("pageIndex",s.fetcher.currentPage==null?null:s.fetcher.currentPage.pageIndex)("pageSizeOptions",V(16,Jt)),m(2),p("dataSource",s.fetcher.results$),m(46),p("matHeaderRowDef",s.displayedColumns),m(),p("matRowDefColumns",s.displayedColumns),m(),p("length",s.fetcher.dataLength)("disabled",s.disablePaginator)("pageSize",(s.fetcher.currentPage==null?null:s.fetcher.currentPage.pageSize)||25)("pageIndex",s.fetcher.currentPage==null?null:s.fetcher.currentPage.pageIndex)("pageSizeOptions",V(17,Jt)))},dependencies:[oe,wt,Et,rt,at,ct,st,ot,dt,lt,mt,pt,ht,et,te,De],styles:[".full-width-table[_ngcontent-%COMP%]{width:100%}"]});let i=n;return i})();function Pi(i,n){if(i&1&&(r(0,"mat-radio-button",4),a(1),o()),i&2){let l=n.$implicit;p("value",l),m(),S(l)}}var Ft=(()=>{let n=class n{constructor(){this.values=[1e-4,.001,.005,.01,.05,.1],this.pvalue=.001,this.pvalue$=new O}ngOnInit(){}ngAfterViewInit(){this.pvalue$.emit(this.pvalue)}selected(e){this.pvalue$.emit(e.value)}};n.\u0275fac=function(t){return new(t||n)},n.\u0275cmp=P({type:n,selectors:[["bd2-pvalue-form"]],outputs:{pvalue$:"pvalue$"},standalone:!1,decls:9,vars:1,consts:[[1,"form-inline"],[1,"mx-auto","text-center"],["id","pvalues-label",1,"mb-1"],["aria-label","Select p-value","aria-labelledby","pvalues-label",3,"change","value"],[3,"value"]],template:function(t,s){t&1&&(r(0,"form",0)(1,"div",1)(2,"mat-label",2)(3,"strong"),a(4,"p-value threshold:"),o()(),r(5,"div")(6,"mat-radio-group",3),h("change",function(C){return s.selected(C)}),J(7,Pi,2,2,"mat-radio-button",4,k),o()()()()),t&2&&(m(6),p("value",s.pvalue),m(),F(s.values))},dependencies:[re,ne,Fe,Xe,xt,Tt],styles:[".mat-mdc-radio-button[_ngcontent-%COMP%]{margin-right:15px}"]});let i=n;return i})();var Vt=(()=>{let n=class n{constructor(){this.options=new O,this.currentOptions=new vt(0,!1,!1,!1)}ngOnInit(){}pValue(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.pValue=e,this.options.next(this.currentOptions)}bhCorrection(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.bhCorrection=e,this.options.next(this.currentOptions)}circadian(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.circadian=e,this.options.next(this.currentOptions)}showPattern(e){this.currentOptions=this.currentOptions.clone(),this.currentOptions.showPattern=e,this.options.next(this.currentOptions)}};n.\u0275fac=function(t){return new(t||n)},n.\u0275cmp=P({type:n,selectors:[["bd2-stat-test-options-widget"]],outputs:{options:"options"},standalone:!1,decls:14,vars:1,consts:[["pattern",""],["appearance","outlined"],[3,"pvalue$"],[2,"margin-top","0.5em","text-align","center"],[3,"change"],[3,"change","disabled"]],template:function(t,s){if(t&1){let c=E();r(0,"mat-card",1)(1,"mat-card-content")(2,"section")(3,"bd2-pvalue-form",2),h("pvalue$",function(g){return u(c),f(s.pValue(g))}),o()(),r(4,"section",3)(5,"mat-slide-toggle",4),h("change",function(g){return u(c),f(s.bhCorrection(g.checked))}),a(6,"Benjamini Hochberg correction"),o()(),r(7,"section",3)(8,"mat-slide-toggle",4,0),h("change",function(g){return u(c),f(s.showPattern(g.checked))}),a(10,"show pattern"),o(),a(11," \xA0 "),r(12,"mat-slide-toggle",5),h("change",function(g){return u(c),f(s.circadian(g.checked))}),a(13,"circadian unit"),o()()()()}if(t&2){let c=Re(9);m(12),p("disabled",!c.checked)}},dependencies:[tt,se,le,Ft],encapsulation:2});let i=n;return i})();function ji(i,n){if(i&1){let l=E();r(0,"div",4)(1,"button",11),h("click",function(){u(l);let t=_(2);return f(t.delete())}),r(2,"i",3),a(3,"delete_forever"),o()(),r(4,"button",12),h("click",function(){u(l);let t=_(2);return f(t.export())}),r(5,"i",3),a(6,"save_alt"),o()()()}}function Oi(i,n){if(i&1&&(r(0,"div",10),d(1,"br"),a(2),o()),i&2){let l=_();m(2),N("ERROR: ",l.jobStatus.message," ")}}function ki(i,n){i&1&&(r(0,"div")(1,"mat-card",8)(2,"mat-card-content"),d(3,"mat-spinner",13),o()()())}function Ji(i,n){i&1&&(r(0,"div")(1,"mat-card",8)(2,"mat-card-content")(3,"div",14),a(4,"It may take up to 10 minutes to test for rhythmicity"),o()()()())}function Fi(i,n){if(i&1){let l=E();r(0,"bd2-stat-test-options-widget",15),h("options",function(t){u(l);let s=_(3);return f(s.statTestOptions(t))}),o(),d(1,"bd2-rhythmicity-results-mdtable",16)}if(i&2){let l=_(3);m(),p("statTestParams",l.statTestParams)("job",n)}}function Vi(i,n){if(i&1&&(r(0,"div"),d(1,"mat-divider"),y(2,ki,4,0,"div"),T(3,"async"),y(4,Ji,5,0,"div"),y(5,Fi,2,2),T(6,"async"),o()),i&2){let l,e=_(),t=_();m(2),b(B(3,3,t.rhythmicityJobDatasource.isReloading$)?2:-1),m(2),b(e.jobStatus.state==="SUBMITTED"?4:-1),m(),b((l=B(6,5,t.rhythmicityJobDatasource.finishedJob$))?5:-1,l)}}function Bi(i,n){if(i&1){let l=E();r(0,"div",0)(1,"div",1)(2,"div",2),h("click",function(){u(l);let t=_();return f(t.toggleExpanded())}),r(3,"i",3),a(4,"waves"),o(),a(5),T(6,"date"),d(7,"br"),a(8),o(),r(9,"div",4),a(10),r(11,"a",5),h("click",function(){u(l);let t=_();return f(t.refresh())}),r(12,"i",6),a(13,"refresh"),o()()()(),r(14,"div",7)(15,"mat-card",8)(16,"mat-card-content")(17,"div",9),y(18,ji,7,0,"div",4),a(19),y(20,Oi,3,1,"div",10),o()()(),y(21,Vi,7,7,"div"),o()()}if(i&2){let l=n,e=_();m(3),we("color",e.isExpanded?"green":"red")("font-size",150,"%"),m(2),ye(" \xA0",e.shortUUID(l.jobId)," (",B(6,13,e.toLocalDateTime(l.jobStatus.submitted)),") "),m(3),ye(" ",e.friendlyMethod(l.parameters.METHOD),"; \xA0 waveforms: ",l.parameters.PRESET," "),m(2),N(" ",l.jobStatus.state," "),m(8),b(e.assay.security.canWrite?18:-1),m(),N(" ",l.parameters.PARAMS_SUMMARY," "),m(),b(l.jobStatus.message&&l.jobStatus.message!="OK"?20:-1),m(),b(e.isExpanded?21:-1)}}var ue=(()=>{let n=class n{set expanded(e){this.isExpanded=e,this.expandedToogleStream.next(e)}constructor(e,t,s,c){this.rhythmicityService=e,this.rhythmicityJobDatasource=t,this.feedback=s,this.dialogs=c,this.deleted=new O,this.isExpanded=!1,this.expandedToogleStream=new Ce(!1)}ngOnInit(){this.initSubscriptions()}ngOnDestroy(){this.rhythmicityJobDatasource.close(),this.expandedToogleStream&&this.expandedToogleStream.complete()}ngOnChanges(e){(e.jobId||e.assay)&&this.jobId&&this.assay&&this.rhythmicityJobDatasource.assayJob([this.assay.id,this.jobId])}statTestOptions(e){let t=ge(1).subscribe(()=>{this.statTestParams=e,t&&t.unsubscribe()})}export(){this.rhythmicityService.downloadJob(this.assay.id,this.jobId).subscribe(e=>{this.saveJobBlob(e,this.assay.id,this.jobId)},e=>this.feedback.error(e))}saveJobBlob(e,t,s){let c={fileName:t+"_job"+this.shortUUID(s)+".rhythmicity.csv",extensions:[".csv"]};bt(e,c).then(C=>{}).catch(C=>console.log("could not save export",C))}refresh(){this.rhythmicityJobDatasource.refresh(),this.resultsTable&&this.resultsTable.reload()}delete(){let e=this.assay,t=this.rhythmicityJobDatasource.currentJob;this.dialogs.confirm("Do you want to delete analysis: "+t.jobId,t.parameters.PARAMS_SUMMARY).subscribe(s=>{s&&this.doDelete(e,t.jobId)})}initSubscriptions(){this.rhythmicityJobDatasource.on(!0),this.rhythmicityJobDatasource.error$.forEach(e=>this.feedback.error(e))}doDelete(e,t){this.rhythmicityService.deleteJob(e,t).subscribe(s=>{this.deleted.next(s),this.feedback.success("Job: "+this.shortUUID(t)+" deleted")},s=>{this.feedback.error(s)})}toggleExpanded(){this.expanded=!this.isExpanded}toLocalDateTime(e){return We.deserialize(e).date}shortUUID(e){return it(e)}friendlyMethod(e){return e==="BD2JTK"?"Classic JTK":e==="BD2EJTK"?"BD2 eJTK":e}};n.\u0275fac=function(t){return new(t||n)(v(D),v(de),v(ie),v(ut))},n.\u0275cmp=P({type:n,selectors:[["bd2-rhythmicity-job-pane"]],viewQuery:function(t,s){if(t&1&&X(he,5),t&2){let c;Z(c=ee())&&(s.resultsTable=c.first)}},inputs:{jobId:"jobId",assay:"assay",expanded:"expanded"},outputs:{deleted:"deleted"},standalone:!1,features:[H([de]),xe],decls:2,vars:3,consts:[[1,"card","mb-2"],[1,"card-header","clearfix"],["role","button",1,"float-left",3,"click"],[1,"material-icons","bd-icon"],[1,"float-right"],["role","button","aria-label","refresh",3,"click"],[1,"material-icons","bd-icon","bd-primary"],[1,"card-body"],["appearance","outlined"],[1,"clearfix"],[1,"text-danger",2,"word-wrap","break-word"],["type","button",1,"btn","btn-danger","btn-sm","mr-1",3,"click"],["type","button",1,"btn","btn-primary","btn-sm",3,"click"],[1,"center-block"],[2,"margin-top","0.5em","text-align","center"],[3,"options"],[3,"statTestParams","job"]],template:function(t,s){if(t&1&&(y(0,Bi,22,15,"div",0),T(1,"async")),t&2){let c;b((c=B(1,1,s.rhythmicityJobDatasource.allJob$))?0:-1,c)}},dependencies:[Rt,se,le,nt,he,Vt,te,Pe],encapsulation:2});let i=n;return i})();var Ni=()=>["new"];function Hi(i,n){if(i&1&&(r(0,"div")(1,"strong"),a(2),o()()),i&2){let l=_(2);m(2),N("Submitted jobs: ",l.jobs.length)}}function Ai(i,n){i&1&&(r(0,"div"),a(1," No jobs submitted, start a new test. "),o())}function Ki(i,n){i&1&&(r(0,"a",3),a(1," New test "),o()),i&2&&p("routerLink",V(1,Ni))}function qi(i,n){if(i&1){let l=E();r(0,"div")(1,"bd2-rhythmicity-job-pane",5),h("deleted",function(t){u(l);let s=_(2);return f(s.remove(t))}),o()()}if(i&2){let l=n.$implicit,e=n.$index,t=_(2);m(),p("assay",t.assay)("jobId",l)("expanded",t.expandAll||e==0)}}function zi(i,n){if(i&1){let l=E();r(0,"div")(1,"h3"),a(2,"Rhythmicity tests"),o(),d(3,"hr"),r(4,"div",0)(5,"div",1),y(6,Hi,3,1,"div"),y(7,Ai,2,0,"div"),o(),r(8,"div",2),y(9,Ki,2,2,"a",3),r(10,"button",4),h("click",function(){u(l);let t=_();return f(t.refresh())}),a(11,"Refresh "),o()()(),d(12,"hr"),J(13,qi,2,3,"div",null,k),d(15,"hr"),o()}if(i&2){let l=_();m(6),b(l.jobs&&l.jobs.length>0?6:-1),m(),b(!l.jobs||l.jobs.length==0?7:-1),m(2),b(l.assay.security.canWrite?9:-1),m(),p("disabled",l.blocked),m(3),F(l.jobsIds)}}var Bt=(()=>{let n=class n extends ce{constructor(e,t){super(e,t),this.expandAll=!1,this.blocked=!1,this.titlePart=" Rhythm"}updateModel(e){super.updateModel(e),e&&this.loadJobs(e)}loadJobs(e,t=!1){this.blocked=!0,this.rhythmicityService.getJobs(e).subscribe(s=>{this.jobs=s,this.refreshJobsInfo(s),this.exportURL=this.rhythmicityService.exportURL(e),t&&this.refreshPanes(),this.blocked=!1},s=>{this.blocked=!1,this.feedback.error(s)})}refreshJobsInfo(e){this.jobsIds=e.map(t=>t.jobId)}refresh(){this.loadJobs(this.assay,!0)}refreshPanes(){this.panes&&this.panes.forEach(e=>e.refresh())}remove(e){let t=this.jobs.findIndex(s=>e.jobId===s.jobId);t>=0&&(this.jobs.splice(t,1),this.refreshJobsInfo(this.jobs))}refreshJob(e){let t=this.jobs.findIndex(s=>e.jobId===s.jobId);t>=0&&(this.jobs[t]=e,this.refreshJobsInfo(this.jobs))}calculateQueuing(e){return e.filter(t=>this.isQueueing(t.jobStatus.state)).length}isQueueing(e){switch(e){case"WAITING":return!0;case"PROCESSING":return!0;case"SUBMITTED":return!0;default:return!1}}checkFinished(e){return!!e.find(t=>this.isFinished(t.jobStatus.state))}isFinished(e){switch(e){case"SUCCESS":return!0;case"FINISHED":return!0;case"COMPLETED":return!0;default:return!1}}};n.\u0275fac=function(t){return new(t||n)(v(D),v(A))},n.\u0275cmp=P({type:n,selectors:[["ng-component"]],viewQuery:function(t,s){if(t&1&&X(ue,5),t&2){let c;Z(c=ee())&&(s.panes=c)}},standalone:!1,features:[j],decls:1,vars:1,consts:[[1,"card"],[1,"card-header"],[1,"card-body"],[1,"btn","btn-primary","mr-1",3,"routerLink"],["type","button",1,"btn","btn-outline-secondary",3,"click","disabled"],[3,"deleted","assay","jobId","expanded"]],template:function(t,s){t&1&&y(0,zi,16,4,"div"),t&2&&b(s.assay?0:-1)},dependencies:[Me,ue],encapsulation:2});let i=n;return i})();var Li=()=>[10,25,50,100,200];function Ui(i,n){if(i&1&&(r(0,"option",16),a(1),o()),i&2){let l=n.$implicit;p("value",l.name),m(),S(l.label)}}function Gi(i,n){i&1&&(r(0,"div",17)(1,"div",29),a(2," Rhythmicity tests are generally used for short, sparse timeseries. "),d(3,"br"),a(4," The current limit is 5 or 4 days of hourly sampled data for eJTK preset and BD2 preset respectivelly."),d(5,"br"),a(6," Generally the raw data are being analysed, but we also enabled a linear detrended option. "),o()())}function Qi(i,n){if(i&1&&(r(0,"option",16),a(1),o()),i&2){let l=n.$implicit;p("value",l.name),m(),S(l.label)}}function Wi(i,n){i&1&&(r(0,"div",17)(1,"div",29)(2,"p")(3,"b"),a(4,"Classic JTK"),o(),a(5," is the implementation of JTK_CYCLE from "),r(6,"a",30),a(7,"Michael E. Hughes et al. 2010"),o(),a(8," a standard method for detecting rhythmicity in genome-scale datasets. "),d(9,"br"),a(10,"The method is fast but it is reliable only when it tests against small set of patterns, we provide patterns of 24h cosines with different phases."),o(),r(11,"p")(12,"b"),a(13,"BD2 eJTK"),o(),a(14," is the BioDare2 implementation of Empirical JTK_CYCLE with asymmetry search from "),r(15,"a",31),a(16,"Alan L. Hutchison et al. 2015"),o(),a(17,". It is similar to the classic JTK method but with p values empirically calculated against set of random noise data. "),d(18,"br"),a(19,"This modification permits using larger sets of test patterns and it provides better accuracy. However, this method is much slower so it can only analyze timeseries only up to 5 days of data (though the Classic JTK method was never intended to be used with such a long data)."),o()()())}function Yi(i,n){if(i&1&&(r(0,"option",16),a(1),o()),i&2){let l=n.$implicit;p("value",l.name),m(),S(l.label)}}function Xi(i,n){i&1&&(r(0,"div",17)(1,"div",29),a(2," Presets determine set of pattern curves against the comparison test is run."),d(3,"br"),r(4,"ul")(5,"li"),a(6,"Cosine 24h 1/2/4h are set of cosine curves of 24h periods, and phases spread every 1, 2, or 4 hours. To be used mainly with Classic JTK."),o(),r(7,"li"),a(8,"eJTK Classic is recommended for typical omics-like data for which eJTK method was developed. "),d(9,"br"),a(10," It works well for short data (48h, 2h- 1h-sampled) when actual period is within range 22-26 hours."),d(11,"br"),a(12," The patterns are series of cosine-like waveforms with 24h period, phases by 2hours and range of asymmetries by 2h (see original paper)."),d(13,"br"),o(),r(14,"li"),a(15,"BD2 Classic can detect non 24 periods and some forms of the spikes."),d(16,"br"),a(17," As it compares against much more patterns it has a weaker power."),d(18,"br"),a(19," It should be used when there is a good reason to suspect periods outside 22-26h range."),d(20,"br"),a(21," The patterns are series of cosine-like waverforms with periods from 18-35hours, for each period there are multiple "),r(22,"b"),a(23,"circadian"),o(),a(24," phases with step 2h (so each period value generates the same number of patterns but the peaks in absolute units do not coincide) and a range of assymetries by 2h in circadian units (see original paper). The preset contains also additional some spike patterns. "),o()()()())}var $t=(()=>{let n=class n extends St{constructor(e){super(e),this.methodOptions=_t,this.presetOptions=_e,this.dataHelp=!1,this.presetsHelp=!1,this.methodHelp=!1,this.rhythmicityRequests=new O,this.detrendingOptions=[z.NO_DTR,z.LIN_DTR],this.methodForm=this.mainForm.get("method"),this.presetForm=this.mainForm.get("preset")}buildMainForm(){return this.fb.group({displayParams:this.displayParamsForm,periodScale:this.fb.group({periodMin:[18,[q.required]],periodMax:[34,[q.required]]},{validator:t=>this.validPeriodScale(t.value)}),method:[L.BD2EJTK.name,[q.required]],preset:[U.EJTK_CLASSIC.name,[q.required]]})}ngOnInit(){super.ngOnInit(),this.methodForm.valueChanges.subscribe(e=>this.setPresetOptions(e))}ngOnDestroy(){super.ngOnDestroy()}setPresetOptions(e){e===L.BD2EJTK.name?(this.presetOptions=_e,this.presetForm.setValue(U.EJTK_CLASSIC.name)):e===L.BD2JTK.name?(this.presetOptions=Ct,this.presetForm.setValue(U.COS_2H.name)):this.presetOptions=[]}defaultDetrending(){return z.NO_DTR.name}validPeriodScale(e){let t=e.periodMin,s=e.periodMax;return t<10?{validPeriodScale:"Period min must >= 10"}:s<10?{validPeriodScale:"Period max must >= 10"}:s>50?{validPeriodScale:"Period max must < 50"}:t>=s?{validPeriodScale:"Period min must be < max"}:null}analyse(){if(this.mainForm.invalid)return;let e=this.map2RhythmicityRequest(this.mainForm.value);e.isValid()&&this.rhythmicityRequests.next(e)}map2RhythmicityRequest(e){let t=new gt;return t.detrending=z.get(e.displayParams.detrending),t.method=L.get(e.method),t.preset=U.get(e.preset),t.periodMax=e.periodScale.periodMax,t.periodMin=e.periodScale.periodMin,t.windowEnd=e.displayParams.timeScale.timeEnd,t.windowStart=e.displayParams.timeScale.timeStart,t}};n.\u0275fac=function(t){return new(t||n)(v(Ue))},n.\u0275cmp=P({type:n,selectors:[["bd2-rhythmicityjob-params-rform"]],inputs:{disabled:"disabled",totalTraces:"totalTraces",currentPage:"currentPage"},outputs:{displayParams:"displayParams",rhythmicityRequests:"rhythmicityRequests"},standalone:!1,features:[j],decls:64,vars:12,consts:[["dataPaginator",""],["role","form",1,"form-horizontal",3,"formGroup"],["formGroupName","displayParams"],["formGroupName","timeScale",1,"form-group","row"],[1,"col-sm-4"],["for","windowStart",1,"col-sm-1"],[1,"col-sm-2"],["formControlName","timeStart","id","windowStart","min","0","required","","size","5","step","any","type","number",1,"form-control"],["for","windowEnd",1,"col-sm-1"],["formControlName","timeEnd","id","windowEnd","min","0","placeholder","","required","","size","5","step","any","type","number",1,"form-control"],[1,"form-group","row"],["for","detrending",1,"col-sm-4"],[3,"click"],[1,"material-icons","bd-icon","bd-primary"],[1,"col-sm-6"],["formControlName","detrending","id","detrending","required","",1,"form-control"],[3,"value"],[1,"col-sm-12"],["for","method",1,"col-sm-4"],["formControlName","method","id","method","required","",1,"form-control"],["formControlName","preset","id","preset","required","",1,"form-control"],["formGroupName","periodScale",1,"form-group","row",3,"hidden"],["for","periodMin",1,"col-sm-1"],["formControlName","periodMin","id","periodMin","max","50","min","10","placeholder","","required","","size","5","step","any","type","number",1,"form-control"],["for","periodMax",1,"col-sm-1"],["formControlName","periodMax","id","periodMax","max","50","min","10","placeholder","","required","","size","5","step","any","type","number",1,"form-control"],[1,"col-sm-8"],[3,"page","length","disabled","pageSize","pageIndex","pageSizeOptions"],["type","button",1,"btn","btn-primary",3,"click","disabled"],["role","alert","type","info",1,"alert","alert-info"],["href","https://dx.doi.org/10.1177%2F0748730410379711"],["href"," https://doi.org/10.1371/journal.pcbi.1004094"]],template:function(t,s){if(t&1){let c=E();r(0,"form",1)(1,"div",2)(2,"div",3)(3,"label",4),a(4,"Data window"),o(),r(5,"label",5),a(6,"from:"),o(),r(7,"div",6),d(8,"input",7),o(),r(9,"label",8),a(10,"to:"),o(),r(11,"div",6),d(12,"input",9),o()(),r(13,"div",10)(14,"label",11),a(15,"Input Data "),r(16,"a",12),h("click",function(){return u(c),f(s.dataHelp=!s.dataHelp)}),r(17,"i",13),a(18,"help"),o()()(),r(19,"div",14)(20,"select",15),J(21,Ui,2,2,"option",16,k),o()()()(),y(23,Gi,7,0,"div",17),r(24,"div",10)(25,"label",18),a(26,"Test Method "),r(27,"a",12),h("click",function(){return u(c),f(s.methodHelp=!s.methodHelp)}),r(28,"i",13),a(29,"help"),o()()(),r(30,"div",14)(31,"select",19),J(32,Qi,2,2,"option",16,k),o()()(),y(34,Wi,20,0,"div",17),r(35,"div",10)(36,"label",18),a(37,"Analysis Presets "),r(38,"a",12),h("click",function(){return u(c),f(s.presetsHelp=!s.presetsHelp)}),r(39,"i",13),a(40,"help"),o()()(),r(41,"div",14)(42,"select",20),J(43,Yi,2,2,"option",16,k),o()()(),y(45,Xi,25,0,"div",17),r(46,"div",21)(47,"label",4),a(48,"Expected periods"),o(),r(49,"label",22),a(50,"from:"),o(),r(51,"div",6),d(52,"input",23),o(),r(53,"label",24),a(54,"to:"),o(),r(55,"div",6),d(56,"input",25),o()(),r(57,"div",10),d(58,"label",6),r(59,"div",26)(60,"mat-paginator",27,0),h("page",function(g){return u(c),f(s.loadDataPage(g))}),o()()(),r(62,"button",28),h("click",function(){return u(c),f(s.analyse())}),a(63,"Test Rhythmicity "),o()()}t&2&&(p("formGroup",s.mainForm),m(21),F(s.detrendingOptions),m(2),b(s.dataHelp?23:-1),m(9),F(s.methodOptions),m(2),b(s.methodHelp?34:-1),m(9),F(s.presetOptions),m(2),b(s.presetsHelp?45:-1),m(),p("hidden",!0),m(14),p("length",s.totalTraces)("disabled",s.disabledPagination)("pageSize",s.currentPage.pageSize)("pageIndex",s.currentPage.pageIndex)("pageSizeOptions",V(11,Li)),m(2),p("disabled",s.disabled||s.mainForm.invalid))},dependencies:[re,Ae,Ke,ke,Ve,He,Je,ne,Le,ze,qe,Be,Ne,$e,oe],encapsulation:2});let i=n;return i})();function en(i,n){if(i&1&&d(0,"bd2-ts-plots",1),i&2){let l=_(3);p("data",l.timeseries)("tracesPerPlot",l.tracesPerPlot)}}function tn(i,n){if(i&1){let l=E();r(0,"div")(1,"bd2-rhythmicityjob-params-rform",0),h("displayParams",function(t){u(l);let s=_(2);return f(s.emitDisplayParams(t))})("rhythmicityRequests",function(t){u(l);let s=_(2);return f(s.doAnalysis(t))}),o(),d(2,"hr"),y(3,en,1,2,"bd2-ts-plots",1),o()}if(i&2){let l=_(2);m(),p("disabled",l.blocked)("totalTraces",l.totalTraces)("currentPage",l.currentPage),m(2),b(l.timeseries?3:-1)}}function nn(i,n){if(i&1&&(r(0,"div")(1,"h3"),a(2,"Start rhythmicity test"),o(),d(3,"hr"),y(4,tn,4,4,"div"),o()),i&2){let l=_();m(4),b(l.disabled?-1:4)}}var Nt=(()=>{let n=class n extends ce{constructor(e,t,s,c,C){super(c,C),this.fetcher=e,this.analytics=t,this.userService=s,this.disabled=!1,this.blocked=!1,this.tracesPerPlot=5,this.totalTraces=0,this.currentPage=yt.firstPage(),this.titlePart=" New Test"}ngOnInit(){super.ngOnInit(),this.timeSeriesSubsripction=this.fetcher.seriesPackStream.pipe(ve(1e3)).subscribe(e=>{let t=e.data;this.tracesPerPlot=Math.max(5,t.length/20),this.timeseries=t,this.totalTraces=e.totalTraces,this.currentPage=e.currentPage},e=>{console.log("Error in TS subscription: "+e),this.feedback.error(e)})}ngOnDestroy(){this.timeSeriesSubsripction&&this.timeSeriesSubsripction.unsubscribe(),this.fetcher.ngOnDestroy(),super.ngOnDestroy()}emitDisplayParams(e){this.fetcher.changeDisplayParams(e)}doAnalysis(e){e.isValid()&&(this.blocked=!0,this.rhythmicityService.newTest(this.assay,e).subscribe(t=>{this.feedback.success("Rhythmicity test submitted"),this.analytics.rhythmicityNew(e.method.name,this.assay.id,this.userService.currentUser.login),this.refreshModel(),this.goToRhythmicityHome()},t=>{this.blocked=!1,this.feedback.error(t)}))}updateModel(e){this.fetcher.experiment(e),super.updateModel(e)}};n.\u0275fac=function(t){return new(t||n)(v(me),v(je),v(Oe),v(D),v(A))},n.\u0275cmp=P({type:n,selectors:[["ng-component"]],standalone:!1,features:[H([me]),j],decls:1,vars:1,consts:[[3,"displayParams","rhythmicityRequests","disabled","totalTraces","currentPage"],[3,"data","tracesPerPlot"]],template:function(t,s){t&1&&y(0,nn,5,1,"div"),t&2&&b(s.assay?0:-1)},dependencies:[Ye,$t],encapsulation:2});let i=n;return i})();var rn=[{path:"",children:[{path:"new",component:Nt},{path:"",component:Bt,pathMatch:"full"}]}],Ht=(()=>{let n=class n{};n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=Y({type:n}),n.\u0275inj=W({imports:[be.forChild(rn),be]});let i=n;return i})();var Or=(()=>{let n=class n{};n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=Y({type:n}),n.\u0275inj=W({imports:[Ie,Ge,Qe,Ot,Dt,Pt,Ht]});let i=n;return i})();export{Or as RhythmicityModule};
