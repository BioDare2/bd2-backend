import{d as v}from"./chunk-ZG4MTZZ2.js";import{B as w,C as E}from"./chunk-NGCCVO7F.js";import{A as b,B as o,E as S,F as f,G as g,J as D,Q as A,T as l,j as d,k as h,p as m,u as c,v as p,z as x}from"./chunk-7XF6BO2U.js";var O=class{constructor(s=1e3,r=30*1e3,t=5*60*1e3,e=2){this.RELOAD_INT=s,this.MAX_RELOAD_INT=r,this.MAX_RELOAD_TIME=t,this.RELOAD_FACTOR=e,e<1&&(this.RELOAD_FACTOR=2)}nextInterval(s){if(this.id!==s?this.reset(s):this.interval<this.MAX_RELOAD_INT&&(this.interval*=this.RELOAD_FACTOR),this.deadline>Date.now())return this.interval}reset(s){this.id=s,this.interval=this.RELOAD_INT,this.deadline=Date.now()+this.MAX_RELOAD_TIME}};var B=(()=>{let s=class s{constructor(t=!1){this.removeDebounce=t,this.error$=new d,this.on$=new h(!1),this.refresh$=new d,this.input$=new h(void 0),this.asset$=new h(void 0),this.reloading$=new h(!1),this.DEBUG=!1,this.reloadDebounce=50,this.id=s.ids++,this.logMe("created"),this.currentReloadStatus=this.initIntervalsKeeper(),this.finished$=this.asset$.asObservable().pipe(o(e=>e&&this.isFinished(e))),this.running$=this.asset$.asObservable().pipe(o(e=>e&&this.isRunning(e))),this.failed$=this.asset$.asObservable().pipe(o(e=>e&&this.hasFailed(e))),this.all$=this.asset$.asObservable().pipe(o(e=>e!=null&&e!==void 0)),this.isReloading$=this.initReloadingStream(),this.initAssetsStream(),this.initReloads()}logMe(t,e){this.DEBUG&&(t=this.constructor.name+":"+this.id+" "+t,e?console.log(t,e):console.log(t))}close(){this.asset$.complete(),this.input$.complete(),this.error$.complete(),this.reloading$.complete(),this.on$.complete(),this.refresh$.complete(),this.reloadSubscription&&this.reloadSubscription.unsubscribe()}input(t){t&&this.input$.next(t)}on(t=!0){this.on$.next(t)}refresh(){this.currentReloadStatus.reset(void 0),this.reloadSubscription&&this.reloadSubscription.unsubscribe(),this.refresh$.next(!0)}initReloadingStream(){return this.removeDebounce?this.reloading$.asObservable():this.reloading$.asObservable().pipe(f(this.reloadDebounce))}initAssetsStream(){this.initAssetsInput().subscribe(t=>this.loadAsset(t),t=>this.error$.next(t))}initReloads(){this.running$.subscribe(t=>this.reload(t))}loadAsset(t){this.fetchAsset(t).subscribe(e=>{this.setAsset(e,t)},e=>{this.error$.next(e)})}setAsset(t,e){this.currentInput=e,this.currentAsset=t,this.reloading$.next(this.isRunning(t)),this.asset$.next(t)}initAssetsInput(){let e=p([this.input$,this.on$]).pipe(o(([n,a])=>n&&a),c(([n,a])=>n)).pipe(D((n,a)=>this.sameInput(n,a))),i=this.refresh$.pipe(A(n=>e.pipe(g(1))));return b(e,i).pipe(l(n=>this.logMe("Assets input",n)))}reload(t){this.reloadSubscription&&this.reloadSubscription.unsubscribe();let e=this.currentReloadStatus.nextInterval(this.assetToId(t));if(!e){this.reloading$.next(!1);return}let i=this.assetToInput(t);this.reloadSubscription=x(e).subscribe($=>{this.sameInput(i,this.currentInput)?(this.reloadSubscription=void 0,this.loadAsset(i)):console.log("Disabled reload as input has changed")})}};s.ids=0;let u=s;return u})();var R=(()=>{let s=class s{constructor(t=!1){this.removeDebounce=t,this.error$=new d,this.isFetching$=new h(!1),this.isProcessing$=new h(!1),this.dataLength=0,this.page$=new h(void 0),this.sort$=new h(void 0),this.on$=new h(!1),this.refresh$=new d,this.input$=new h(void 0),this.params$=new h(void 0),this.asset$=new h(void 0),this.DEBUG=!1,this.dataInputsDebounce=200,this.busyDebounce=50,this.id=s.ids++,this.logMe("created"),this.initAssetsStream(),this.isBusy$=this.initBusyStream(),this.data$=this.initDataStream()}logMe(t,e){this.DEBUG&&(t=this.constructor.name+":"+this.id+" "+t,e?console.log(t,e):console.log(t))}input(t){t&&this.input$.next(t)}params(t){this.params$.next(t)}on(t=!0){this.on$.next(t)}refresh(){this.refresh$.next(!0)}page(t){this.page$.next(t)}sort(t){this.sort$.next(t),this.resetPage()}close(){this.asset$.complete(),this.error$.complete(),this.isFetching$.complete(),this.isProcessing$.complete(),this.input$.complete(),this.params$.complete(),this.on$.complete(),this.refresh$.complete(),this.page$.complete(),this.sort$.complete()}errorToData(t){return m(void 0)}resetPage(){this.page$.pipe(g(1)).subscribe(t=>{if(t){let e=new v;e.pageIndex=0,e.pageSize=t.pageSize,this.page(e)}})}initBusyStream(){return this.removeDebounce?p([this.isFetching$,this.isProcessing$]).pipe(c(([t,e])=>t||e)):p([this.isFetching$,this.isProcessing$]).pipe(f(this.busyDebounce),c(([t,e])=>t||e))}initDataStream(){let t=this.dataMutators(),e;return this.removeDebounce?e=p(t):e=p(t).pipe(f(this.dataInputsDebounce)),e.pipe(l(i=>this.logMe("Input for data stream",i)),l(i=>this.isProcessing$.next(!0)),c(([i,$,n,a])=>{this.dataLength=this.assetToDataLength(i,a);let I=this.processSortedPagedData(i,$,n,a);return this.currentSort=$,this.currentPage=n,this.currentParams=a,this.currentData=I,I}),S(i=>(this.error$.next(i),this.errorToData(i))),l(i=>this.isProcessing$.next(!1)))}dataMutators(){return[this.asset$.pipe(o(t=>!!t)),this.sort$,this.page$.pipe(o(t=>!!t)),this.params$]}initAssetsStream(){this.initAssetsInput().subscribe(t=>this.loadAsset(t),t=>this.error$.next(t))}loadAsset(t){this.isFetching$.next(!0),this.fetchAsset(t).subscribe(e=>{this.isFetching$.next(!1),this.setAsset(e,t)},e=>{this.isFetching$.next(!1),this.error$.next(e)})}setAsset(t,e){this.currentInput=e,this.currentAsset=t,this.asset$.next(t)}initAssetsInput(){let e=p([this.input$,this.on$]).pipe(o(([n,a])=>n&&a),c(([n,a])=>n)).pipe(D((n,a)=>this.sameInput(n,a))),i=this.refresh$.pipe(A(n=>e.pipe(g(1))));return b(e,i).pipe(l(n=>this.logMe("Assets input",n)))}};s.ids=0;let u=s;return u})();var T=class extends R{constructor(s=!1){super(s),this.removeDebounce=s}sortingKey(s,r){return t=>t}processData(s,r){return s}errorToData(s){return m([])}processSortedPagedData(s,r,t,e){let i=this.assetToData(s,e);return i=this.sortData(i,r,e),i=this.pageData(i,t,e),i=this.processData(i,e),i}sortData(s,r,t){return!r||!r.active||r.direction===""?s:w(s,r.direction,this.sortingKey(r,t))}pageData(s,r,t){return r?E(s,r):s}assetToDataLength(s,r){return this.assetToData(s).length}};export{O as a,B as b,T as c};
