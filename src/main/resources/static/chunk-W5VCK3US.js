import{d as x}from"./chunk-3YYYRSCH.js";import{f as v,g as w}from"./chunk-VRYT53ET.js";import{A as b,B as o,E as I,F as $,G as f,J as m,R as D,U as l,j as d,k as r,p as g,t as p,u as c,z as S}from"./chunk-L7CH4MQ7.js";var R=class{constructor(i=1e3,t=30*1e3,e=5*60*1e3,s=2){this.RELOAD_INT=i,this.MAX_RELOAD_INT=t,this.MAX_RELOAD_TIME=e,this.RELOAD_FACTOR=s,s<1&&(this.RELOAD_FACTOR=2)}nextInterval(i){if(this.id!==i?this.reset(i):this.interval<this.MAX_RELOAD_INT&&(this.interval*=this.RELOAD_FACTOR),this.deadline>Date.now())return this.interval}reset(i){this.id=i,this.interval=this.RELOAD_INT,this.deadline=Date.now()+this.MAX_RELOAD_TIME}};var P=(()=>{class u{constructor(t=!1){this.removeDebounce=t,this.error$=new d,this.on$=new r(!1),this.refresh$=new d,this.input$=new r(void 0),this.asset$=new r(void 0),this.reloading$=new r(!1),this.DEBUG=!1,this.reloadDebounce=50,this.id=u.ids++,this.logMe("created"),this.currentReloadStatus=this.initIntervalsKeeper(),this.finished$=this.asset$.asObservable().pipe(o(e=>e&&this.isFinished(e))),this.running$=this.asset$.asObservable().pipe(o(e=>e&&this.isRunning(e))),this.failed$=this.asset$.asObservable().pipe(o(e=>e&&this.hasFailed(e))),this.all$=this.asset$.asObservable().pipe(o(e=>e!=null&&e!==void 0)),this.isReloading$=this.initReloadingStream(),this.initAssetsStream(),this.initReloads()}static{this.ids=0}logMe(t,e){this.DEBUG&&(t=this.constructor.name+":"+this.id+" "+t,e?console.log(t,e):console.log(t))}close(){this.asset$.complete(),this.input$.complete(),this.error$.complete(),this.reloading$.complete(),this.on$.complete(),this.refresh$.complete(),this.reloadSubscription&&this.reloadSubscription.unsubscribe()}input(t){t&&this.input$.next(t)}on(t=!0){this.on$.next(t)}refresh(){this.currentReloadStatus.reset(void 0),this.reloadSubscription&&this.reloadSubscription.unsubscribe(),this.refresh$.next(!0)}initReloadingStream(){return this.removeDebounce?this.reloading$.asObservable():this.reloading$.asObservable().pipe($(this.reloadDebounce))}initAssetsStream(){this.initAssetsInput().subscribe(t=>this.loadAsset(t),t=>this.error$.next(t))}initReloads(){this.running$.subscribe(t=>this.reload(t))}loadAsset(t){this.fetchAsset(t).subscribe(e=>{this.setAsset(e,t)},e=>{this.error$.next(e)})}setAsset(t,e){this.currentInput=e,this.currentAsset=t,this.reloading$.next(this.isRunning(t)),this.asset$.next(t)}initAssetsInput(){let e=c([this.input$,this.on$]).pipe(o(([n,a])=>n&&a),p(([n,a])=>n)).pipe(m((n,a)=>this.sameInput(n,a))),s=this.refresh$.pipe(D(n=>e.pipe(f(1))));return b(e,s).pipe(l(n=>this.logMe("Assets input",n)))}reload(t){this.reloadSubscription&&this.reloadSubscription.unsubscribe();let e=this.currentReloadStatus.nextInterval(this.assetToId(t));if(!e){this.reloading$.next(!1);return}let s=this.assetToInput(t);this.reloadSubscription=S(e).subscribe(h=>{this.sameInput(s,this.currentInput)?(this.reloadSubscription=void 0,this.loadAsset(s)):console.log("Disabled reload as input has changed")})}}return u})();var E=(()=>{class u{constructor(t=!1){this.removeDebounce=t,this.error$=new d,this.isFetching$=new r(!1),this.isProcessing$=new r(!1),this.dataLength=0,this.page$=new r(void 0),this.sort$=new r(void 0),this.on$=new r(!1),this.refresh$=new d,this.input$=new r(void 0),this.params$=new r(void 0),this.asset$=new r(void 0),this.DEBUG=!1,this.dataInputsDebounce=200,this.busyDebounce=50,this.id=u.ids++,this.logMe("created"),this.initAssetsStream(),this.isBusy$=this.initBusyStream(),this.data$=this.initDataStream()}static{this.ids=0}logMe(t,e){this.DEBUG&&(t=this.constructor.name+":"+this.id+" "+t,e?console.log(t,e):console.log(t))}input(t){t&&this.input$.next(t)}params(t){this.params$.next(t)}on(t=!0){this.on$.next(t)}refresh(){this.refresh$.next(!0)}page(t){this.page$.next(t)}sort(t){this.sort$.next(t),this.resetPage()}close(){this.asset$.complete(),this.error$.complete(),this.isFetching$.complete(),this.isProcessing$.complete(),this.input$.complete(),this.params$.complete(),this.on$.complete(),this.refresh$.complete(),this.page$.complete(),this.sort$.complete()}errorToData(t){return g(void 0)}resetPage(){this.page$.pipe(f(1)).subscribe(t=>{if(t){let e=new x;e.pageIndex=0,e.pageSize=t.pageSize,this.page(e)}})}initBusyStream(){return this.removeDebounce?c([this.isFetching$,this.isProcessing$]).pipe(p(([t,e])=>t||e)):c([this.isFetching$,this.isProcessing$]).pipe($(this.busyDebounce),p(([t,e])=>t||e))}initDataStream(){let t=this.dataMutators(),e;return this.removeDebounce?e=c(t):e=c(t).pipe($(this.dataInputsDebounce)),e.pipe(l(s=>this.logMe("Input for data stream",s)),l(s=>this.isProcessing$.next(!0)),p(([s,h,n,a])=>{this.dataLength=this.assetToDataLength(s,a);let A=this.processSortedPagedData(s,h,n,a);return this.currentSort=h,this.currentPage=n,this.currentParams=a,this.currentData=A,A}),I(s=>(this.error$.next(s),this.errorToData(s))),l(s=>this.isProcessing$.next(!1)))}dataMutators(){return[this.asset$.pipe(o(t=>!!t)),this.sort$,this.page$.pipe(o(t=>!!t)),this.params$]}initAssetsStream(){this.initAssetsInput().subscribe(t=>this.loadAsset(t),t=>this.error$.next(t))}loadAsset(t){this.isFetching$.next(!0),this.fetchAsset(t).subscribe(e=>{this.isFetching$.next(!1),this.setAsset(e,t)},e=>{this.isFetching$.next(!1),this.error$.next(e)})}setAsset(t,e){this.currentInput=e,this.currentAsset=t,this.asset$.next(t)}initAssetsInput(){let e=c([this.input$,this.on$]).pipe(o(([n,a])=>n&&a),p(([n,a])=>n)).pipe(m((n,a)=>this.sameInput(n,a))),s=this.refresh$.pipe(D(n=>e.pipe(f(1))));return b(e,s).pipe(l(n=>this.logMe("Assets input",n)))}}return u})();var O=class extends E{constructor(i=!1){super(i),this.removeDebounce=i}sortingKey(i,t){return e=>e}processData(i,t){return i}errorToData(i){return g([])}processSortedPagedData(i,t,e,s){let h=this.assetToData(i,s);return h=this.sortData(h,t,s),h=this.pageData(h,e,s),h=this.processData(h,s),h}sortData(i,t,e){return!t||!t.active||t.direction===""?i:v(i,t.direction,this.sortingKey(t,e))}pageData(i,t,e){return t?w(i,t):i}assetToDataLength(i,t){return this.assetToData(i).length}};export{R as a,P as b,O as c};
